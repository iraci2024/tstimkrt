/*!
**************************************************************************
 sgcWebSocket component

 written by eSeGeCe
            copyright Â© 2021
            Email : info@esegece.com
            Web : http://www.esegece.com
**************************************************************************
*/

function sgcws_webrtc(){function e(e,s){var n=JSON.stringify(s);arguments[0]='{"jsonrpc":"2.0", "method":"sgc@webrtc", "params":{"channel":"'+e+'", "message":""}, "webrtc":'+n+"}",R.apply(self,arguments)}function s(){S=!1,C=!1,h.close(),h=null,d()}function n(){try{RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection||window.msRTCPeerConnection,h=new RTCPeerConnection(y),h.onicecandidate=a}catch(e){return void alert("Cannot create RTCPeerConnection object; WebRTC is not supported by this browser.")}h.onconnecting=r,h.onopen=g,h.ontrack=b,h.onremovestream=m}function o(){h.createOffer(c,t,j)}function t(e){console.log(e.name+":"+e.message)}function c(s){h.setLocalDescription(s,function(){e(v,s)},function(e){t(e)})}function i(e){var s=JSON.parse(e);if("offer"===s.type)h.setRemoteDescription(new RTCSessionDescription(s),function(){h.createAnswer(c,t,j)},function(e){console.error(e)});else if("answer"===s.type)h.setRemoteDescription(new RTCSessionDescription(s));else if("candidate"===s.type){var n=new RTCIceCandidate({sdpMLineIndex:s.label,candidate:s.candidate});h.addIceCandidate(n)}else"bye"===s.type&&u()}function a(s){s.candidate&&e(v,{type:"candidate",label:s.candidate.sdpMLineIndex,id:s.candidate.sdpMid,candidate:s.candidate.candidate})}function r(e){W.fire({name:"onsgcsessionconnecting",message:e})}function g(e){O.fire({name:"onsgcsessionopen",message:e})}function d(){P.fire({name:"onsgcsessionclose"})}function b(e){_.fire({name:"onsgcaddstream",stream:e.streams[0]}),w=e.streams[0]}function m(){G.fire({name:"onsgcremovestream"})}function u(){l(),s()}function l(){setTimeout(function(){f.src=""},500),localVideo.style.opacity=0,f.style.opacity=0}var f,p,w,h,v,y={iceServers:[{url:"stun:stun.l.google.com:19302"}]},j={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},C=!1,S=!1;if(self=this,0!=arguments.length){1==arguments.length?"object"==typeof arguments[0]?(arguments[0].subprotocol="webrtc.esegece.com",sgcWebSocket.call(this,arguments[0])):"string"==typeof arguments[0]&&(arguments[1]="webrtc.esegece.com",sgcWebSocket.call(this,arguments[0],arguments[1])):2==arguments.length?"object"==typeof arguments[0]?(arguments[0].subprotocol=arguments[1]+".webrtc.esegece.com",sgcWebSocket.call(this,arguments[0])):"string"==typeof arguments[0]&&(arguments[1]=arguments[1]+".webrtc.esegece.com",sgcWebSocket.call(this,arguments[0],arguments[1])):3==arguments.length&&("object"==typeof arguments[0]?(arguments[0].subprotocol=arguments[1]+".webrtc.esegece.com",arguments[0].transport=arguments[2],sgcWebSocket.call(this,arguments[0])):"string"==typeof arguments[0]&&(arguments[1]=arguments[1]+".webrtc.esegece.com",sgcWebSocket.call(this,arguments[0],arguments[1],arguments[2])));var R=this.send;this.send=function(e,s,n,o){1==arguments.length?arguments[0]='{"jsonrpc":"2.0", "method":"sgc@message", "params":{"message":"'+e+'"}, "id":"'+GUID()+'", "webrtc":""}':2==arguments.length?arguments[0]='{"jsonrpc":"2.0", "method":"'+s+'", "params":{"message":"'+e+'"}, "id":"'+GUID()+'", "webrtc":""}':""!==o&&void 0!==o?arguments[0]='{"jsonrpc":"2.0", "method":"'+s+'", "params":{"channel":"'+n+'", "message":"'+e+'"}, "id":"'+o+'", "webrtc":""}':arguments[0]='{"jsonrpc":"2.0", "method":"'+s+'", "params":{"channel":"'+n+'", "message":"'+e+'"}, "webrtc":""}',R.apply(this,arguments)};var T=this.close;this.close=function(){e(v,{type:"bye"}),T.apply(this,arguments)},this.broadcast=function(){1==arguments.length?this.send(arguments[0],"sgc@broadcast",""):2==arguments.length&&this.send(arguments[0],"sgc@broadcast",arguments[1])},this.webrtc_connect=function(e){v=e,this.send("","sgc@subscribe",e)},this.webrtc_disconnect=function(e){v=e,this.send("","sgc@unsubscribe",e),s()},window.onbeforeunload=function(){e(v,{type:"bye"})};var k=new event("open"),M=new event("close"),D=new event("onsgcmediastart"),I=new event("onsgcmediaerror"),U=new event("onsgcmediastop"),W=new event("onsgcsessionconnecting"),O=new event("onsgcsessionopen"),P=new event("onsgcsessionclose"),_=new event("onsgcaddstream"),G=new event("onsgcremovestream"),J=new event("onsgcmessage"),N=new event("onsgcsubscribe"),E=new event("onsgcunsubscribe");this.on("open",function(){k.fire({name:"onopen",message:""}),card=document.getElementById("card"),f=document.getElementById("remoteVideo"),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia({audio:!0,video:!0},function(e){D.fire({name:"onsgcmediastart",message:"",stream:e}),p=e,n(),h.addStream(p)},function(e){I.fire({name:"onsgcmediaerror",code:e.name,message:e.message})})}),this.on("close",function(e){U.fire({name:"onsgcmediastop",message:""}),M.fire({name:"onclose",message:"",code:e.code,reason:e.reason,clean:e.wasClean}),h.close(),h=null}),DoEventMessage=function(e){var s=e.data;if(obj=JSON.parse(s),"sgc@subscribe"==obj.method)"2"==obj.params.message&&o(),N.fire({name:"onsgcsubscribe",channel:obj.params.channel,users:obj.params.message});else if("sgc@unsubscribe"==obj.method)E.fire({name:"onsgcunsubscribe",channel:obj.channel,guid:obj.guid});else if("sgc@webrtc"==obj.method){var n=JSON.stringify(obj.webrtc);n=n.toString(),i(n)}else"sgc@iceservers"==obj.method?y=obj.iceservers:J.fire({name:"onsgcmessage",method:obj.result.method,channel:obj.result.channel,message:obj.result.message,guid:obj.guid})};var L=this.on;this.on=function(e,s){"sgcmessage"==e?J.subscribe(s):"sgcsubscribe"==e?N.subscribe(s):"sgcunsubscribe"==e?E.subscribe(s):"open"==e?k.subscribe(s):"close"==e?M.subscribe(s):"sgcmediastart"==e?D.subscribe(s):"sgcmediastop"==e?U.subscribe(s):"sgcmediaerror"==e?I.subscribe(s):"sgcsessionconnecting"==e?W.subscribe(s):"sgcsessionopen"==e?O.subscribe(s):"sgcsessionclose"==e?P.subscribe(s):"sgcaddstream"==e?_.subscribe(s):"sgcremovestream"==e?G.subscribe(s):L.apply(this,arguments)}}}sgcws_webrtc.prototype=new sgcWebSocket,sgcws_webrtc.prototype.constructor=sgcws_webrtc;