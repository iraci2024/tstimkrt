/*
 *  Copyright (c) 2014 The WebRTC project authors. All Rights Reserved.
 *
 *  Use of this source code is governed by a BSD-style license
 *  that can be found in the LICENSE file in the root of the source
 *  tree.
 */

function mergeConstraints(e,t){if(!e||!t)return e||t;var n=e;for(var i in t)n[i]=t[i];return n}function iceCandidateType(e){return e.split(" ")[7]}function formatTypePreference(e){if("chrome"===adapter.browserDetails.browser)switch(e){case 0:return"TURN/TLS";case 1:return"TURN/TCP";case 2:return"TURN/UDP"}else if("firefox"===adapter.browserDetails.browser)switch(e){case 0:return"TURN/TCP";case 5:return"TURN/UDP"}return""}function maybeSetOpusOptions(e,t){return"true"===t.opusStereo?e=setCodecParam(e,"opus/48000","stereo","1"):"false"===t.opusStereo&&(e=removeCodecParam(e,"opus/48000","stereo")),"true"===t.opusFec?e=setCodecParam(e,"opus/48000","useinbandfec","1"):"false"===t.opusFec&&(e=removeCodecParam(e,"opus/48000","useinbandfec")),"true"===t.opusDtx?e=setCodecParam(e,"opus/48000","usedtx","1"):"false"===t.opusDtx&&(e=removeCodecParam(e,"opus/48000","usedtx")),t.opusMaxPbr&&(e=setCodecParam(e,"opus/48000","maxplaybackrate",t.opusMaxPbr)),e}function maybeSetAudioSendBitRate(e,t){return t.audioSendBitrate?(trace("Prefer audio send bitrate: "+t.audioSendBitrate),preferBitRate(e,t.audioSendBitrate,"audio")):e}function maybeSetAudioReceiveBitRate(e,t){return t.audioRecvBitrate?(trace("Prefer audio receive bitrate: "+t.audioRecvBitrate),preferBitRate(e,t.audioRecvBitrate,"audio")):e}function maybeSetVideoSendBitRate(e,t){return t.videoSendBitrate?(trace("Prefer video send bitrate: "+t.videoSendBitrate),preferBitRate(e,t.videoSendBitrate,"video")):e}function maybeSetVideoReceiveBitRate(e,t){return t.videoRecvBitrate?(trace("Prefer video receive bitrate: "+t.videoRecvBitrate),preferBitRate(e,t.videoRecvBitrate,"video")):e}function preferBitRate(e,t,n){var i=e.split("\r\n"),r=findLine(i,"m=",n);if(null===r)return trace("Failed to add bandwidth line to sdp, as no m-line found"),e;var o=findLineInRange(i,r+1,-1,"m=");null===o&&(o=i.length);var a=findLineInRange(i,r+1,o,"c=");if(null===a)return trace("Failed to add bandwidth line to sdp, as no c-line found"),e;var s=findLineInRange(i,a+1,o,"b=AS");s&&i.splice(s,1);var c="b=AS:"+t;return i.splice(a+1,0,c),e=i.join("\r\n")}function maybeSetVideoSendInitialBitRate(e,t){var n=parseInt(t.videoSendInitialBitrate);if(!n)return e;var i=parseInt(n),r=parseInt(t.videoSendBitrate);r&&(n>r&&(trace("Clamping initial bitrate to max bitrate of "+r+" kbps."),n=r,t.videoSendInitialBitrate=n),i=r);var o=e.split("\r\n"),a=findLine(o,"m=","video");if(null===a)return trace("Failed to find video m-line"),e;var s=o[a],c=new RegExp("m=video\\s\\d+\\s[A-Z/]+\\s"),d=s.split(c)[1].split(" ")[0],l=o[findLine(o,"a=rtpmap",d)],u=l.split("a=rtpmap:"+d)[1].split("/")[0],p=t.videoSendCodec||u;return e=setCodecParam(e,p,"x-google-min-bitrate",t.videoSendInitialBitrate.toString()),e=setCodecParam(e,p,"x-google-max-bitrate",i.toString())}function removePayloadTypeFromMline(e,t){e=e.split(" ");for(var n=0;n<e.length;++n)e[n]===t.toString()&&e.splice(n,1);return e.join(" ")}function removeCodecByName(e,t){var n=findLine(e,"a=rtpmap",t);if(null===n)return e;var i=getCodecPayloadTypeFromLine(e[n]);e.splice(n,1);var r=findLine(e,"m=","video");return null===r?e:(e[r]=removePayloadTypeFromMline(e[r],i),e)}function removeCodecByPayloadType(e,t){var n=findLine(e,"a=rtpmap",t.toString());if(null===n)return e;e.splice(n,1);var i=findLine(e,"m=","video");return null===i?e:(e[i]=removePayloadTypeFromMline(e[i],t),e)}function maybeRemoveVideoFec(e,t){if("false"!==t.videoFec)return e;var n=e.split("\r\n"),i=findLine(n,"a=rtpmap","red");if(null===i)return e;var r=getCodecPayloadTypeFromLine(n[i]);if(n=removeCodecByPayloadType(n,r),n=removeCodecByName(n,"ulpfec"),i=findLine(n,"a=fmtp",r.toString()),null===i)return e;var o=parseFmtpLine(n[i]),a=o.pt;return null===a?e:(n.splice(i,1),n=removeCodecByPayloadType(n,a),n.join("\r\n"))}function maybePreferAudioSendCodec(e,t){return maybePreferCodec(e,"audio","send",t.audioSendCodec)}function maybePreferAudioReceiveCodec(e,t){return maybePreferCodec(e,"audio","receive",t.audioRecvCodec)}function maybePreferVideoSendCodec(e,t){return maybePreferCodec(e,"video","send",t.videoSendCodec)}function maybePreferVideoReceiveCodec(e,t){return maybePreferCodec(e,"video","receive",t.videoRecvCodec)}function maybePreferCodec(e,t,n,i){var r=t+" "+n+" codec";if(!i)return trace("No preference on "+r+"."),e;trace("Prefer "+r+": "+i);var o=e.split("\r\n"),a=findLine(o,"m=",t);if(null===a)return e;for(var s=null,c=o.length-1;c>=0;--c){var d=findLineInRange(o,c,0,"a=rtpmap",i,"desc");if(null===d)break;c=d,s=getCodecPayloadTypeFromLine(o[d]),s&&(o[a]=setDefaultCodec(o[a],s))}return e=o.join("\r\n")}function setCodecParam(e,t,n,i){var r=e.split("\r\n"),o=findFmtpLine(r,t),a={};if(null===o){var s=findLine(r,"a=rtpmap",t);if(null===s)return e;var c=getCodecPayloadTypeFromLine(r[s]);a.pt=c.toString(),a.params={},a.params[n]=i,r.splice(s+1,0,writeFmtpLine(a))}else a=parseFmtpLine(r[o]),a.params[n]=i,r[o]=writeFmtpLine(a);return e=r.join("\r\n")}function removeCodecParam(e,t,n){var i=e.split("\r\n"),r=findFmtpLine(i,t);if(null===r)return e;var o=parseFmtpLine(i[r]);delete o.params[n];var a=writeFmtpLine(o);return null===a?i.splice(r,1):i[r]=a,e=i.join("\r\n")}function parseFmtpLine(e){var t={},n=e.indexOf(" "),i=e.substring(n+1).split(";"),r=new RegExp("a=fmtp:(\\d+)"),o=e.match(r);if(!o||2!==o.length)return null;t.pt=o[1];for(var a={},s=0;s<i.length;++s){var c=i[s].split("=");2===c.length&&(a[c[0]]=c[1])}return t.params=a,t}function writeFmtpLine(e){if(!e.hasOwnProperty("pt")||!e.hasOwnProperty("params"))return null;var t=e.pt,n=e.params,i=[],r=0;for(var o in n)i[r]=o+"="+n[o],++r;return 0===r?null:"a=fmtp:"+t.toString()+" "+i.join(";")}function findFmtpLine(e,t){var n=getCodecPayloadType(e,t);return n?findLine(e,"a=fmtp:"+n.toString()):null}function findLine(e,t,n){return findLineInRange(e,0,-1,t,n)}function findLineInRange(e,t,n,i,r,o){if(void 0===o&&(o="asc"),o=o||"asc","asc"===o){for(var a=-1!==n?n:e.length,s=t;a>s;++s)if(0===e[s].indexOf(i)&&(!r||-1!==e[s].toLowerCase().indexOf(r.toLowerCase())))return s}else for(var c=-1!==t?t:e.length-1,d=c;d>=0;--d)if(0===e[d].indexOf(i)&&(!r||-1!==e[d].toLowerCase().indexOf(r.toLowerCase())))return d;return null}function getCodecPayloadType(e,t){var n=findLine(e,"a=rtpmap",t);return n?getCodecPayloadTypeFromLine(e[n]):null}function getCodecPayloadTypeFromLine(e){var t=new RegExp("a=rtpmap:(\\d+) [a-zA-Z0-9-]+\\/\\d+"),n=e.match(t);return n&&2===n.length?n[1]:null}function setDefaultCodec(e,t){var n=e.split(" "),i=n.slice(0,3);i.push(t);for(var r=3;r<n.length;r++)n[r]!==t&&i.push(n[r]);return i.join(" ")}function extractStatAsInt(e,t,n){var i=extractStat(e,t,n);if(i){var r=parseInt(i);if(-1!==r)return r}return null}function extractStat(e,t,n){var i=getStatsReport(e,t,n);return i&&-1!==i[n]?i[n]:null}function getStatsReport(e,t,n,i){var r=null;return e&&e.forEach(function(e){if(e.type===t){var o=!0;if(n){var a="id"===n?e.id:e[n];o=void 0!==i?a===i:a}o&&(r=e)}}),r}function enumerateStats(e,t,n){var i={audio:{local:{audioLevel:0,bytesSent:0,clockRate:0,codecId:"",mimeType:"",packetsSent:0,payloadType:0,timestamp:0,trackId:"",transportId:""},remote:{audioLevel:0,bytesReceived:0,clockRate:0,codecId:"",fractionLost:0,jitter:0,mimeType:"",packetsLost:0,packetsReceived:0,payloadType:0,timestamp:0,trackId:"",transportId:""}},video:{local:{bytesSent:0,clockRate:0,codecId:"",firCount:0,framesEncoded:0,frameHeight:0,framesSent:0,frameWidth:0,nackCount:0,packetsSent:0,payloadType:0,pliCount:0,qpSum:0,timestamp:0,trackId:"",transportId:""},remote:{bytesReceived:0,clockRate:0,codecId:"",firCount:0,fractionLost:0,frameHeight:0,framesDecoded:0,framesDropped:0,framesReceived:0,frameWidth:0,nackCount:0,packetsLost:0,packetsReceived:0,payloadType:0,pliCount:0,qpSum:0,timestamp:0,trackId:"",transportId:""}},connection:{availableOutgoingBitrate:0,bytesReceived:0,bytesSent:0,consentRequestsSent:0,currentRoundTripTime:0,localCandidateId:"",localCandidateType:"",localIp:"",localPort:0,localPriority:0,localProtocol:"",remoteCandidateId:"",remoteCandidateType:"",remoteIp:"",remotePort:0,remotePriority:0,remoteProtocol:"",requestsReceived:0,requestsSent:0,responsesReceived:0,responsesSent:0,timestamp:0,totalRoundTripTime:0}};return e&&(e.forEach(function(e){switch(e.type){case"outbound-rtp":e.hasOwnProperty("trackId")&&(-1!==e.trackId.indexOf(t.audio)&&(i.audio.local.bytesSent=e.bytesSent,i.audio.local.codecId=e.codecId,i.audio.local.packetsSent=e.packetsSent,i.audio.local.timestamp=e.timestamp,i.audio.local.trackId=e.trackId,i.audio.local.transportId=e.transportId),-1!==e.trackId.indexOf(t.video)&&(i.video.local.bytesSent=e.bytesSent,i.video.local.codecId=e.codecId,i.video.local.firCount=e.firCount,i.video.local.framesEncoded=e.frameEncoded,i.video.local.framesSent=e.framesSent,i.video.local.packetsSent=e.packetsSent,i.video.local.pliCount=e.pliCount,i.video.local.qpSum=e.qpSum,i.video.local.timestamp=e.timestamp,i.video.local.trackId=e.trackId,i.video.local.transportId=e.transportId));break;case"inbound-rtp":e.hasOwnProperty("trackId")&&(-1!==e.trackId.indexOf(n.audio)&&(i.audio.remote.bytesReceived=e.bytesReceived,i.audio.remote.codecId=e.codecId,i.audio.remote.fractionLost=e.fractionLost,i.audio.remote.jitter=e.jitter,i.audio.remote.packetsLost=e.packetsLost,i.audio.remote.packetsReceived=e.packetsReceived,i.audio.remote.timestamp=e.timestamp,i.audio.remote.trackId=e.trackId,i.audio.remote.transportId=e.transportId),-1!==e.trackId.indexOf(n.video)&&(i.video.remote.bytesReceived=e.bytesReceived,i.video.remote.codecId=e.codecId,i.video.remote.firCount=e.firCount,i.video.remote.fractionLost=e.fractionLost,i.video.remote.nackCount=e.nackCount,i.video.remote.packetsLost=e.patsLost,i.video.remote.packetsReceived=e.packetsReceived,i.video.remote.pliCount=e.pliCount,i.video.remote.qpSum=e.qpSum,i.video.remote.timestamp=e.timestamp,i.video.remote.trackId=e.trackId,i.video.remote.transportId=e.transportId));break;case"candidate-pair":e.hasOwnProperty("availableOutgoingBitrate")&&(i.connection.availableOutgoingBitrate=e.availableOutgoingBitrate,i.connection.bytesReceived=e.bytesReceived,i.connection.bytesSent=e.bytesSent,i.connection.consentRequestsSent=e.consentRequestsSent,i.connection.currentRoundTripTime=e.currentRoundTripTime,i.connection.localCandidateId=e.localCandidateId,i.connection.remoteCandidateId=e.remoteCandidateId,i.connection.requestsReceived=e.requestsReceived,i.connection.requestsSent=e.requestsSent,i.connection.responsesReceived=e.responsesReceived,i.connection.responsesSent=e.responsesSent,i.connection.timestamp=e.timestamp,i.connection.totalRoundTripTime=e.totalRoundTripTime);break;default:return}}.bind()),e.forEach(function(e){switch(e.type){case"track":e.hasOwnProperty("trackIdentifier")&&(-1!==e.trackIdentifier.indexOf(t.video)&&(i.video.local.frameHeight=e.frameHeight,i.video.local.framesSent=e.framesSent,i.video.local.frameWidth=e.frameWidth),-1!==e.trackIdentifier.indexOf(n.video)&&(i.video.remote.frameHeight=e.frameHeight,i.video.remote.framesDecoded=e.framesDecoded,i.video.remote.framesDropped=e.framesDropped,i.video.remote.framesReceived=e.framesReceived,i.video.remote.frameWidth=e.frameWidth),-1!==e.trackIdentifier.indexOf(t.audio)&&(i.audio.local.audioLevel=e.audioLevel),-1!==e.trackIdentifier.indexOf(n.audio)&&(i.audio.remote.audioLevel=e.audioLevel));break;case"codec":e.hasOwnProperty("id")&&(-1!==e.id.indexOf(i.audio.local.codecId)&&(i.audio.local.clockRate=e.clockRate,i.audio.local.mimeType=e.mimeType,i.audio.local.payloadType=e.payloadType),-1!==e.id.indexOf(i.audio.remote.codecId)&&(i.audio.remote.clockRate=e.clockRate,i.audio.remote.mimeType=e.mimeType,i.audio.remote.payloadType=e.payloadType),-1!==e.id.indexOf(i.video.local.codecId)&&(i.video.local.clockRate=e.clockRate,i.video.local.mimeType=e.mimeType,i.video.local.payloadType=e.payloadType),-1!==e.id.indexOf(i.video.remote.codecId)&&(i.video.remote.clockRate=e.clockRate,i.video.remote.mimeType=e.mimeType,i.video.remote.payloadType=e.payloadType));break;case"local-candidate":e.hasOwnProperty("id")&&-1!==e.id.indexOf(i.connection.localCandidateId)&&(i.connection.localIp=e.ip,i.connection.localPort=e.port,i.connection.localPriority=e.priority,i.connection.localProtocol=e.protocol,i.connection.localType=e.candidateType);break;case"remote-candidate":e.hasOwnProperty("id")&&-1!==e.id.indexOf(i.connection.remoteCandidateId)&&(i.connection.remoteIp=e.ip,i.connection.remotePort=e.port,i.connection.remotePriority=e.priority,i.connection.remoteProtocol=e.protocol,i.connection.remoteType=e.candidateType);break;default:return}}.bind())),i}function computeRate(e,t,n){var i=e[n],r=t?t[n]:null;return null===i||null===r?null:(i-r)/(e.timestamp-t.timestamp)*1e3}function computeBitrate(e,t,n){return 8*computeRate(e,t,n)}function computeE2EDelay(e,t){if(!e)return null;var n=Date.now()+22089888e5;return n-e-1e3*t}function $(e){return document.querySelector(e)}function queryStringToDictionary(e){var t=e.slice(1).split("&"),n={};return t.forEach(function(e){e&&(e=e.split("="),e[0]&&(n[e[0]]=decodeURIComponent(e[1]||"")))}),n}function sendAsyncUrlRequest(e,t,n){return sendUrlRequest(e,t,!0,n)}function sendUrlRequest(e,t,n,i){return new Promise(function(r,o){var a,s=function(){return 200!==a.status?void o(Error("Status="+a.status+", response="+a.responseText)):void r(a.responseText)};a=new XMLHttpRequest,n&&(a.onreadystatechange=function(){4===a.readyState&&s()}),a.open(e,"/sgc/protocol/apprtc.esegece.com"+t,n),a.send(i),n||s()})}function requestIceServers(e,t){return new Promise(function(n,i){sendAsyncUrlRequest("POST",e).then(function(e){var r=parseJSON(e);return r?(""!==t&&filterIceServersUrls(r,t),trace("Retrieved ICE server information."),void n(r.iceServers)):void i(Error("Error parsing response JSON: "+e))})["catch"](function(e){i(Error("ICE server request error: "+e.message))})})}function parseJSON(e){try{return JSON.parse(e)}catch(t){trace("Error parsing json: "+e)}return null}function filterIceServersUrls(e,t){for(var n="transport="+t,i=[],r=0;r<e.iceServers.length;++r){for(var o=e.iceServers[r],a=[],s=0;s<o.urls.length;++s){var c=o.urls[s];-1!==c.indexOf(n)?a.push(c):-1===c.indexOf("?transport=")&&a.push(c+"?"+n)}0!==a.length&&(o.urls=a,i.push(o))}e.iceServers=i}function setUpFullScreen(){isChromeApp()?document.cancelFullScreen=function(){chrome.app.window.current().restore()}:document.cancelFullScreen=document.webkitCancelFullScreen||document.mozCancelFullScreen||document.cancelFullScreen,isChromeApp()?document.body.requestFullScreen=function(){chrome.app.window.current().fullscreen()}:document.body.requestFullScreen=document.body.webkitRequestFullScreen||document.body.mozRequestFullScreen||document.body.requestFullScreen,document.onfullscreenchange=document.onfullscreenchange||document.onwebkitfullscreenchange||document.onmozfullscreenchange}function isFullScreen(){return isChromeApp()?chrome.app.window.current().isFullscreen():!!(document.webkitIsFullScreen||document.mozFullScreen||document.isFullScreen)}function fullScreenElement(){return document.webkitFullScreenElement||document.webkitCurrentFullScreenElement||document.mozFullScreenElement||document.fullScreenElement}function randomString(e){var t=[];e=e||5;for(var n="0123456789";e--;)t.push(n.charAt(Math.floor(Math.random()*n.length)));return t.join("")}function isChromeApp(){return"undefined"!=typeof chrome&&"undefined"!=typeof chrome.storage&&"undefined"!=typeof chrome.storage.local}function calculateFps(e,t,n,i,r){var o=0;if(e&&void 0!==typeof e.webkitDecodedFrameCount&&e.readyState>=e.HAVE_CURRENT_DATA){var a=(new Date).getTime(),s=(a-n)/1e3,c=a;o=(e.webkitDecodedFrameCount-t)/s,r(e.webkitDecodedFrameCount,c,i)}return parseInt(o)}function trace(e){if("\n"===e[e.length-1]&&(e=e.substring(0,e.length-1)),window.performance){var t=(window.performance.now()/1e3).toFixed(3);console.log(t+": "+e)}else console.log(e)}window.rtstats={},function(){var e=[];window.addEventListener("pccreated",function(t){e.push(t.detail)},!1),window.addEventListener("pcclosed",function(t){var n=-1;for(n=0;n<e.length&&e[n].pc!==t.detail.pc;n++);n>-1?e.splice(n,1):console.log("Unknown peer connection closed?")},!1),window.rtstats.activePCs=function(){return e}}(),!function(e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).pako=e()}(function(){return function e(t,n,i){function r(a,s){if(!n[a]){if(!t[a]){var c="function"==typeof require&&require;if(!s&&c)return c(a,!0);if(o)return o(a,!0);var d=new Error("Cannot find module '"+a+"'");throw d.code="MODULE_NOT_FOUND",d}var l=n[a]={exports:{}};t[a][0].call(l.exports,function(e){var n=t[a][1][e];return r(n||e)},l,l.exports,e,t,n,i)}return n[a].exports}for(var o="function"==typeof require&&require,a=0;a<i.length;a++)r(i[a]);return r}({1:[function(e,t,n){"use strict";function i(e){if(!(this instanceof i))return new i(e);this.options=a.assign({level:p,method:f,chunkSize:16384,windowBits:15,memLevel:8,strategy:h,to:""},e||{});var t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new d,this.strm.avail_out=0;var n=o.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(n!==u)throw new Error(c[n]);if(t.header&&o.deflateSetHeader(this.strm,t.header),t.dictionary){var r;if(r="string"==typeof t.dictionary?s.string2buf(t.dictionary):"[object ArrayBuffer]"===l.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary,(n=o.deflateSetDictionary(this.strm,r))!==u)throw new Error(c[n]);this._dict_set=!0}}function r(e,t){var n=new i(t);if(n.push(e,!0),n.err)throw n.msg||c[n.err];return n.result}var o=e("./zlib/deflate"),a=e("./utils/common"),s=e("./utils/strings"),c=e("./zlib/messages"),d=e("./zlib/zstream"),l=Object.prototype.toString,u=0,p=-1,h=0,f=8;i.prototype.push=function(e,t){var n,i,r=this.strm,c=this.options.chunkSize;if(this.ended)return!1;i=t===~~t?t:!0===t?4:0,"string"==typeof e?r.input=s.string2buf(e):"[object ArrayBuffer]"===l.call(e)?r.input=new Uint8Array(e):r.input=e,r.next_in=0,r.avail_in=r.input.length;do{if(0===r.avail_out&&(r.output=new a.Buf8(c),r.next_out=0,r.avail_out=c),1!==(n=o.deflate(r,i))&&n!==u)return this.onEnd(n),this.ended=!0,!1;0!==r.avail_out&&(0!==r.avail_in||4!==i&&2!==i)||("string"===this.options.to?this.onData(s.buf2binstring(a.shrinkBuf(r.output,r.next_out))):this.onData(a.shrinkBuf(r.output,r.next_out)))}while((r.avail_in>0||0===r.avail_out)&&1!==n);return 4===i?(n=o.deflateEnd(this.strm),this.onEnd(n),this.ended=!0,n===u):2!==i||(this.onEnd(u),r.avail_out=0,!0)},i.prototype.onData=function(e){this.chunks.push(e)},i.prototype.onEnd=function(e){e===u&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=a.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},n.Deflate=i,n.deflate=r,n.deflateRaw=function(e,t){return t=t||{},t.raw=!0,r(e,t)},n.gzip=function(e,t){return t=t||{},t.gzip=!0,r(e,t)}},{"./utils/common":3,"./utils/strings":4,"./zlib/deflate":8,"./zlib/messages":13,"./zlib/zstream":15}],2:[function(e,t,n){"use strict";function i(e){if(!(this instanceof i))return new i(e);this.options=a.assign({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var n=o.inflateInit2(this.strm,t.windowBits);if(n!==c.Z_OK)throw new Error(d[n]);this.header=new u,o.inflateGetHeader(this.strm,this.header)}function r(e,t){var n=new i(t);if(n.push(e,!0),n.err)throw n.msg||d[n.err];return n.result}var o=e("./zlib/inflate"),a=e("./utils/common"),s=e("./utils/strings"),c=e("./zlib/constants"),d=e("./zlib/messages"),l=e("./zlib/zstream"),u=e("./zlib/gzheader"),p=Object.prototype.toString;i.prototype.push=function(e,t){var n,i,r,d,l,u,h=this.strm,f=this.options.chunkSize,m=this.options.dictionary,v=!1;if(this.ended)return!1;i=t===~~t?t:!0===t?c.Z_FINISH:c.Z_NO_FLUSH,"string"==typeof e?h.input=s.binstring2buf(e):"[object ArrayBuffer]"===p.call(e)?h.input=new Uint8Array(e):h.input=e,h.next_in=0,h.avail_in=h.input.length;do{if(0===h.avail_out&&(h.output=new a.Buf8(f),h.next_out=0,h.avail_out=f),(n=o.inflate(h,c.Z_NO_FLUSH))===c.Z_NEED_DICT&&m&&(u="string"==typeof m?s.string2buf(m):"[object ArrayBuffer]"===p.call(m)?new Uint8Array(m):m,n=o.inflateSetDictionary(this.strm,u)),n===c.Z_BUF_ERROR&&!0===v&&(n=c.Z_OK,v=!1),n!==c.Z_STREAM_END&&n!==c.Z_OK)return this.onEnd(n),this.ended=!0,!1;h.next_out&&(0!==h.avail_out&&n!==c.Z_STREAM_END&&(0!==h.avail_in||i!==c.Z_FINISH&&i!==c.Z_SYNC_FLUSH)||("string"===this.options.to?(r=s.utf8border(h.output,h.next_out),d=h.next_out-r,l=s.buf2string(h.output,r),h.next_out=d,h.avail_out=f-d,d&&a.arraySet(h.output,h.output,r,d,0),this.onData(l)):this.onData(a.shrinkBuf(h.output,h.next_out)))),0===h.avail_in&&0===h.avail_out&&(v=!0)}while((h.avail_in>0||0===h.avail_out)&&n!==c.Z_STREAM_END);return n===c.Z_STREAM_END&&(i=c.Z_FINISH),i===c.Z_FINISH?(n=o.inflateEnd(this.strm),this.onEnd(n),this.ended=!0,n===c.Z_OK):i!==c.Z_SYNC_FLUSH||(this.onEnd(c.Z_OK),h.avail_out=0,!0)},i.prototype.onData=function(e){this.chunks.push(e)},i.prototype.onEnd=function(e){e===c.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=a.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},n.Inflate=i,n.inflate=r,n.inflateRaw=function(e,t){return t=t||{},t.raw=!0,r(e,t)},n.ungzip=r},{"./utils/common":3,"./utils/strings":4,"./zlib/constants":6,"./zlib/gzheader":9,"./zlib/inflate":11,"./zlib/messages":13,"./zlib/zstream":15}],3:[function(e,t,n){"use strict";function i(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var r="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;n.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var n=t.shift();if(n){if("object"!=typeof n)throw new TypeError(n+"must be non-object");for(var r in n)i(n,r)&&(e[r]=n[r])}}return e},n.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var o={arraySet:function(e,t,n,i,r){if(t.subarray&&e.subarray)e.set(t.subarray(n,n+i),r);else for(var o=0;i>o;o++)e[r+o]=t[n+o]},flattenChunks:function(e){var t,n,i,r,o,a;for(i=0,t=0,n=e.length;n>t;t++)i+=e[t].length;for(a=new Uint8Array(i),r=0,t=0,n=e.length;n>t;t++)o=e[t],a.set(o,r),r+=o.length;return a}},a={arraySet:function(e,t,n,i,r){for(var o=0;i>o;o++)e[r+o]=t[n+o]},flattenChunks:function(e){return[].concat.apply([],e)}};n.setTyped=function(e){e?(n.Buf8=Uint8Array,n.Buf16=Uint16Array,n.Buf32=Int32Array,n.assign(n,o)):(n.Buf8=Array,n.Buf16=Array,n.Buf32=Array,n.assign(n,a))},n.setTyped(r)},{}],4:[function(e,t,n){"use strict";function i(e,t){if(65537>t&&(e.subarray&&a||!e.subarray&&o))return String.fromCharCode.apply(null,r.shrinkBuf(e,t));for(var n="",i=0;t>i;i++)n+=String.fromCharCode(e[i]);return n}var r=e("./common"),o=!0,a=!0;try{String.fromCharCode.apply(null,[0])}catch(e){o=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){a=!1}for(var s=new r.Buf8(256),c=0;256>c;c++)s[c]=c>=252?6:c>=248?5:c>=240?4:c>=224?3:c>=192?2:1;s[254]=s[254]=1,n.string2buf=function(e){var t,n,i,o,a,s=e.length,c=0;for(o=0;s>o;o++)55296==(64512&(n=e.charCodeAt(o)))&&s>o+1&&56320==(64512&(i=e.charCodeAt(o+1)))&&(n=65536+(n-55296<<10)+(i-56320),o++),c+=128>n?1:2048>n?2:65536>n?3:4;for(t=new r.Buf8(c),a=0,o=0;c>a;o++)55296==(64512&(n=e.charCodeAt(o)))&&s>o+1&&56320==(64512&(i=e.charCodeAt(o+1)))&&(n=65536+(n-55296<<10)+(i-56320),o++),128>n?t[a++]=n:2048>n?(t[a++]=192|n>>>6,t[a++]=128|63&n):65536>n?(t[a++]=224|n>>>12,t[a++]=128|n>>>6&63,t[a++]=128|63&n):(t[a++]=240|n>>>18,t[a++]=128|n>>>12&63,t[a++]=128|n>>>6&63,t[a++]=128|63&n);return t},n.buf2binstring=function(e){return i(e,e.length)},n.binstring2buf=function(e){for(var t=new r.Buf8(e.length),n=0,i=t.length;i>n;n++)t[n]=e.charCodeAt(n);return t},n.buf2string=function(e,t){var n,r,o,a,c=t||e.length,d=new Array(2*c);for(r=0,n=0;c>n;)if((o=e[n++])<128)d[r++]=o;else if((a=s[o])>4)d[r++]=65533,n+=a-1;else{for(o&=2===a?31:3===a?15:7;a>1&&c>n;)o=o<<6|63&e[n++],a--;a>1?d[r++]=65533:65536>o?d[r++]=o:(o-=65536,d[r++]=55296|o>>10&1023,d[r++]=56320|1023&o)}return i(d,r)},n.utf8border=function(e,t){var n;for((t=t||e.length)>e.length&&(t=e.length),n=t-1;n>=0&&128==(192&e[n]);)n--;return 0>n?t:0===n?t:n+s[e[n]]>t?n:t}},{"./common":3}],5:[function(e,t){"use strict";t.exports=function(e,t,n,i){for(var r=65535&e|0,o=e>>>16&65535|0,a=0;0!==n;){n-=a=n>2e3?2e3:n;do o=o+(r=r+t[i++]|0)|0;while(--a);r%=65521,o%=65521}return r|o<<16|0}},{}],6:[function(e,t){"use strict";t.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],7:[function(e,t){"use strict";var n=function(){for(var e,t=[],n=0;256>n;n++){e=n;for(var i=0;8>i;i++)e=1&e?3988292384^e>>>1:e>>>1;t[n]=e}return t}();t.exports=function(e,t,i,r){var o=n,a=r+i;e^=-1;for(var s=r;a>s;s++)e=e>>>8^o[255&(e^t[s])];return-1^e}},{}],8:[function(e,t,n){"use strict";function i(e,t){return e.msg=P[t],t}function r(e){return(e<<1)-(e>4?9:0)}function o(e){for(var t=e.length;--t>=0;)e[t]=0}function a(e){var t=e.state,n=t.pending;n>e.avail_out&&(n=e.avail_out),0!==n&&(T.arraySet(e.output,t.pending_buf,t.pending_out,n,e.next_out),e.next_out+=n,t.pending_out+=n,e.total_out+=n,e.avail_out-=n,t.pending-=n,0===t.pending&&(t.pending_out=0))}function s(e,t){R._tr_flush_block(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,a(e.strm)}function c(e,t){e.pending_buf[e.pending++]=t}function d(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function l(e,t,n,i){var r=e.avail_in;return r>i&&(r=i),0===r?0:(e.avail_in-=r,T.arraySet(t,e.input,e.next_in,r,n),1===e.state.wrap?e.adler=k(e.adler,t,r,n):2===e.state.wrap&&(e.adler=E(e.adler,t,r,n)),e.next_in+=r,e.total_in+=r,r)}function u(e,t){var n,i,r=e.max_chain_length,o=e.strstart,a=e.prev_length,s=e.nice_match,c=e.strstart>e.w_size-ie?e.strstart-(e.w_size-ie):0,d=e.window,l=e.w_mask,u=e.prev,p=e.strstart+ne,h=d[o+a-1],f=d[o+a];e.prev_length>=e.good_match&&(r>>=2),s>e.lookahead&&(s=e.lookahead);do if(n=t,d[n+a]===f&&d[n+a-1]===h&&d[n]===d[o]&&d[++n]===d[o+1]){o+=2,n++;do;while(d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&p>o);if(i=ne-(p-o),o=p-ne,i>a){if(e.match_start=t,a=i,i>=s)break;h=d[o+a-1],f=d[o+a]}}while((t=u[t&l])>c&&0!=--r);return a<=e.lookahead?a:e.lookahead}function p(e){var t,n,i,r,o,a=e.w_size;do{if(r=e.window_size-e.lookahead-e.strstart,e.strstart>=a+(a-ie)){T.arraySet(e.window,e.window,a,a,0),e.match_start-=a,e.strstart-=a,e.block_start-=a,t=n=e.hash_size;do i=e.head[--t],e.head[t]=i>=a?i-a:0;while(--n);t=n=a;do i=e.prev[--t],e.prev[t]=i>=a?i-a:0;while(--n);r+=a}if(0===e.strm.avail_in)break;if(n=l(e.strm,e.window,e.strstart+e.lookahead,r),e.lookahead+=n,e.lookahead+e.insert>=te)for(o=e.strstart-e.insert,e.ins_h=e.window[o],e.ins_h=(e.ins_h<<e.hash_shift^e.window[o+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[o+te-1])&e.hash_mask,e.prev[o&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=o,o++,e.insert--,!(e.lookahead+e.insert<te)););}while(e.lookahead<ie&&0!==e.strm.avail_in)}function h(e,t){for(var n,i;;){if(e.lookahead<ie){if(p(e),e.lookahead<ie&&t===I)return pe;if(0===e.lookahead)break}if(n=0,e.lookahead>=te&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+te-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==n&&e.strstart-n<=e.w_size-ie&&(e.match_length=u(e,n)),e.match_length>=te)if(i=R._tr_tally(e,e.strstart-e.match_start,e.match_length-te),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=te){e.match_length--;do e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+te-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart;while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else i=R._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(i&&(s(e,!1),0===e.strm.avail_out))return pe}return e.insert=e.strstart<te-1?e.strstart:te-1,t===L?(s(e,!0),0===e.strm.avail_out?fe:me):e.last_lit&&(s(e,!1),0===e.strm.avail_out)?pe:he}function f(e,t){for(var n,i,r;;){if(e.lookahead<ie){if(p(e),e.lookahead<ie&&t===I)return pe;if(0===e.lookahead)break}if(n=0,e.lookahead>=te&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+te-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=te-1,0!==n&&e.prev_length<e.max_lazy_match&&e.strstart-n<=e.w_size-ie&&(e.match_length=u(e,n),e.match_length<=5&&(e.strategy===F||e.match_length===te&&e.strstart-e.match_start>4096)&&(e.match_length=te-1)),e.prev_length>=te&&e.match_length<=e.prev_length){r=e.strstart+e.lookahead-te,i=R._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-te),e.lookahead-=e.prev_length-1,e.prev_length-=2;do++e.strstart<=r&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+te-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart);while(0!=--e.prev_length);if(e.match_available=0,e.match_length=te-1,e.strstart++,i&&(s(e,!1),0===e.strm.avail_out))return pe}else if(e.match_available){if((i=R._tr_tally(e,0,e.window[e.strstart-1]))&&s(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return pe}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(i=R._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<te-1?e.strstart:te-1,t===L?(s(e,!0),0===e.strm.avail_out?fe:me):e.last_lit&&(s(e,!1),0===e.strm.avail_out)?pe:he}function m(e,t){for(var n,i,r,o,a=e.window;;){if(e.lookahead<=ne){if(p(e),e.lookahead<=ne&&t===I)return pe;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=te&&e.strstart>0&&(r=e.strstart-1,(i=a[r])===a[++r]&&i===a[++r]&&i===a[++r])){o=e.strstart+ne;do;while(i===a[++r]&&i===a[++r]&&i===a[++r]&&i===a[++r]&&i===a[++r]&&i===a[++r]&&i===a[++r]&&i===a[++r]&&o>r);e.match_length=ne-(o-r),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=te?(n=R._tr_tally(e,1,e.match_length-te),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(n=R._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),n&&(s(e,!1),0===e.strm.avail_out))return pe}return e.insert=0,t===L?(s(e,!0),0===e.strm.avail_out?fe:me):e.last_lit&&(s(e,!1),0===e.strm.avail_out)?pe:he}function v(e,t){for(var n;;){if(0===e.lookahead&&(p(e),0===e.lookahead)){if(t===I)return pe;break}if(e.match_length=0,n=R._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,n&&(s(e,!1),0===e.strm.avail_out))return pe}return e.insert=0,t===L?(s(e,!0),0===e.strm.avail_out?fe:me):e.last_lit&&(s(e,!1),0===e.strm.avail_out)?pe:he}function _(e,t,n,i,r){this.good_length=e,this.max_lazy=t,this.nice_length=n,this.max_chain=i,this.func=r}function g(e){e.window_size=2*e.w_size,o(e.head),e.max_lazy_match=w[e.level].max_lazy,e.good_match=w[e.level].good_length,e.nice_match=w[e.level].nice_length,e.max_chain_length=w[e.level].max_chain,
e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=te-1,e.match_available=0,e.ins_h=0}function y(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=J,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new T.Buf16(2*X),this.dyn_dtree=new T.Buf16(2*(2*Q+1)),this.bl_tree=new T.Buf16(2*(2*Y+1)),o(this.dyn_ltree),o(this.dyn_dtree),o(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new T.Buf16(ee+1),this.heap=new T.Buf16(2*K+1),o(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new T.Buf16(2*K+1),o(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function S(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=W,t=e.state,t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?oe:le,e.adler=2===t.wrap?0:1,t.last_flush=I,R._tr_init(t),A):i(e,N)}function C(e){var t=S(e);return t===A&&g(e.state),t}function b(e,t,n,r,o,a){if(!e)return N;var s=1;if(t===U&&(t=6),0>r?(s=0,r=-r):r>15&&(s=2,r-=16),1>o||o>H||n!==J||8>r||r>15||0>t||t>9||0>a||a>q)return i(e,N);8===r&&(r=9);var c=new y;return e.state=c,c.strm=e,c.wrap=s,c.gzhead=null,c.w_bits=r,c.w_size=1<<c.w_bits,c.w_mask=c.w_size-1,c.hash_bits=o+7,c.hash_size=1<<c.hash_bits,c.hash_mask=c.hash_size-1,c.hash_shift=~~((c.hash_bits+te-1)/te),c.window=new T.Buf8(2*c.w_size),c.head=new T.Buf16(c.hash_size),c.prev=new T.Buf16(c.w_size),c.lit_bufsize=1<<o+6,c.pending_buf_size=4*c.lit_bufsize,c.pending_buf=new T.Buf8(c.pending_buf_size),c.d_buf=1*c.lit_bufsize,c.l_buf=3*c.lit_bufsize,c.level=t,c.strategy=a,c.method=n,C(e)}var w,T=e("../utils/common"),R=e("./trees"),k=e("./adler32"),E=e("./crc32"),P=e("./messages"),I=0,x=1,O=3,L=4,D=5,A=0,M=1,N=-2,B=-3,j=-5,U=-1,F=1,z=2,V=3,q=4,G=0,W=2,J=8,H=9,Z=15,$=8,K=286,Q=30,Y=19,X=2*K+1,ee=15,te=3,ne=258,ie=ne+te+1,re=32,oe=42,ae=69,se=73,ce=91,de=103,le=113,ue=666,pe=1,he=2,fe=3,me=4,ve=3;w=[new _(0,0,0,0,function(e,t){var n=65535;for(n>e.pending_buf_size-5&&(n=e.pending_buf_size-5);;){if(e.lookahead<=1){if(p(e),0===e.lookahead&&t===I)return pe;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var i=e.block_start+n;if((0===e.strstart||e.strstart>=i)&&(e.lookahead=e.strstart-i,e.strstart=i,s(e,!1),0===e.strm.avail_out))return pe;if(e.strstart-e.block_start>=e.w_size-ie&&(s(e,!1),0===e.strm.avail_out))return pe}return e.insert=0,t===L?(s(e,!0),0===e.strm.avail_out?fe:me):(e.strstart>e.block_start&&(s(e,!1),e.strm.avail_out),pe)}),new _(4,4,8,4,h),new _(4,5,16,8,h),new _(4,6,32,32,h),new _(4,4,16,16,f),new _(8,16,32,32,f),new _(8,16,128,128,f),new _(8,32,128,256,f),new _(32,128,258,1024,f),new _(32,258,258,4096,f)],n.deflateInit=function(e,t){return b(e,t,J,Z,$,G)},n.deflateInit2=b,n.deflateReset=C,n.deflateResetKeep=S,n.deflateSetHeader=function(e,t){return e&&e.state?2!==e.state.wrap?N:(e.state.gzhead=t,A):N},n.deflate=function(e,t){var n,s,l,u;if(!e||!e.state||t>D||0>t)return e?i(e,N):N;if(s=e.state,!e.output||!e.input&&0!==e.avail_in||s.status===ue&&t!==L)return i(e,0===e.avail_out?j:N);if(s.strm=e,n=s.last_flush,s.last_flush=t,s.status===oe)if(2===s.wrap)e.adler=0,c(s,31),c(s,139),c(s,8),s.gzhead?(c(s,(s.gzhead.text?1:0)+(s.gzhead.hcrc?2:0)+(s.gzhead.extra?4:0)+(s.gzhead.name?8:0)+(s.gzhead.comment?16:0)),c(s,255&s.gzhead.time),c(s,s.gzhead.time>>8&255),c(s,s.gzhead.time>>16&255),c(s,s.gzhead.time>>24&255),c(s,9===s.level?2:s.strategy>=z||s.level<2?4:0),c(s,255&s.gzhead.os),s.gzhead.extra&&s.gzhead.extra.length&&(c(s,255&s.gzhead.extra.length),c(s,s.gzhead.extra.length>>8&255)),s.gzhead.hcrc&&(e.adler=E(e.adler,s.pending_buf,s.pending,0)),s.gzindex=0,s.status=ae):(c(s,0),c(s,0),c(s,0),c(s,0),c(s,0),c(s,9===s.level?2:s.strategy>=z||s.level<2?4:0),c(s,ve),s.status=le);else{var p=J+(s.w_bits-8<<4)<<8;p|=(s.strategy>=z||s.level<2?0:s.level<6?1:6===s.level?2:3)<<6,0!==s.strstart&&(p|=re),p+=31-p%31,s.status=le,d(s,p),0!==s.strstart&&(d(s,e.adler>>>16),d(s,65535&e.adler)),e.adler=1}if(s.status===ae)if(s.gzhead.extra){for(l=s.pending;s.gzindex<(65535&s.gzhead.extra.length)&&(s.pending!==s.pending_buf_size||(s.gzhead.hcrc&&s.pending>l&&(e.adler=E(e.adler,s.pending_buf,s.pending-l,l)),a(e),l=s.pending,s.pending!==s.pending_buf_size));)c(s,255&s.gzhead.extra[s.gzindex]),s.gzindex++;s.gzhead.hcrc&&s.pending>l&&(e.adler=E(e.adler,s.pending_buf,s.pending-l,l)),s.gzindex===s.gzhead.extra.length&&(s.gzindex=0,s.status=se)}else s.status=se;if(s.status===se)if(s.gzhead.name){l=s.pending;do{if(s.pending===s.pending_buf_size&&(s.gzhead.hcrc&&s.pending>l&&(e.adler=E(e.adler,s.pending_buf,s.pending-l,l)),a(e),l=s.pending,s.pending===s.pending_buf_size)){u=1;break}u=s.gzindex<s.gzhead.name.length?255&s.gzhead.name.charCodeAt(s.gzindex++):0,c(s,u)}while(0!==u);s.gzhead.hcrc&&s.pending>l&&(e.adler=E(e.adler,s.pending_buf,s.pending-l,l)),0===u&&(s.gzindex=0,s.status=ce)}else s.status=ce;if(s.status===ce)if(s.gzhead.comment){l=s.pending;do{if(s.pending===s.pending_buf_size&&(s.gzhead.hcrc&&s.pending>l&&(e.adler=E(e.adler,s.pending_buf,s.pending-l,l)),a(e),l=s.pending,s.pending===s.pending_buf_size)){u=1;break}u=s.gzindex<s.gzhead.comment.length?255&s.gzhead.comment.charCodeAt(s.gzindex++):0,c(s,u)}while(0!==u);s.gzhead.hcrc&&s.pending>l&&(e.adler=E(e.adler,s.pending_buf,s.pending-l,l)),0===u&&(s.status=de)}else s.status=de;if(s.status===de&&(s.gzhead.hcrc?(s.pending+2>s.pending_buf_size&&a(e),s.pending+2<=s.pending_buf_size&&(c(s,255&e.adler),c(s,e.adler>>8&255),e.adler=0,s.status=le)):s.status=le),0!==s.pending){if(a(e),0===e.avail_out)return s.last_flush=-1,A}else if(0===e.avail_in&&r(t)<=r(n)&&t!==L)return i(e,j);if(s.status===ue&&0!==e.avail_in)return i(e,j);if(0!==e.avail_in||0!==s.lookahead||t!==I&&s.status!==ue){var h=s.strategy===z?v(s,t):s.strategy===V?m(s,t):w[s.level].func(s,t);if(h!==fe&&h!==me||(s.status=ue),h===pe||h===fe)return 0===e.avail_out&&(s.last_flush=-1),A;if(h===he&&(t===x?R._tr_align(s):t!==D&&(R._tr_stored_block(s,0,0,!1),t===O&&(o(s.head),0===s.lookahead&&(s.strstart=0,s.block_start=0,s.insert=0))),a(e),0===e.avail_out))return s.last_flush=-1,A}return t!==L?A:s.wrap<=0?M:(2===s.wrap?(c(s,255&e.adler),c(s,e.adler>>8&255),c(s,e.adler>>16&255),c(s,e.adler>>24&255),c(s,255&e.total_in),c(s,e.total_in>>8&255),c(s,e.total_in>>16&255),c(s,e.total_in>>24&255)):(d(s,e.adler>>>16),d(s,65535&e.adler)),a(e),s.wrap>0&&(s.wrap=-s.wrap),0!==s.pending?A:M)},n.deflateEnd=function(e){var t;return e&&e.state?(t=e.state.status)!==oe&&t!==ae&&t!==se&&t!==ce&&t!==de&&t!==le&&t!==ue?i(e,N):(e.state=null,t===le?i(e,B):A):N},n.deflateSetDictionary=function(e,t){var n,i,r,a,s,c,d,l,u=t.length;if(!e||!e.state)return N;if(n=e.state,2===(a=n.wrap)||1===a&&n.status!==oe||n.lookahead)return N;for(1===a&&(e.adler=k(e.adler,t,u,0)),n.wrap=0,u>=n.w_size&&(0===a&&(o(n.head),n.strstart=0,n.block_start=0,n.insert=0),l=new T.Buf8(n.w_size),T.arraySet(l,t,u-n.w_size,n.w_size,0),t=l,u=n.w_size),s=e.avail_in,c=e.next_in,d=e.input,e.avail_in=u,e.next_in=0,e.input=t,p(n);n.lookahead>=te;){i=n.strstart,r=n.lookahead-(te-1);do n.ins_h=(n.ins_h<<n.hash_shift^n.window[i+te-1])&n.hash_mask,n.prev[i&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=i,i++;while(--r);n.strstart=i,n.lookahead=te-1,p(n)}return n.strstart+=n.lookahead,n.block_start=n.strstart,n.insert=n.lookahead,n.lookahead=0,n.match_length=n.prev_length=te-1,n.match_available=0,e.next_in=c,e.input=d,e.avail_in=s,n.wrap=a,A},n.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":3,"./adler32":5,"./crc32":7,"./messages":13,"./trees":14}],9:[function(e,t){"use strict";t.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],10:[function(e,t){"use strict";t.exports=function(e,t){var n,i,r,o,a,s,c,d,l,u,p,h,f,m,v,_,g,y,S,C,b,w,T,R,k;n=e.state,i=e.next_in,R=e.input,r=i+(e.avail_in-5),o=e.next_out,k=e.output,a=o-(t-e.avail_out),s=o+(e.avail_out-257),c=n.dmax,d=n.wsize,l=n.whave,u=n.wnext,p=n.window,h=n.hold,f=n.bits,m=n.lencode,v=n.distcode,_=(1<<n.lenbits)-1,g=(1<<n.distbits)-1;e:do{15>f&&(h+=R[i++]<<f,f+=8,h+=R[i++]<<f,f+=8),y=m[h&_];t:for(;;){if(S=y>>>24,h>>>=S,f-=S,0===(S=y>>>16&255))k[o++]=65535&y;else{if(!(16&S)){if(0==(64&S)){y=m[(65535&y)+(h&(1<<S)-1)];continue t}if(32&S){n.mode=12;break e}e.msg="invalid literal/length code",n.mode=30;break e}C=65535&y,(S&=15)&&(S>f&&(h+=R[i++]<<f,f+=8),C+=h&(1<<S)-1,h>>>=S,f-=S),15>f&&(h+=R[i++]<<f,f+=8,h+=R[i++]<<f,f+=8),y=v[h&g];n:for(;;){if(S=y>>>24,h>>>=S,f-=S,!(16&(S=y>>>16&255))){if(0==(64&S)){y=v[(65535&y)+(h&(1<<S)-1)];continue n}e.msg="invalid distance code",n.mode=30;break e}if(b=65535&y,S&=15,S>f&&(h+=R[i++]<<f,(f+=8)<S&&(h+=R[i++]<<f,f+=8)),(b+=h&(1<<S)-1)>c){e.msg="invalid distance too far back",n.mode=30;break e}if(h>>>=S,f-=S,S=o-a,b>S){if((S=b-S)>l&&n.sane){e.msg="invalid distance too far back",n.mode=30;break e}if(w=0,T=p,0===u){if(w+=d-S,C>S){C-=S;do k[o++]=p[w++];while(--S);w=o-b,T=k}}else if(S>u){if(w+=d+u-S,(S-=u)<C){C-=S;do k[o++]=p[w++];while(--S);if(w=0,C>u){C-=S=u;do k[o++]=p[w++];while(--S);w=o-b,T=k}}}else if(w+=u-S,C>S){C-=S;do k[o++]=p[w++];while(--S);w=o-b,T=k}for(;C>2;)k[o++]=T[w++],k[o++]=T[w++],k[o++]=T[w++],C-=3;C&&(k[o++]=T[w++],C>1&&(k[o++]=T[w++]))}else{w=o-b;do k[o++]=k[w++],k[o++]=k[w++],k[o++]=k[w++],C-=3;while(C>2);C&&(k[o++]=k[w++],C>1&&(k[o++]=k[w++]))}break}}break}}while(r>i&&s>o);i-=C=f>>3,h&=(1<<(f-=C<<3))-1,e.next_in=i,e.next_out=o,e.avail_in=r>i?r-i+5:5-(i-r),e.avail_out=s>o?s-o+257:257-(o-s),n.hold=h,n.bits=f}},{}],11:[function(e,t,n){"use strict";function i(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function r(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new h.Buf16(320),this.work=new h.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function o(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=L,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new h.Buf32(le),t.distcode=t.distdyn=new h.Buf32(ue),t.sane=1,t.back=-1,T):E}function a(e){var t;return e&&e.state?(t=e.state,t.wsize=0,t.whave=0,t.wnext=0,o(e)):E}function s(e,t){var n,i;return e&&e.state?(i=e.state,0>t?(n=0,t=-t):(n=1+(t>>4),48>t&&(t&=15)),t&&(8>t||t>15)?E:(null!==i.window&&i.wbits!==t&&(i.window=null),i.wrap=n,i.wbits=t,a(e))):E}function c(e,t){var n,i;return e?(i=new r,e.state=i,i.window=null,(n=s(e,t))!==T&&(e.state=null),n):E}function d(e){if(he){var t;for(u=new h.Buf32(512),p=new h.Buf32(32),t=0;144>t;)e.lens[t++]=8;for(;256>t;)e.lens[t++]=9;for(;280>t;)e.lens[t++]=7;for(;288>t;)e.lens[t++]=8;for(_(y,e.lens,0,288,u,0,e.work,{bits:9}),t=0;32>t;)e.lens[t++]=5;_(S,e.lens,0,32,p,0,e.work,{bits:5}),he=!1}e.lencode=u,e.lenbits=9,e.distcode=p,e.distbits=5}function l(e,t,n,i){var r,o=e.state;return null===o.window&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new h.Buf8(o.wsize)),i>=o.wsize?(h.arraySet(o.window,t,n-o.wsize,o.wsize,0),o.wnext=0,o.whave=o.wsize):((r=o.wsize-o.wnext)>i&&(r=i),h.arraySet(o.window,t,n-i,r,o.wnext),(i-=r)?(h.arraySet(o.window,t,n-i,i,0),o.wnext=i,o.whave=o.wsize):(o.wnext+=r,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=r))),0}var u,p,h=e("../utils/common"),f=e("./adler32"),m=e("./crc32"),v=e("./inffast"),_=e("./inftrees"),g=0,y=1,S=2,C=4,b=5,w=6,T=0,R=1,k=2,E=-2,P=-3,I=-4,x=-5,O=8,L=1,D=2,A=3,M=4,N=5,B=6,j=7,U=8,F=9,z=10,V=11,q=12,G=13,W=14,J=15,H=16,Z=17,$=18,K=19,Q=20,Y=21,X=22,ee=23,te=24,ne=25,ie=26,re=27,oe=28,ae=29,se=30,ce=31,de=32,le=852,ue=592,pe=15,he=!0;n.inflateReset=a,n.inflateReset2=s,n.inflateResetKeep=o,n.inflateInit=function(e){return c(e,pe)},n.inflateInit2=c,n.inflate=function(e,t){var n,r,o,a,s,c,u,p,le,ue,pe,he,fe,me,ve,_e,ge,ye,Se,Ce,be,we,Te,Re,ke=0,Ee=new h.Buf8(4),Pe=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return E;(n=e.state).mode===q&&(n.mode=G),s=e.next_out,o=e.output,u=e.avail_out,a=e.next_in,r=e.input,c=e.avail_in,p=n.hold,le=n.bits,ue=c,pe=u,we=T;e:for(;;)switch(n.mode){case L:if(0===n.wrap){n.mode=G;break}for(;16>le;){if(0===c)break e;c--,p+=r[a++]<<le,le+=8}if(2&n.wrap&&35615===p){n.check=0,Ee[0]=255&p,Ee[1]=p>>>8&255,n.check=m(n.check,Ee,2,0),p=0,le=0,n.mode=D;break}if(n.flags=0,n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&p)<<8)+(p>>8))%31){e.msg="incorrect header check",n.mode=se;break}if((15&p)!==O){e.msg="unknown compression method",n.mode=se;break}if(p>>>=4,le-=4,be=8+(15&p),0===n.wbits)n.wbits=be;else if(be>n.wbits){e.msg="invalid window size",n.mode=se;break}n.dmax=1<<be,e.adler=n.check=1,n.mode=512&p?z:q,p=0,le=0;break;case D:for(;16>le;){if(0===c)break e;c--,p+=r[a++]<<le,le+=8}if(n.flags=p,(255&n.flags)!==O){e.msg="unknown compression method",n.mode=se;break}if(57344&n.flags){e.msg="unknown header flags set",n.mode=se;break}n.head&&(n.head.text=p>>8&1),512&n.flags&&(Ee[0]=255&p,Ee[1]=p>>>8&255,n.check=m(n.check,Ee,2,0)),p=0,le=0,n.mode=A;case A:for(;32>le;){if(0===c)break e;c--,p+=r[a++]<<le,le+=8}n.head&&(n.head.time=p),512&n.flags&&(Ee[0]=255&p,Ee[1]=p>>>8&255,Ee[2]=p>>>16&255,Ee[3]=p>>>24&255,n.check=m(n.check,Ee,4,0)),p=0,le=0,n.mode=M;case M:for(;16>le;){if(0===c)break e;c--,p+=r[a++]<<le,le+=8}n.head&&(n.head.xflags=255&p,n.head.os=p>>8),512&n.flags&&(Ee[0]=255&p,Ee[1]=p>>>8&255,n.check=m(n.check,Ee,2,0)),p=0,le=0,n.mode=N;case N:if(1024&n.flags){for(;16>le;){if(0===c)break e;c--,p+=r[a++]<<le,le+=8}n.length=p,n.head&&(n.head.extra_len=p),512&n.flags&&(Ee[0]=255&p,Ee[1]=p>>>8&255,n.check=m(n.check,Ee,2,0)),p=0,le=0}else n.head&&(n.head.extra=null);n.mode=B;case B:if(1024&n.flags&&((he=n.length)>c&&(he=c),he&&(n.head&&(be=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Array(n.head.extra_len)),h.arraySet(n.head.extra,r,a,he,be)),512&n.flags&&(n.check=m(n.check,r,he,a)),c-=he,a+=he,n.length-=he),n.length))break e;n.length=0,n.mode=j;case j:if(2048&n.flags){if(0===c)break e;he=0;do be=r[a+he++],n.head&&be&&n.length<65536&&(n.head.name+=String.fromCharCode(be));while(be&&c>he);if(512&n.flags&&(n.check=m(n.check,r,he,a)),c-=he,a+=he,be)break e}else n.head&&(n.head.name=null);n.length=0,n.mode=U;case U:if(4096&n.flags){if(0===c)break e;he=0;do be=r[a+he++],n.head&&be&&n.length<65536&&(n.head.comment+=String.fromCharCode(be));while(be&&c>he);if(512&n.flags&&(n.check=m(n.check,r,he,a)),c-=he,a+=he,be)break e}else n.head&&(n.head.comment=null);n.mode=F;case F:if(512&n.flags){for(;16>le;){if(0===c)break e;c--,p+=r[a++]<<le,le+=8}if(p!==(65535&n.check)){e.msg="header crc mismatch",n.mode=se;break}p=0,le=0}n.head&&(n.head.hcrc=n.flags>>9&1,n.head.done=!0),e.adler=n.check=0,n.mode=q;break;case z:for(;32>le;){if(0===c)break e;c--,p+=r[a++]<<le,le+=8}e.adler=n.check=i(p),p=0,le=0,n.mode=V;case V:if(0===n.havedict)return e.next_out=s,e.avail_out=u,e.next_in=a,e.avail_in=c,n.hold=p,n.bits=le,k;e.adler=n.check=1,n.mode=q;case q:if(t===b||t===w)break e;case G:if(n.last){p>>>=7&le,le-=7&le,n.mode=re;break}for(;3>le;){if(0===c)break e;c--,p+=r[a++]<<le,le+=8}switch(n.last=1&p,p>>>=1,le-=1,3&p){case 0:n.mode=W;break;case 1:if(d(n),n.mode=Q,t===w){p>>>=2,le-=2;break e}break;case 2:n.mode=Z;break;case 3:e.msg="invalid block type",n.mode=se}p>>>=2,le-=2;break;case W:for(p>>>=7&le,le-=7&le;32>le;){if(0===c)break e;c--,p+=r[a++]<<le,le+=8}if((65535&p)!=(p>>>16^65535)){e.msg="invalid stored block lengths",n.mode=se;break}if(n.length=65535&p,p=0,le=0,n.mode=J,t===w)break e;case J:n.mode=H;case H:if(he=n.length){if(he>c&&(he=c),he>u&&(he=u),0===he)break e;h.arraySet(o,r,a,he,s),c-=he,a+=he,u-=he,s+=he,n.length-=he;break}n.mode=q;break;case Z:for(;14>le;){if(0===c)break e;c--,p+=r[a++]<<le,le+=8}if(n.nlen=257+(31&p),p>>>=5,le-=5,n.ndist=1+(31&p),p>>>=5,le-=5,n.ncode=4+(15&p),p>>>=4,le-=4,n.nlen>286||n.ndist>30){e.msg="too many length or distance symbols",n.mode=se;break}n.have=0,n.mode=$;case $:for(;n.have<n.ncode;){for(;3>le;){if(0===c)break e;c--,p+=r[a++]<<le,le+=8}n.lens[Pe[n.have++]]=7&p,p>>>=3,le-=3}for(;n.have<19;)n.lens[Pe[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,Te={bits:n.lenbits},we=_(g,n.lens,0,19,n.lencode,0,n.work,Te),n.lenbits=Te.bits,we){e.msg="invalid code lengths set",n.mode=se;break}n.have=0,n.mode=K;case K:for(;n.have<n.nlen+n.ndist;){for(;ke=n.lencode[p&(1<<n.lenbits)-1],ve=ke>>>24,_e=ke>>>16&255,ge=65535&ke,!(le>=ve);){if(0===c)break e;c--,p+=r[a++]<<le,le+=8}if(16>ge)p>>>=ve,le-=ve,n.lens[n.have++]=ge;else{if(16===ge){for(Re=ve+2;Re>le;){if(0===c)break e;c--,p+=r[a++]<<le,le+=8}if(p>>>=ve,le-=ve,0===n.have){e.msg="invalid bit length repeat",n.mode=se;break}be=n.lens[n.have-1],he=3+(3&p),p>>>=2,le-=2}else if(17===ge){for(Re=ve+3;Re>le;){if(0===c)break e;c--,p+=r[a++]<<le,le+=8}le-=ve,be=0,he=3+(7&(p>>>=ve)),p>>>=3,le-=3}else{for(Re=ve+7;Re>le;){if(0===c)break e;c--,p+=r[a++]<<le,le+=8}le-=ve,be=0,he=11+(127&(p>>>=ve)),p>>>=7,le-=7}if(n.have+he>n.nlen+n.ndist){e.msg="invalid bit length repeat",n.mode=se;break}for(;he--;)n.lens[n.have++]=be}}if(n.mode===se)break;if(0===n.lens[256]){e.msg="invalid code -- missing end-of-block",n.mode=se;break}if(n.lenbits=9,Te={bits:n.lenbits},we=_(y,n.lens,0,n.nlen,n.lencode,0,n.work,Te),n.lenbits=Te.bits,we){e.msg="invalid literal/lengths set",n.mode=se;break}if(n.distbits=6,n.distcode=n.distdyn,Te={bits:n.distbits},we=_(S,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,Te),n.distbits=Te.bits,we){e.msg="invalid distances set",n.mode=se;break}if(n.mode=Q,t===w)break e;case Q:n.mode=Y;case Y:if(c>=6&&u>=258){e.next_out=s,e.avail_out=u,e.next_in=a,e.avail_in=c,n.hold=p,n.bits=le,v(e,pe),s=e.next_out,o=e.output,u=e.avail_out,a=e.next_in,r=e.input,c=e.avail_in,p=n.hold,le=n.bits,n.mode===q&&(n.back=-1);break}for(n.back=0;ke=n.lencode[p&(1<<n.lenbits)-1],ve=ke>>>24,_e=ke>>>16&255,ge=65535&ke,!(le>=ve);){if(0===c)break e;c--,p+=r[a++]<<le,le+=8}if(_e&&0==(240&_e)){for(ye=ve,Se=_e,Ce=ge;ke=n.lencode[Ce+((p&(1<<ye+Se)-1)>>ye)],ve=ke>>>24,_e=ke>>>16&255,ge=65535&ke,!(le>=ye+ve);){if(0===c)break e;c--,p+=r[a++]<<le,le+=8}p>>>=ye,le-=ye,n.back+=ye}if(p>>>=ve,le-=ve,n.back+=ve,n.length=ge,0===_e){n.mode=ie;break}if(32&_e){n.back=-1,n.mode=q;break}if(64&_e){e.msg="invalid literal/length code",n.mode=se;break}n.extra=15&_e,n.mode=X;case X:if(n.extra){for(Re=n.extra;Re>le;){if(0===c)break e;c--,p+=r[a++]<<le,le+=8}n.length+=p&(1<<n.extra)-1,p>>>=n.extra,le-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=ee;case ee:for(;ke=n.distcode[p&(1<<n.distbits)-1],ve=ke>>>24,_e=ke>>>16&255,ge=65535&ke,!(le>=ve);){if(0===c)break e;c--,p+=r[a++]<<le,le+=8}if(0==(240&_e)){for(ye=ve,Se=_e,Ce=ge;ke=n.distcode[Ce+((p&(1<<ye+Se)-1)>>ye)],ve=ke>>>24,_e=ke>>>16&255,ge=65535&ke,!(le>=ye+ve);){if(0===c)break e;c--,p+=r[a++]<<le,le+=8}p>>>=ye,le-=ye,n.back+=ye}if(p>>>=ve,le-=ve,n.back+=ve,64&_e){e.msg="invalid distance code",n.mode=se;break}n.offset=ge,n.extra=15&_e,n.mode=te;case te:if(n.extra){for(Re=n.extra;Re>le;){if(0===c)break e;c--,p+=r[a++]<<le,le+=8}n.offset+=p&(1<<n.extra)-1,p>>>=n.extra,le-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){e.msg="invalid distance too far back",n.mode=se;break}n.mode=ne;case ne:if(0===u)break e;if(he=pe-u,n.offset>he){if((he=n.offset-he)>n.whave&&n.sane){e.msg="invalid distance too far back",n.mode=se;break}he>n.wnext?(he-=n.wnext,fe=n.wsize-he):fe=n.wnext-he,he>n.length&&(he=n.length),me=n.window}else me=o,fe=s-n.offset,he=n.length;he>u&&(he=u),u-=he,n.length-=he;do o[s++]=me[fe++];while(--he);0===n.length&&(n.mode=Y);break;case ie:if(0===u)break e;o[s++]=n.length,u--,n.mode=Y;break;case re:if(n.wrap){for(;32>le;){if(0===c)break e;c--,p|=r[a++]<<le,le+=8}if(pe-=u,e.total_out+=pe,n.total+=pe,pe&&(e.adler=n.check=n.flags?m(n.check,o,pe,s-pe):f(n.check,o,pe,s-pe)),pe=u,(n.flags?p:i(p))!==n.check){e.msg="incorrect data check",n.mode=se;break}p=0,le=0}n.mode=oe;case oe:if(n.wrap&&n.flags){for(;32>le;){if(0===c)break e;c--,p+=r[a++]<<le,le+=8}if(p!==(4294967295&n.total)){e.msg="incorrect length check",n.mode=se;break}p=0,le=0}n.mode=ae;case ae:we=R;break e;case se:we=P;break e;case ce:return I;case de:default:return E}return e.next_out=s,e.avail_out=u,e.next_in=a,e.avail_in=c,n.hold=p,n.bits=le,(n.wsize||pe!==e.avail_out&&n.mode<se&&(n.mode<re||t!==C))&&l(e,e.output,e.next_out,pe-e.avail_out)?(n.mode=ce,I):(ue-=e.avail_in,pe-=e.avail_out,e.total_in+=ue,e.total_out+=pe,n.total+=pe,n.wrap&&pe&&(e.adler=n.check=n.flags?m(n.check,o,pe,e.next_out-pe):f(n.check,o,pe,e.next_out-pe)),e.data_type=n.bits+(n.last?64:0)+(n.mode===q?128:0)+(n.mode===Q||n.mode===J?256:0),(0===ue&&0===pe||t===C)&&we===T&&(we=x),we)},n.inflateEnd=function(e){if(!e||!e.state)return E;var t=e.state;return t.window&&(t.window=null),e.state=null,T},n.inflateGetHeader=function(e,t){var n;return e&&e.state?0==(2&(n=e.state).wrap)?E:(n.head=t,t.done=!1,T):E},n.inflateSetDictionary=function(e,t){var n,i,r=t.length;return e&&e.state?0!==(n=e.state).wrap&&n.mode!==V?E:n.mode===V&&(i=1,(i=f(i,t,r,0))!==n.check)?P:l(e,t,r,r)?(n.mode=ce,I):(n.havedict=1,T):E},n.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":3,"./adler32":5,"./crc32":7,"./inffast":10,"./inftrees":12}],12:[function(e,t){"use strict";var n=e("../utils/common"),i=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],r=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],o=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],a=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];t.exports=function(e,t,s,c,d,l,u,p){var h,f,m,v,_,g,y,S,C,b=p.bits,w=0,T=0,R=0,k=0,E=0,P=0,I=0,x=0,O=0,L=0,D=null,A=0,M=new n.Buf16(16),N=new n.Buf16(16),B=null,j=0;for(w=0;15>=w;w++)M[w]=0;for(T=0;c>T;T++)M[t[s+T]]++;for(E=b,k=15;k>=1&&0===M[k];k--);if(E>k&&(E=k),0===k)return d[l++]=20971520,d[l++]=20971520,p.bits=1,0;for(R=1;k>R&&0===M[R];R++);for(R>E&&(E=R),x=1,w=1;15>=w;w++)if(x<<=1,(x-=M[w])<0)return-1;if(x>0&&(0===e||1!==k))return-1;for(N[1]=0,w=1;15>w;w++)N[w+1]=N[w]+M[w];for(T=0;c>T;T++)0!==t[s+T]&&(u[N[t[s+T]]++]=T);if(0===e?(D=B=u,g=19):1===e?(D=i,A-=257,B=r,j-=257,g=256):(D=o,B=a,g=-1),L=0,T=0,w=R,_=l,P=E,I=0,m=-1,O=1<<E,v=O-1,1===e&&O>852||2===e&&O>592)return 1;for(;;){y=w-I,u[T]<g?(S=0,C=u[T]):u[T]>g?(S=B[j+u[T]],C=D[A+u[T]]):(S=96,C=0),h=1<<w-I,R=f=1<<P;do d[_+(L>>I)+(f-=h)]=y<<24|S<<16|C|0;while(0!==f);for(h=1<<w-1;L&h;)h>>=1;if(0!==h?(L&=h-1,L+=h):L=0,T++,0==--M[w]){if(w===k)break;w=t[s+u[T]]}if(w>E&&(L&v)!==m){for(0===I&&(I=E),_+=R,x=1<<(P=w-I);k>P+I&&!((x-=M[P+I])<=0);)P++,x<<=1;if(O+=1<<P,1===e&&O>852||2===e&&O>592)return 1;d[m=L&v]=E<<24|P<<16|_-l|0}}return 0!==L&&(d[_+L]=w-I<<24|64<<16|0),p.bits=E,0}},{"../utils/common":3}],13:[function(e,t){"use strict";t.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],14:[function(e,t,n){"use strict";function i(e){for(var t=e.length;--t>=0;)e[t]=0}function r(e,t,n,i,r){this.static_tree=e,this.extra_bits=t,this.extra_base=n,this.elems=i,this.max_length=r,this.has_stree=e&&e.length}function o(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function a(e){return 256>e?te[e]:te[256+(e>>>7)]}function s(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function c(e,t,n){e.bi_valid>q-n?(e.bi_buf|=t<<e.bi_valid&65535,s(e,e.bi_buf),e.bi_buf=t>>q-e.bi_valid,e.bi_valid+=n-q):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=n)}function d(e,t,n){c(e,n[2*t],n[2*t+1])}function l(e,t){var n=0;do n|=1&e,e>>>=1,n<<=1;while(--t>0);return n>>>1}function u(e){16===e.bi_valid?(s(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}function p(e,t){var n,i,r,o,a,s,c=t.dyn_tree,d=t.max_code,l=t.stat_desc.static_tree,u=t.stat_desc.has_stree,p=t.stat_desc.extra_bits,h=t.stat_desc.extra_base,f=t.stat_desc.max_length,m=0;for(o=0;V>=o;o++)e.bl_count[o]=0;for(c[2*e.heap[e.heap_max]+1]=0,n=e.heap_max+1;z>n;n++)(o=c[2*c[2*(i=e.heap[n])+1]+1]+1)>f&&(o=f,m++),c[2*i+1]=o,i>d||(e.bl_count[o]++,a=0,i>=h&&(a=p[i-h]),s=c[2*i],e.opt_len+=s*(o+a),u&&(e.static_len+=s*(l[2*i+1]+a)));if(0!==m){do{for(o=f-1;0===e.bl_count[o];)o--;e.bl_count[o]--,e.bl_count[o+1]+=2,e.bl_count[f]--,m-=2}while(m>0);for(o=f;0!==o;o--)for(i=e.bl_count[o];0!==i;)(r=e.heap[--n])>d||(c[2*r+1]!==o&&(e.opt_len+=(o-c[2*r+1])*c[2*r],c[2*r+1]=o),i--)}}function h(e,t,n){var i,r,o=new Array(V+1),a=0;for(i=1;V>=i;i++)o[i]=a=a+n[i-1]<<1;for(r=0;t>=r;r++){var s=e[2*r+1];0!==s&&(e[2*r]=l(o[s]++,s))}}function f(){var e,t,n,i,o,a=new Array(V+1);for(n=0,i=0;N-1>i;i++)for(ie[i]=n,e=0;e<1<<$[i];e++)ne[n++]=i;for(ne[n-1]=i,o=0,i=0;16>i;i++)for(re[i]=o,e=0;e<1<<K[i];e++)te[o++]=i;for(o>>=7;U>i;i++)for(re[i]=o<<7,e=0;e<1<<K[i]-7;e++)te[256+o++]=i;for(t=0;V>=t;t++)a[t]=0;for(e=0;143>=e;)X[2*e+1]=8,e++,a[8]++;for(;255>=e;)X[2*e+1]=9,e++,a[9]++;for(;279>=e;)X[2*e+1]=7,e++,a[7]++;for(;287>=e;)X[2*e+1]=8,e++,a[8]++;for(h(X,j+1,a),e=0;U>e;e++)ee[2*e+1]=5,ee[2*e]=l(e,5);oe=new r(X,$,B+1,j,V),ae=new r(ee,K,0,U,V),se=new r(new Array(0),Q,0,F,G)}function m(e){var t;for(t=0;j>t;t++)e.dyn_ltree[2*t]=0;for(t=0;U>t;t++)e.dyn_dtree[2*t]=0;for(t=0;F>t;t++)e.bl_tree[2*t]=0;e.dyn_ltree[2*W]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function v(e){e.bi_valid>8?s(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function _(e,t,n,i){v(e),i&&(s(e,n),s(e,~n)),P.arraySet(e.pending_buf,e.window,t,n,e.pending),e.pending+=n}function g(e,t,n,i){var r=2*t,o=2*n;return e[r]<e[o]||e[r]===e[o]&&i[t]<=i[n]}function y(e,t,n){for(var i=e.heap[n],r=n<<1;r<=e.heap_len&&(r<e.heap_len&&g(t,e.heap[r+1],e.heap[r],e.depth)&&r++,!g(t,i,e.heap[r],e.depth));)e.heap[n]=e.heap[r],n=r,r<<=1;e.heap[n]=i}function S(e,t,n){var i,r,o,s,l=0;if(0!==e.last_lit)do i=e.pending_buf[e.d_buf+2*l]<<8|e.pending_buf[e.d_buf+2*l+1],r=e.pending_buf[e.l_buf+l],l++,0===i?d(e,r,t):(d(e,(o=ne[r])+B+1,t),0!==(s=$[o])&&c(e,r-=ie[o],s),d(e,o=a(--i),n),0!==(s=K[o])&&c(e,i-=re[o],s));while(l<e.last_lit);d(e,W,t)}function C(e,t){var n,i,r,o=t.dyn_tree,a=t.stat_desc.static_tree,s=t.stat_desc.has_stree,c=t.stat_desc.elems,d=-1;for(e.heap_len=0,e.heap_max=z,n=0;c>n;n++)0!==o[2*n]?(e.heap[++e.heap_len]=d=n,e.depth[n]=0):o[2*n+1]=0;for(;e.heap_len<2;)o[2*(r=e.heap[++e.heap_len]=2>d?++d:0)]=1,e.depth[r]=0,e.opt_len--,s&&(e.static_len-=a[2*r+1]);for(t.max_code=d,n=e.heap_len>>1;n>=1;n--)y(e,o,n);r=c;do n=e.heap[1],e.heap[1]=e.heap[e.heap_len--],y(e,o,1),i=e.heap[1],e.heap[--e.heap_max]=n,e.heap[--e.heap_max]=i,o[2*r]=o[2*n]+o[2*i],e.depth[r]=(e.depth[n]>=e.depth[i]?e.depth[n]:e.depth[i])+1,o[2*n+1]=o[2*i+1]=r,e.heap[1]=r++,y(e,o,1);while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],p(e,t),h(o,d,e.bl_count)}function b(e,t,n){var i,r,o=-1,a=t[1],s=0,c=7,d=4;for(0===a&&(c=138,d=3),t[2*(n+1)+1]=65535,i=0;n>=i;i++)r=a,a=t[2*(i+1)+1],++s<c&&r===a||(d>s?e.bl_tree[2*r]+=s:0!==r?(r!==o&&e.bl_tree[2*r]++,e.bl_tree[2*J]++):10>=s?e.bl_tree[2*H]++:e.bl_tree[2*Z]++,s=0,o=r,0===a?(c=138,d=3):r===a?(c=6,d=3):(c=7,d=4))}function w(e,t,n){var i,r,o=-1,a=t[1],s=0,l=7,u=4;for(0===a&&(l=138,u=3),i=0;n>=i;i++)if(r=a,a=t[2*(i+1)+1],!(++s<l&&r===a)){if(u>s){do d(e,r,e.bl_tree);while(0!=--s)}else 0!==r?(r!==o&&(d(e,r,e.bl_tree),s--),d(e,J,e.bl_tree),c(e,s-3,2)):10>=s?(d(e,H,e.bl_tree),c(e,s-3,3)):(d(e,Z,e.bl_tree),c(e,s-11,7));s=0,o=r,0===a?(l=138,u=3):r===a?(l=6,u=3):(l=7,u=4)}}function T(e){var t;for(b(e,e.dyn_ltree,e.l_desc.max_code),b(e,e.dyn_dtree,e.d_desc.max_code),C(e,e.bl_desc),t=F-1;t>=3&&0===e.bl_tree[2*Y[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}function R(e,t,n,i){var r;for(c(e,t-257,5),c(e,n-1,5),c(e,i-4,4),r=0;i>r;r++)c(e,e.bl_tree[2*Y[r]+1],3);w(e,e.dyn_ltree,t-1),w(e,e.dyn_dtree,n-1)}function k(e){var t,n=4093624447;for(t=0;31>=t;t++,n>>>=1)if(1&n&&0!==e.dyn_ltree[2*t])return x;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return O;for(t=32;B>t;t++)if(0!==e.dyn_ltree[2*t])return O;return x}function E(e,t,n,i){c(e,(D<<1)+(i?1:0),3),_(e,t,n,!0)}var P=e("../utils/common"),I=4,x=0,O=1,L=2,D=0,A=1,M=2,N=29,B=256,j=B+1+N,U=30,F=19,z=2*j+1,V=15,q=16,G=7,W=256,J=16,H=17,Z=18,$=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],K=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],Q=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],Y=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],X=new Array(2*(j+2));i(X);var ee=new Array(2*U);i(ee);var te=new Array(512);i(te);var ne=new Array(256);i(ne);var ie=new Array(N);i(ie);var re=new Array(U);i(re);var oe,ae,se,ce=!1;n._tr_init=function(e){ce||(f(),ce=!0),e.l_desc=new o(e.dyn_ltree,oe),e.d_desc=new o(e.dyn_dtree,ae),e.bl_desc=new o(e.bl_tree,se),e.bi_buf=0,e.bi_valid=0,m(e)},n._tr_stored_block=E,n._tr_flush_block=function(e,t,n,i){var r,o,a=0;e.level>0?(e.strm.data_type===L&&(e.strm.data_type=k(e)),C(e,e.l_desc),C(e,e.d_desc),a=T(e),r=e.opt_len+3+7>>>3,(o=e.static_len+3+7>>>3)<=r&&(r=o)):r=o=n+5,r>=n+4&&-1!==t?E(e,t,n,i):e.strategy===I||o===r?(c(e,(A<<1)+(i?1:0),3),S(e,X,ee)):(c(e,(M<<1)+(i?1:0),3),R(e,e.l_desc.max_code+1,e.d_desc.max_code+1,a+1),S(e,e.dyn_ltree,e.dyn_dtree)),m(e),i&&v(e)},n._tr_tally=function(e,t,n){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&n,e.last_lit++,0===t?e.dyn_ltree[2*n]++:(e.matches++,t--,e.dyn_ltree[2*(ne[n]+B+1)]++,e.dyn_dtree[2*a(t)]++),e.last_lit===e.lit_bufsize-1},n._tr_align=function(e){c(e,A<<1,3),d(e,W,X),u(e)}},{"../utils/common":3}],15:[function(e,t){"use strict";t.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],"/":[function(e,t){"use strict";var n={};(0,e("./lib/utils/common").assign)(n,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),t.exports=n},{"./lib/deflate":1,"./lib/inflate":2,"./lib/utils/common":3,"./lib/zlib/constants":6}]},{},[])("/")}),function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.adapter=e()}}(function(){return function e(t,n,i){function r(a,s){if(!n[a]){if(!t[a]){var c="function"==typeof require&&require;if(!s&&c)return c(a,!0);if(o)return o(a,!0);var d=new Error("Cannot find module '"+a+"'");throw d.code="MODULE_NOT_FOUND",d}var l=n[a]={exports:{}};t[a][0].call(l.exports,function(e){var n=t[a][1][e];return r(n?n:e)},l,l.exports,e,t,n,i)}return n[a].exports}for(var o="function"==typeof require&&require,a=0;a<i.length;a++)r(i[a]);return r}({1:[function(e,t){var n={};n.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},n.localCName=n.generateIdentifier(),n.splitLines=function(e){return e.trim().split("\n").map(function(e){return e.trim();
})},n.splitSections=function(e){var t=e.split("\nm=");return t.map(function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"})},n.getDescription=function(e){var t=n.splitSections(e);return t&&t[0]},n.getMediaSections=function(e){var t=n.splitSections(e);return t.shift(),t},n.matchPrefix=function(e,t){return n.splitLines(e).filter(function(e){return 0===e.indexOf(t)})},n.parseCandidate=function(e){var t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");for(var n={foundation:t[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],port:parseInt(t[5],10),type:t[7]},i=8;i<t.length;i+=2)switch(t[i]){case"raddr":n.relatedAddress=t[i+1];break;case"rport":n.relatedPort=parseInt(t[i+1],10);break;case"tcptype":n.tcpType=t[i+1];break;case"ufrag":n.ufrag=t[i+1],n.usernameFragment=t[i+1];break;default:n[t[i]]=t[i+1]}return n},n.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.ip),t.push(e.port);var n=e.type;return t.push("typ"),t.push(n),"host"!==n&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),e.ufrag&&(t.push("ufrag"),t.push(e.ufrag)),"candidate:"+t.join(" ")},n.parseIceOptions=function(e){return e.substr(14).split(" ")},n.parseRtpMap=function(e){var t=e.substr(9).split(" "),n={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),n.name=t[0],n.clockRate=parseInt(t[1],10),n.numChannels=3===t.length?parseInt(t[2],10):1,n},n.writeRtpMap=function(e){var t=e.payloadType;return void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType),"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==e.numChannels?"/"+e.numChannels:"")+"\r\n"},n.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},n.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},n.parseFmtp=function(e){for(var t,n={},i=e.substr(e.indexOf(" ")+1).split(";"),r=0;r<i.length;r++)t=i[r].trim().split("="),n[t[0].trim()]=t[1];return n},n.writeFmtp=function(e){var t="",n=e.payloadType;if(void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var i=[];Object.keys(e.parameters).forEach(function(t){i.push(t+"="+e.parameters[t])}),t+="a=fmtp:"+n+" "+i.join(";")+"\r\n"}return t},n.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},n.writeRtcpFb=function(e){var t="",n=e.payloadType;return void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+n+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"}),t},n.parseSsrcMedia=function(e){var t=e.indexOf(" "),n={ssrc:parseInt(e.substr(7,t-7),10)},i=e.indexOf(":",t);return i>-1?(n.attribute=e.substr(t+1,i-t-1),n.value=e.substr(i+1)):n.attribute=e.substr(t+1),n},n.getMid=function(e){var t=n.matchPrefix(e,"a=mid:")[0];return t?t.substr(6):void 0},n.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},n.getDtlsParameters=function(e,t){var i=n.matchPrefix(e+t,"a=fingerprint:");return{role:"auto",fingerprints:i.map(n.parseFingerprint)}},n.writeDtlsParameters=function(e,t){var n="a=setup:"+t+"\r\n";return e.fingerprints.forEach(function(e){n+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),n},n.getIceParameters=function(e,t){var i=n.splitLines(e);i=i.concat(n.splitLines(t));var r={usernameFragment:i.filter(function(e){return 0===e.indexOf("a=ice-ufrag:")})[0].substr(12),password:i.filter(function(e){return 0===e.indexOf("a=ice-pwd:")})[0].substr(10)};return r},n.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},n.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},i=n.splitLines(e),r=i[0].split(" "),o=3;o<r.length;o++){var a=r[o],s=n.matchPrefix(e,"a=rtpmap:"+a+" ")[0];if(s){var c=n.parseRtpMap(s),d=n.matchPrefix(e,"a=fmtp:"+a+" ");switch(c.parameters=d.length?n.parseFmtp(d[0]):{},c.rtcpFeedback=n.matchPrefix(e,"a=rtcp-fb:"+a+" ").map(n.parseRtcpFb),t.codecs.push(c),c.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(c.name.toUpperCase())}}}return n.matchPrefix(e,"a=extmap:").forEach(function(e){t.headerExtensions.push(n.parseExtmap(e))}),t},n.writeRtpDescription=function(e,t){var i="";i+="m="+e+" ",i+=t.codecs.length>0?"9":"0",i+=" UDP/TLS/RTP/SAVPF ",i+=t.codecs.map(function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType}).join(" ")+"\r\n",i+="c=IN IP4 0.0.0.0\r\n",i+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach(function(e){i+=n.writeRtpMap(e),i+=n.writeFmtp(e),i+=n.writeRtcpFb(e)});var r=0;return t.codecs.forEach(function(e){e.maxptime>r&&(r=e.maxptime)}),r>0&&(i+="a=maxptime:"+r+"\r\n"),i+="a=rtcp-mux\r\n",t.headerExtensions.forEach(function(e){i+=n.writeExtmap(e)}),i},n.parseRtpEncodingParameters=function(e){var t,i=[],r=n.parseRtpParameters(e),o=-1!==r.fecMechanisms.indexOf("RED"),a=-1!==r.fecMechanisms.indexOf("ULPFEC"),s=n.matchPrefix(e,"a=ssrc:").map(function(e){return n.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute}),c=s.length>0&&s[0].ssrc,d=n.matchPrefix(e,"a=ssrc-group:FID").map(function(e){var t=e.split(" ");return t.shift(),t.map(function(e){return parseInt(e,10)})});d.length>0&&d[0].length>1&&d[0][0]===c&&(t=d[0][1]),r.codecs.forEach(function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var n={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10),rtx:{ssrc:t}};i.push(n),o&&(n=JSON.parse(JSON.stringify(n)),n.fec={ssrc:t,mechanism:a?"red+ulpfec":"red"},i.push(n))}}),0===i.length&&c&&i.push({ssrc:c});var l=n.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substr(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substr(5),10)*.95-16e3:void 0,i.forEach(function(e){e.maxBitrate=l})),i},n.parseRtcpParameters=function(e){var t={},i=n.matchPrefix(e,"a=ssrc:").map(function(e){return n.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute})[0];i&&(t.cname=i.value,t.ssrc=i.ssrc);var r=n.matchPrefix(e,"a=rtcp-rsize");t.reducedSize=r.length>0,t.compound=0===r.length;var o=n.matchPrefix(e,"a=rtcp-mux");return t.mux=o.length>0,t},n.parseMsid=function(e){var t,i=n.matchPrefix(e,"a=msid:");if(1===i.length)return t=i[0].substr(7).split(" "),{stream:t[0],track:t[1]};var r=n.matchPrefix(e,"a=ssrc:").map(function(e){return n.parseSsrcMedia(e)}).filter(function(e){return"msid"===e.attribute});return r.length>0?(t=r[0].value.split(" "),{stream:t[0],track:t[1]}):void 0},n.generateSessionId=function(){return Math.random().toString().substr(2,21)},n.writeSessionBoilerplate=function(e,t){var i,r=void 0!==t?t:2;return i=e?e:n.generateSessionId(),"v=0\r\no=thisisadapterortc "+i+" "+r+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},n.writeMediaSection=function(e,t,i,r){var o=n.writeRtpDescription(e.kind,t);if(o+=n.writeIceParameters(e.iceGatherer.getLocalParameters()),o+=n.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===i?"actpass":"active"),o+="a=mid:"+e.mid+"\r\n",o+=e.direction?"a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?"a=sendrecv\r\n":e.rtpSender?"a=sendonly\r\n":e.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",e.rtpSender){var a="msid:"+r.id+" "+e.rtpSender.track.id+"\r\n";o+="a="+a,o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+a,e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+a,o+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+n.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+n.localCName+"\r\n"),o},n.getDirection=function(e,t){for(var i=n.splitLines(e),r=0;r<i.length;r++)switch(i[r]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return i[r].substr(2)}return t?n.getDirection(t):"sendrecv"},n.getKind=function(e){var t=n.splitLines(e),i=t[0].split(" ");return i[0].substr(2)},n.isRejected=function(e){return"0"===e.split(" ",2)[1]},n.parseMLine=function(e){var t=n.splitLines(e),i=t[0].substr(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},n.parseOLine=function(e){var t=n.matchPrefix(e,"o=")[0],i=t.substr(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},"object"==typeof t&&(t.exports=n)},{}],2:[function(e,t){function n(e,t,n,i,r){var o=c.writeRtpDescription(e.kind,t);if(o+=c.writeIceParameters(e.iceGatherer.getLocalParameters()),o+=c.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":r||"active"),o+="a=mid:"+e.mid+"\r\n",o+=e.rtpSender&&e.rtpReceiver?"a=sendrecv\r\n":e.rtpSender?"a=sendonly\r\n":e.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",e.rtpSender){var a=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=a;var s="msid:"+(i?i.id:"-")+" "+a+"\r\n";o+="a="+s,o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+s,e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+s,o+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+c.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+c.localCName+"\r\n"),o}function i(e,t){var n=!1;return e=JSON.parse(JSON.stringify(e)),e.filter(function(e){if(e&&(e.urls||e.url)){var i=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var r="string"==typeof i;return r&&(i=[i]),i=i.filter(function(e){var i=0===e.indexOf("turn:")&&-1!==e.indexOf("transport=udp")&&-1===e.indexOf("turn:[")&&!n;return i?(n=!0,!0):0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp")}),delete e.url,e.urls=r?i[0]:i,!!i.length}})}function r(e,t){var n={codecs:[],headerExtensions:[],fecMechanisms:[]},i=function(e,t){e=parseInt(e,10);for(var n=0;n<t.length;n++)if(t[n].payloadType===e||t[n].preferredPayloadType===e)return t[n]},r=function(e,t,n,r){var o=i(e.parameters.apt,n),a=i(t.parameters.apt,r);return o&&a&&o.name.toLowerCase()===a.name.toLowerCase()};return e.codecs.forEach(function(i){for(var o=0;o<t.codecs.length;o++){var a=t.codecs[o];if(i.name.toLowerCase()===a.name.toLowerCase()&&i.clockRate===a.clockRate){if("rtx"===i.name.toLowerCase()&&i.parameters&&a.parameters.apt&&!r(i,a,e.codecs,t.codecs))continue;a=JSON.parse(JSON.stringify(a)),a.numChannels=Math.min(i.numChannels,a.numChannels),n.codecs.push(a),a.rtcpFeedback=a.rtcpFeedback.filter(function(e){for(var t=0;t<i.rtcpFeedback.length;t++)if(i.rtcpFeedback[t].type===e.type&&i.rtcpFeedback[t].parameter===e.parameter)return!0;return!1});break}}}),e.headerExtensions.forEach(function(e){for(var i=0;i<t.headerExtensions.length;i++){var r=t.headerExtensions[i];if(e.uri===r.uri){n.headerExtensions.push(r);break}}}),n}function o(e,t,n){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(n)}function a(e,t){var n=e.getRemoteCandidates().find(function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type});return n||e.addRemoteCandidate(t),!n}function s(e,t){var n=new Error(t);return n.name=e,n.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],n}var c=e("sdp");t.exports=function(e,t){function d(t,n){n.addTrack(t),n.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function l(t,n){n.removeTrack(t),n.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}))}function u(t,n,i,r){var o=new Event("track");o.track=n,o.receiver=i,o.transceiver={receiver:i},o.streams=r,e.setTimeout(function(){t._dispatchEvent("track",o)})}var p=function(n){var r=this,o=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(e){r[e]=o[e].bind(o)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this.localDescription=null,this.remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",n=JSON.parse(JSON.stringify(n||{})),this.usingBundle="max-bundle"===n.bundlePolicy,"negotiate"===n.rtcpMuxPolicy)throw s("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(n.rtcpMuxPolicy||(n.rtcpMuxPolicy="require"),n.iceTransportPolicy){case"all":case"relay":break;default:n.iceTransportPolicy="all"}switch(n.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:n.bundlePolicy="balanced"}if(n.iceServers=i(n.iceServers||[],t),this._iceGatherers=[],n.iceCandidatePoolSize)for(var a=n.iceCandidatePoolSize;a>0;a--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:n.iceServers,gatherPolicy:n.iceTransportPolicy}));else n.iceCandidatePoolSize=0;this._config=n,this.transceivers=[],this._sdpSessionId=c.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};p.prototype.onicecandidate=null,p.prototype.onaddstream=null,p.prototype.ontrack=null,p.prototype.onremovestream=null,p.prototype.onsignalingstatechange=null,p.prototype.oniceconnectionstatechange=null,p.prototype.onconnectionstatechange=null,p.prototype.onicegatheringstatechange=null,p.prototype.onnegotiationneeded=null,p.prototype.ondatachannel=null,p.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},p.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},p.prototype.getConfiguration=function(){return this._config},p.prototype.getLocalStreams=function(){return this.localStreams},p.prototype.getRemoteStreams=function(){return this.remoteStreams},p.prototype._createTransceiver=function(e,t){var n=this.transceivers.length>0,i={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&n)i.iceTransport=this.transceivers[0].iceTransport,i.dtlsTransport=this.transceivers[0].dtlsTransport;else{var r=this._createIceAndDtlsTransports();i.iceTransport=r.iceTransport,i.dtlsTransport=r.dtlsTransport}return t||this.transceivers.push(i),i},p.prototype.addTrack=function(t,n){if(this._isClosed)throw s("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var i=this.transceivers.find(function(e){return e.track===t});if(i)throw s("InvalidAccessError","Track already exists.");for(var r,o=0;o<this.transceivers.length;o++)this.transceivers[o].track||this.transceivers[o].kind!==t.kind||(r=this.transceivers[o]);return r||(r=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(n)&&this.localStreams.push(n),r.track=t,r.stream=n,r.rtpSender=new e.RTCRtpSender(t,r.dtlsTransport),r.rtpSender},p.prototype.addStream=function(e){var n=this;if(t>=15025)e.getTracks().forEach(function(t){n.addTrack(t,e)});else{var i=e.clone();e.getTracks().forEach(function(e,t){var n=i.getTracks()[t];e.addEventListener("enabled",function(e){n.enabled=e.enabled})}),i.getTracks().forEach(function(e){n.addTrack(e,i)})}},p.prototype.removeTrack=function(t){if(this._isClosed)throw s("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var n=this.transceivers.find(function(e){return e.rtpSender===t});if(!n)throw s("InvalidAccessError","Sender was not created by this connection.");var i=n.stream;n.rtpSender.stop(),n.rtpSender=null,n.track=null,n.stream=null;var r=this.transceivers.map(function(e){return e.stream});-1===r.indexOf(i)&&this.localStreams.indexOf(i)>-1&&this.localStreams.splice(this.localStreams.indexOf(i),1),this._maybeFireNegotiationNeeded()},p.prototype.removeStream=function(e){var t=this;e.getTracks().forEach(function(e){var n=t.getSenders().find(function(t){return t.track===e});n&&t.removeTrack(n)})},p.prototype.getSenders=function(){return this.transceivers.filter(function(e){return!!e.rtpSender}).map(function(e){return e.rtpSender})},p.prototype.getReceivers=function(){return this.transceivers.filter(function(e){return!!e.rtpReceiver}).map(function(e){return e.rtpReceiver})},p.prototype._createIceGatherer=function(t,n){var i=this;if(n&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var r=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(r,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var n=!e.candidate||0===Object.keys(e.candidate).length;r.state=n?"completed":"gathering",null!==i.transceivers[t].bufferedCandidateEvents&&i.transceivers[t].bufferedCandidateEvents.push(e)},r.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),r},p.prototype._gather=function(t,n){var i=this,r=this.transceivers[n].iceGatherer;if(!r.onlocalcandidate){var o=this.transceivers[n].bufferedCandidateEvents;this.transceivers[n].bufferedCandidateEvents=null,r.removeEventListener("localcandidate",this.transceivers[n].bufferCandidates),r.onlocalcandidate=function(e){if(!(i.usingBundle&&n>0)){var o=new Event("icecandidate");o.candidate={sdpMid:t,sdpMLineIndex:n};var a=e.candidate,s=!a||0===Object.keys(a).length;if(s)"new"!==r.state&&"gathering"!==r.state||(r.state="completed");else{"new"===r.state&&(r.state="gathering"),a.component=1;var d=c.writeCandidate(a);o.candidate=Object.assign(o.candidate,c.parseCandidate(d)),o.candidate.candidate=d}var l=c.getMediaSections(i.localDescription.sdp);s?l[o.candidate.sdpMLineIndex]+="a=end-of-candidates\r\n":l[o.candidate.sdpMLineIndex]+="a="+o.candidate.candidate+"\r\n",i.localDescription.sdp=c.getDescription(i.localDescription.sdp)+l.join("");var u=i.transceivers.every(function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state});"gathering"!==i.iceGatheringState&&(i.iceGatheringState="gathering",i._emitGatheringStateChange()),s||i._dispatchEvent("icecandidate",o),u&&(i._dispatchEvent("icecandidate",new Event("icecandidate")),i.iceGatheringState="complete",i._emitGatheringStateChange())}},e.setTimeout(function(){o.forEach(function(e){r.onlocalcandidate(e)})},0)}},p.prototype._createIceAndDtlsTransports=function(){var t=this,n=new e.RTCIceTransport(null);n.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState()};var i=new e.RTCDtlsTransport(n);return i.ondtlsstatechange=function(){t._updateConnectionState()},i.onerror=function(){Object.defineProperty(i,"state",{value:"failed",writable:!0}),t._updateConnectionState()},{iceTransport:n,dtlsTransport:i}},p.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var n=this.transceivers[e].iceTransport;n&&(delete n.onicestatechange,delete this.transceivers[e].iceTransport);var i=this.transceivers[e].dtlsTransport;i&&(delete i.ondtlsstatechange,delete i.onerror,delete this.transceivers[e].dtlsTransport)},p.prototype._transceive=function(e,n,i){var o=r(e.localCapabilities,e.remoteCapabilities);n&&e.rtpSender&&(o.encodings=e.sendEncodingParameters,o.rtcp={cname:c.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(o.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(o)),i&&e.rtpReceiver&&o.codecs.length>0&&("video"===e.kind&&e.recvEncodingParameters&&15019>t&&e.recvEncodingParameters.forEach(function(e){delete e.rtx}),e.recvEncodingParameters.length?o.encodings=e.recvEncodingParameters:o.encodings=[{}],o.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(o.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(o.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(o))},p.prototype.setLocalDescription=function(e){var t=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(s("TypeError",'Unsupported type "'+e.type+'"'));if(!o("setLocalDescription",e.type,t.signalingState)||t._isClosed)return Promise.reject(s("InvalidStateError","Can not set local "+e.type+" in state "+t.signalingState));var n,i;if("offer"===e.type)n=c.splitSections(e.sdp),i=n.shift(),n.forEach(function(e,n){var i=c.parseRtpParameters(e);t.transceivers[n].localCapabilities=i}),t.transceivers.forEach(function(e,n){t._gather(e.mid,n)});else if("answer"===e.type){n=c.splitSections(t.remoteDescription.sdp),i=n.shift();var a=c.matchPrefix(i,"a=ice-lite").length>0;n.forEach(function(e,n){var o=t.transceivers[n],s=o.iceGatherer,d=o.iceTransport,l=o.dtlsTransport,u=o.localCapabilities,p=o.remoteCapabilities,h=c.isRejected(e)&&0===c.matchPrefix(e,"a=bundle-only").length;if(!h&&!o.rejected){var f=c.getIceParameters(e,i),m=c.getDtlsParameters(e,i);a&&(m.role="server"),t.usingBundle&&0!==n||(t._gather(o.mid,n),"new"===d.state&&d.start(s,f,a?"controlling":"controlled"),"new"===l.state&&l.start(m));var v=r(u,p);t._transceive(o,v.codecs.length>0,!1)}})}return t.localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?t._updateSignalingState("have-local-offer"):t._updateSignalingState("stable"),Promise.resolve()},p.prototype.setRemoteDescription=function(n){var i=this;if(-1===["offer","answer"].indexOf(n.type))return Promise.reject(s("TypeError",'Unsupported type "'+n.type+'"'));if(!o("setRemoteDescription",n.type,i.signalingState)||i._isClosed)return Promise.reject(s("InvalidStateError","Can not set remote "+n.type+" in state "+i.signalingState));var r={};i.remoteStreams.forEach(function(e){r[e.id]=e});var p=[],h=c.splitSections(n.sdp),f=h.shift(),m=c.matchPrefix(f,"a=ice-lite").length>0,v=c.matchPrefix(f,"a=group:BUNDLE ").length>0;i.usingBundle=v;var _=c.matchPrefix(f,"a=ice-options:")[0];return _?i.canTrickleIceCandidates=_.substr(14).split(" ").indexOf("trickle")>=0:i.canTrickleIceCandidates=!1,h.forEach(function(o,s){var u=c.splitLines(o),h=c.getKind(o),_=c.isRejected(o)&&0===c.matchPrefix(o,"a=bundle-only").length,g=u[0].substr(2).split(" ")[2],y=c.getDirection(o,f),S=c.parseMsid(o),C=c.getMid(o)||c.generateIdentifier();if("application"===h&&"DTLS/SCTP"===g||_)return void(i.transceivers[s]={mid:C,kind:h,rejected:!0});!_&&i.transceivers[s]&&i.transceivers[s].rejected&&(i.transceivers[s]=i._createTransceiver(h,!0));var b,w,T,R,k,E,P,I,x,O,L,D=c.parseRtpParameters(o);_||(O=c.getIceParameters(o,f),L=c.getDtlsParameters(o,f),L.role="client"),P=c.parseRtpEncodingParameters(o);var A=c.parseRtcpParameters(o),M=c.matchPrefix(o,"a=end-of-candidates",f).length>0,N=c.matchPrefix(o,"a=candidate:").map(function(e){return c.parseCandidate(e)}).filter(function(e){return 1===e.component});if(("offer"===n.type||"answer"===n.type)&&!_&&v&&s>0&&i.transceivers[s]&&(i._disposeIceAndDtlsTransports(s),i.transceivers[s].iceGatherer=i.transceivers[0].iceGatherer,i.transceivers[s].iceTransport=i.transceivers[0].iceTransport,i.transceivers[s].dtlsTransport=i.transceivers[0].dtlsTransport,i.transceivers[s].rtpSender&&i.transceivers[s].rtpSender.setTransport(i.transceivers[0].dtlsTransport),i.transceivers[s].rtpReceiver&&i.transceivers[s].rtpReceiver.setTransport(i.transceivers[0].dtlsTransport)),"offer"!==n.type||_)"answer"!==n.type||_||(b=i.transceivers[s],w=b.iceGatherer,T=b.iceTransport,R=b.dtlsTransport,k=b.rtpReceiver,E=b.sendEncodingParameters,I=b.localCapabilities,i.transceivers[s].recvEncodingParameters=P,i.transceivers[s].remoteCapabilities=D,i.transceivers[s].rtcpParameters=A,N.length&&"new"===T.state&&(!m&&!M||v&&0!==s?N.forEach(function(e){a(b.iceTransport,e)}):T.setRemoteCandidates(N)),v&&0!==s||("new"===T.state&&T.start(w,O,"controlling"),"new"===R.state&&R.start(L)),i._transceive(b,"sendrecv"===y||"recvonly"===y,"sendrecv"===y||"sendonly"===y),!k||"sendrecv"!==y&&"sendonly"!==y?delete b.rtpReceiver:(x=k.track,S?(r[S.stream]||(r[S.stream]=new e.MediaStream),d(x,r[S.stream]),p.push([x,k,r[S.stream]])):(r["default"]||(r["default"]=new e.MediaStream),d(x,r["default"]),p.push([x,k,r["default"]]))));else{b=i.transceivers[s]||i._createTransceiver(h),b.mid=C,b.iceGatherer||(b.iceGatherer=i._createIceGatherer(s,v)),N.length&&"new"===b.iceTransport.state&&(!M||v&&0!==s?N.forEach(function(e){a(b.iceTransport,e)}):b.iceTransport.setRemoteCandidates(N)),I=e.RTCRtpReceiver.getCapabilities(h),15019>t&&(I.codecs=I.codecs.filter(function(e){return"rtx"!==e.name})),E=b.sendEncodingParameters||[{ssrc:1001*(2*s+2)}];var B=!1;if("sendrecv"===y||"sendonly"===y){if(B=!b.rtpReceiver,k=b.rtpReceiver||new e.RTCRtpReceiver(b.dtlsTransport,h),B){var j;x=k.track,S&&"-"===S.stream||(S?(r[S.stream]||(r[S.stream]=new e.MediaStream,Object.defineProperty(r[S.stream],"id",{get:function(){return S.stream}})),Object.defineProperty(x,"id",{get:function(){return S.track}}),j=r[S.stream]):(r["default"]||(r["default"]=new e.MediaStream),j=r["default"])),j&&(d(x,j),b.associatedRemoteMediaStreams.push(j)),p.push([x,k,j])}}else b.rtpReceiver&&b.rtpReceiver.track&&(b.associatedRemoteMediaStreams.forEach(function(e){var t=e.getTracks().find(function(e){return e.id===b.rtpReceiver.track.id});t&&l(t,e)}),b.associatedRemoteMediaStreams=[]);b.localCapabilities=I,b.remoteCapabilities=D,b.rtpReceiver=k,b.rtcpParameters=A,b.sendEncodingParameters=E,b.recvEncodingParameters=P,i._transceive(i.transceivers[s],!1,B)}}),void 0===i._dtlsRole&&(i._dtlsRole="offer"===n.type?"active":"passive"),i.remoteDescription={type:n.type,sdp:n.sdp},"offer"===n.type?i._updateSignalingState("have-remote-offer"):i._updateSignalingState("stable"),Object.keys(r).forEach(function(t){var n=r[t];if(n.getTracks().length){if(-1===i.remoteStreams.indexOf(n)){i.remoteStreams.push(n);var o=new Event("addstream");o.stream=n,e.setTimeout(function(){i._dispatchEvent("addstream",o)})}p.forEach(function(e){var t=e[0],r=e[1];n.id===e[2].id&&u(i,t,r,[n])})}}),p.forEach(function(e){e[2]||u(i,e[0],e[1],[])}),e.setTimeout(function(){i&&i.transceivers&&i.transceivers.forEach(function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))})},4e3),Promise.resolve()},p.prototype.close=function(){this.transceivers.forEach(function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState("closed")},p.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},p.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&this.needNegotiation!==!0&&(this.needNegotiation=!0,e.setTimeout(function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}},0))},p.prototype._updateIceConnectionState=function(){var e,t={"new":0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(e){t[e.iceTransport.state]++}),e="new",t.failed>0?e="failed":t.checking>0?e="checking":t.disconnected>0?e="disconnected":t["new"]>0?e="new":t.connected>0?e="connected":t.completed>0&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var n=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",n)}},p.prototype._updateConnectionState=function(){var e,t={"new":0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(e){t[e.iceTransport.state]++,t[e.dtlsTransport.state]++}),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0?e="connecting":t.disconnected>0?e="disconnected":t["new"]>0?e="new":t.connected>0&&(e="connected"),e!==this.connectionState){this.connectionState=e;var n=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",n)}},p.prototype.createOffer=function(){var i=this;if(i._isClosed)return Promise.reject(s("InvalidStateError","Can not call createOffer after close"));var r=i.transceivers.filter(function(e){return"audio"===e.kind}).length,o=i.transceivers.filter(function(e){return"video"===e.kind}).length,a=arguments[0];if(a){if(a.mandatory||a.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==a.offerToReceiveAudio&&(r=a.offerToReceiveAudio===!0?1:a.offerToReceiveAudio===!1?0:a.offerToReceiveAudio),void 0!==a.offerToReceiveVideo&&(o=a.offerToReceiveVideo===!0?1:a.offerToReceiveVideo===!1?0:a.offerToReceiveVideo)}for(i.transceivers.forEach(function(e){"audio"===e.kind?(r--,0>r&&(e.wantReceive=!1)):"video"===e.kind&&(o--,0>o&&(e.wantReceive=!1))});r>0||o>0;)r>0&&(i._createTransceiver("audio"),r--),o>0&&(i._createTransceiver("video"),o--);var d=c.writeSessionBoilerplate(i._sdpSessionId,i._sdpSessionVersion++);i.transceivers.forEach(function(n,r){var o=n.track,a=n.kind,s=n.mid||c.generateIdentifier();n.mid=s,n.iceGatherer||(n.iceGatherer=i._createIceGatherer(r,i.usingBundle));var d=e.RTCRtpSender.getCapabilities(a);15019>t&&(d.codecs=d.codecs.filter(function(e){return"rtx"!==e.name})),d.codecs.forEach(function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),n.remoteCapabilities&&n.remoteCapabilities.codecs&&n.remoteCapabilities.codecs.forEach(function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)})}),d.headerExtensions.forEach(function(e){var t=n.remoteCapabilities&&n.remoteCapabilities.headerExtensions||[];t.forEach(function(t){e.uri===t.uri&&(e.id=t.id)})});var l=n.sendEncodingParameters||[{ssrc:1001*(2*r+1)}];o&&t>=15019&&"video"===a&&!l[0].rtx&&(l[0].rtx={ssrc:l[0].ssrc+1}),n.wantReceive&&(n.rtpReceiver=new e.RTCRtpReceiver(n.dtlsTransport,a)),n.localCapabilities=d,n.sendEncodingParameters=l}),"max-compat"!==i._config.bundlePolicy&&(d+="a=group:BUNDLE "+i.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),d+="a=ice-options:trickle\r\n",i.transceivers.forEach(function(e,t){d+=n(e,e.localCapabilities,"offer",e.stream,i._dtlsRole),d+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===i.iceGatheringState||0!==t&&i.usingBundle||(e.iceGatherer.getLocalCandidates().forEach(function(e){e.component=1,d+="a="+c.writeCandidate(e)+"\r\n"}),"completed"===e.iceGatherer.state&&(d+="a=end-of-candidates\r\n"))});var l=new e.RTCSessionDescription({type:"offer",sdp:d});return Promise.resolve(l)},p.prototype.createAnswer=function(){var i=this;if(i._isClosed)return Promise.reject(s("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==i.signalingState&&"have-local-pranswer"!==i.signalingState)return Promise.reject(s("InvalidStateError","Can not call createAnswer in signalingState "+i.signalingState));
var o=c.writeSessionBoilerplate(i._sdpSessionId,i._sdpSessionVersion++);i.usingBundle&&(o+="a=group:BUNDLE "+i.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n");var a=c.getMediaSections(i.remoteDescription.sdp).length;i.transceivers.forEach(function(e,s){if(!(s+1>a)){if(e.rejected)return"application"===e.kind?o+="m=application 0 DTLS/SCTP 5000\r\n":"audio"===e.kind?o+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(o+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(o+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");if(e.stream){var c;"audio"===e.kind?c=e.stream.getAudioTracks()[0]:"video"===e.kind&&(c=e.stream.getVideoTracks()[0]),c&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1})}var d=r(e.localCapabilities,e.remoteCapabilities),l=d.codecs.filter(function(e){return"rtx"===e.name.toLowerCase()}).length;!l&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,o+=n(e,d,"answer",e.stream,i._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(o+="a=rtcp-rsize\r\n")}});var d=new e.RTCSessionDescription({type:"answer",sdp:o});return Promise.resolve(d)},p.prototype.addIceCandidate=function(e){var t,n=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(i,r){if(!n.remoteDescription)return r(s("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var o=e.sdpMLineIndex;if(e.sdpMid)for(var d=0;d<n.transceivers.length;d++)if(n.transceivers[d].mid===e.sdpMid){o=d;break}var l=n.transceivers[o];if(!l)return r(s("OperationError","Can not add ICE candidate"));if(l.rejected)return i();var u=Object.keys(e.candidate).length>0?c.parseCandidate(e.candidate):{};if("tcp"===u.protocol&&(0===u.port||9===u.port))return i();if(u.component&&1!==u.component)return i();if((0===o||o>0&&l.iceTransport!==n.transceivers[0].iceTransport)&&!a(l.iceTransport,u))return r(s("OperationError","Can not add ICE candidate"));var p=e.candidate.trim();0===p.indexOf("a=")&&(p=p.substr(2)),t=c.getMediaSections(n.remoteDescription.sdp),t[o]+="a="+(u.type?p:"end-of-candidates")+"\r\n",n.remoteDescription.sdp=t.join("")}else for(var h=0;h<n.transceivers.length&&(n.transceivers[h].rejected||(n.transceivers[h].iceTransport.addRemoteCandidate({}),t=c.getMediaSections(n.remoteDescription.sdp),t[h]+="a=end-of-candidates\r\n",n.remoteDescription.sdp=c.getDescription(n.remoteDescription.sdp)+t.join(""),!n.usingBundle));h++);i()})},p.prototype.getStats=function(){var e=[];this.transceivers.forEach(function(t){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(n){t[n]&&e.push(t[n].getStats())})});var t=function(e){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};return new Promise(function(n){var i=new Map;Promise.all(e).then(function(e){e.forEach(function(e){Object.keys(e).forEach(function(n){e[n].type=t(e[n]),i.set(n,e[n])})}),n(i)})})};var h=["createOffer","createAnswer"];return h.forEach(function(e){var t=p.prototype[e];p.prototype[e]=function(){var e=arguments;return"function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then(function(t){"function"==typeof e[0]&&e[0].apply(null,[t])},function(t){"function"==typeof e[1]&&e[1].apply(null,[t])}):t.apply(this,arguments)}}),h=["setLocalDescription","setRemoteDescription","addIceCandidate"],h.forEach(function(e){var t=p.prototype[e];p.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then(function(){"function"==typeof e[1]&&e[1].apply(null)},function(t){"function"==typeof e[2]&&e[2].apply(null,[t])}):t.apply(this,arguments)}}),["getStats"].forEach(function(e){var t=p.prototype[e];p.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then(function(){"function"==typeof e[1]&&e[1].apply(null)}):t.apply(this,arguments)}}),p}},{sdp:1}],3:[function(e,t,n){arguments[4][1][0].apply(n,arguments)},{dup:1}],4:[function(e,t){(function(n){var i=e("./adapter_factory.js");t.exports=i({window:n.window})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./adapter_factory.js":5}],5:[function(e,t){var n=e("./utils");t.exports=function(t,i){var r=t&&t.window,o={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0};for(var a in i)hasOwnProperty.call(i,a)&&(o[a]=i[a]);var s=n.log,c=n.detectBrowser(r),d=e("./chrome/chrome_shim")||null,l=e("./edge/edge_shim")||null,u=e("./firefox/firefox_shim")||null,p=e("./safari/safari_shim")||null,h=e("./common_shim")||null,f={browserDetails:c,commonShim:h,extractVersion:n.extractVersion,disableLog:n.disableLog,disableWarnings:n.disableWarnings};switch(c.browser){case"chrome":if(!d||!d.shimPeerConnection||!o.shimChrome)return s("Chrome shim is not included in this adapter release."),f;s("adapter.js shimming chrome."),f.browserShim=d,h.shimCreateObjectURL(r),d.shimGetUserMedia(r),d.shimMediaStream(r),d.shimSourceObject(r),d.shimPeerConnection(r),d.shimOnTrack(r),d.shimAddTrackRemoveTrack(r),d.shimGetSendersWithDtmf(r),h.shimRTCIceCandidate(r),h.shimMaxMessageSize(r),h.shimSendThrowTypeError(r);break;case"firefox":if(!u||!u.shimPeerConnection||!o.shimFirefox)return s("Firefox shim is not included in this adapter release."),f;s("adapter.js shimming firefox."),f.browserShim=u,h.shimCreateObjectURL(r),u.shimGetUserMedia(r),u.shimSourceObject(r),u.shimPeerConnection(r),u.shimOnTrack(r),u.shimRemoveStream(r),h.shimRTCIceCandidate(r),h.shimMaxMessageSize(r),h.shimSendThrowTypeError(r);break;case"edge":if(!l||!l.shimPeerConnection||!o.shimEdge)return s("MS edge shim is not included in this adapter release."),f;s("adapter.js shimming edge."),f.browserShim=l,h.shimCreateObjectURL(r),l.shimGetUserMedia(r),l.shimPeerConnection(r),l.shimReplaceTrack(r),h.shimMaxMessageSize(r),h.shimSendThrowTypeError(r);break;case"safari":if(!p||!o.shimSafari)return s("Safari shim is not included in this adapter release."),f;s("adapter.js shimming safari."),f.browserShim=p,h.shimCreateObjectURL(r),p.shimRTCIceServerUrls(r),p.shimCallbacksAPI(r),p.shimLocalStreamsAPI(r),p.shimRemoteStreamsAPI(r),p.shimTrackEventTransceiver(r),p.shimGetUserMedia(r),p.shimCreateOfferLegacy(r),h.shimRTCIceCandidate(r),h.shimMaxMessageSize(r),h.shimSendThrowTypeError(r);break;default:s("Unsupported browser!")}return f}},{"./chrome/chrome_shim":6,"./common_shim":8,"./edge/edge_shim":9,"./firefox/firefox_shim":11,"./safari/safari_shim":13,"./utils":14}],6:[function(e,t){var n=e("../utils.js"),i=n.log;t.exports={shimGetUserMedia:e("./getusermedia"),shimMediaStream:function(e){e.MediaStream=e.MediaStream||e.webkitMediaStream},shimOnTrack:function(e){if("object"!=typeof e||!e.RTCPeerConnection||"ontrack"in e.RTCPeerConnection.prototype)"RTCRtpTransceiver"in e||n.wrapPeerConnectionEvent(e,"track",function(e){return e.transceiver||(e.transceiver={receiver:e.receiver}),e});else{Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)}});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var n=this;return n._ontrackpoly||(n._ontrackpoly=function(t){t.stream.addEventListener("addtrack",function(i){var r;r=e.RTCPeerConnection.prototype.getReceivers?n.getReceivers().find(function(e){return e.track&&e.track.id===i.track.id}):{track:i.track};var o=new Event("track");o.track=i.track,o.receiver=r,o.transceiver={receiver:r},o.streams=[t.stream],n.dispatchEvent(o)}),t.stream.getTracks().forEach(function(i){var r;r=e.RTCPeerConnection.prototype.getReceivers?n.getReceivers().find(function(e){return e.track&&e.track.id===i.id}):{track:i};var o=new Event("track");o.track=i,o.receiver=r,o.transceiver={receiver:r},o.streams=[t.stream],n.dispatchEvent(o)})},n.addEventListener("addstream",n._ontrackpoly)),t.apply(n,arguments)}}},shimGetSendersWithDtmf:function(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){var t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};var n=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e){var i=this,r=n.apply(i,arguments);return r||(r=t(i,e),i._senders.push(r)),r};var i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;i.apply(t,arguments);var n=t._senders.indexOf(e);-1!==n&&t._senders.splice(n,1)}}var r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var n=this;n._senders=n._senders||[],r.apply(n,[e]),e.getTracks().forEach(function(e){n._senders.push(t(n,e))})};var o=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;t._senders=t._senders||[],o.apply(t,[e]),e.getTracks().forEach(function(e){var n=t._senders.find(function(t){return t.track===e});n&&t._senders.splice(t._senders.indexOf(n),1)})}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){var a=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){var e=this,t=a.apply(e,[]);return t.forEach(function(t){t._pc=e}),t},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}},shimSourceObject:function(e){var t=e&&e.URL;"object"==typeof e&&(!e.HTMLMediaElement||"srcObject"in e.HTMLMediaElement.prototype||Object.defineProperty(e.HTMLMediaElement.prototype,"srcObject",{get:function(){return this._srcObject},set:function(e){var n=this;return this._srcObject=e,this.src&&t.revokeObjectURL(this.src),e?(this.src=t.createObjectURL(e),e.addEventListener("addtrack",function(){n.src&&t.revokeObjectURL(n.src),n.src=t.createObjectURL(e)}),void e.addEventListener("removetrack",function(){n.src&&t.revokeObjectURL(n.src),n.src=t.createObjectURL(e)})):void(this.src="")}}))},shimAddTrackRemoveTrackWithNative:function(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(function(t){return e._shimmedLocalStreams[t][0]})};var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){if(!n)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};var i=t.apply(this,arguments);return this._shimmedLocalStreams[n.id]?-1===this._shimmedLocalStreams[n.id].indexOf(i)&&this._shimmedLocalStreams[n.id].push(i):this._shimmedLocalStreams[n.id]=[n,i],i};var n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var t=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach(function(e){var n=t.getSenders().find(function(t){return t.track===e});if(n)throw new DOMException("Track already exists.","InvalidAccessError")});var i=t.getSenders();n.apply(this,arguments);var r=t.getSenders().filter(function(e){return-1===i.indexOf(e)});this._shimmedLocalStreams[e.id]=[e].concat(r)};var i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],i.apply(this,arguments)};var r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach(function(n){var i=t._shimmedLocalStreams[n].indexOf(e);-1!==i&&t._shimmedLocalStreams[n].splice(i,1),1===t._shimmedLocalStreams[n].length&&delete t._shimmedLocalStreams[n]}),r.apply(this,arguments)}},shimAddTrackRemoveTrack:function(e){function t(e,t){var n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(function(t){var i=e._reverseStreams[t],r=e._streams[i.id];n=n.replace(new RegExp(r.id,"g"),i.id)}),new RTCSessionDescription({type:t.type,sdp:n})}function i(e,t){var n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(function(t){var i=e._reverseStreams[t],r=e._streams[i.id];n=n.replace(new RegExp(i.id,"g"),r.id)}),new RTCSessionDescription({type:t.type,sdp:n})}var r=n.detectBrowser(e);if(e.RTCPeerConnection.prototype.addTrack&&r.version>=65)return this.shimAddTrackRemoveTrackWithNative(e);var o=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this,t=o.apply(this);return e._reverseStreams=e._reverseStreams||{},t.map(function(t){return e._reverseStreams[t.id]})};var a=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){var n=this;if(n._streams=n._streams||{},n._reverseStreams=n._reverseStreams||{},t.getTracks().forEach(function(e){var t=n.getSenders().find(function(t){return t.track===e});if(t)throw new DOMException("Track already exists.","InvalidAccessError")}),!n._reverseStreams[t.id]){var i=new e.MediaStream(t.getTracks());n._streams[t.id]=i,n._reverseStreams[i.id]=t,t=i}a.apply(n,[t])};var s=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;t._streams=t._streams||{},t._reverseStreams=t._reverseStreams||{},s.apply(t,[t._streams[e.id]||e]),delete t._reverseStreams[t._streams[e.id]?t._streams[e.id].id:e.id],delete t._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,n){var i=this;if("closed"===i.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var r=[].slice.call(arguments,1);if(1!==r.length||!r[0].getTracks().find(function(e){return e===t}))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");var o=i.getSenders().find(function(e){return e.track===t});if(o)throw new DOMException("Track already exists.","InvalidAccessError");i._streams=i._streams||{},i._reverseStreams=i._reverseStreams||{};var a=i._streams[n.id];if(a)a.addTrack(t),Promise.resolve().then(function(){i.dispatchEvent(new Event("negotiationneeded"))});else{var s=new e.MediaStream([t]);i._streams[n.id]=s,i._reverseStreams[s.id]=n,i.addStream(s)}return i.getSenders().find(function(e){return e.track===t})},["createOffer","createAnswer"].forEach(function(n){var i=e.RTCPeerConnection.prototype[n];e.RTCPeerConnection.prototype[n]=function(){var e=this,n=arguments,r=arguments.length&&"function"==typeof arguments[0];return r?i.apply(e,[function(i){var r=t(e,i);n[0].apply(null,[r])},function(e){n[1]&&n[1].apply(null,e)},arguments[2]]):i.apply(e,arguments).then(function(n){return t(e,n)})}});var c=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){var e=this;return arguments.length&&arguments[0].type?(arguments[0]=i(e,arguments[0]),c.apply(e,arguments)):c.apply(e,arguments)};var d=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get:function(){var e=this,n=d.get.apply(this);return""===n.type?n:t(e,n)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;if("closed"===t.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");var n=e._pc===t;if(!n)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");t._streams=t._streams||{};var i;Object.keys(t._streams).forEach(function(n){var r=t._streams[n].getTracks().find(function(t){return e.track===t});r&&(i=t._streams[n])}),i&&(1===i.getTracks().length?t.removeStream(t._reverseStreams[i.id]):i.removeTrack(e.track),t.dispatchEvent(new Event("negotiationneeded")))}},shimPeerConnection:function(e){var t=n.detectBrowser(e);if(!e.RTCPeerConnection&&e.webkitRTCPeerConnection)e.RTCPeerConnection=function(t,n){return i("PeerConnection"),t&&t.iceTransportPolicy&&(t.iceTransports=t.iceTransportPolicy),new e.webkitRTCPeerConnection(t,n)},e.RTCPeerConnection.prototype=e.webkitRTCPeerConnection.prototype,e.webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return e.webkitRTCPeerConnection.generateCertificate}});else{var r=e.RTCPeerConnection;e.RTCPeerConnection=function(e,t){if(e&&e.iceServers){for(var i=[],o=0;o<e.iceServers.length;o++){var a=e.iceServers[o];!a.hasOwnProperty("urls")&&a.hasOwnProperty("url")?(n.deprecated("RTCIceServer.url","RTCIceServer.urls"),a=JSON.parse(JSON.stringify(a)),a.urls=a.url,i.push(a)):i.push(e.iceServers[o])}e.iceServers=i}return new r(e,t)},e.RTCPeerConnection.prototype=r.prototype,Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return r.generateCertificate}})}var o=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,t,n){var i=this,r=arguments;if(arguments.length>0&&"function"==typeof e)return o.apply(this,arguments);if(0===o.length&&(0===arguments.length||"function"!=typeof arguments[0]))return o.apply(this,[]);var a=function(e){var t={},n=e.result();return n.forEach(function(e){var n={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach(function(t){n[t]=e.stat(t)}),t[n.id]=n}),t},s=function(e){return new Map(Object.keys(e).map(function(t){return[t,e[t]]}))};if(arguments.length>=2){var c=function(e){r[1](s(a(e)))};return o.apply(this,[c,arguments[0]])}return new Promise(function(e,t){o.apply(i,[function(t){e(s(a(t)))},t])}).then(t,n)},t.version<51&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){var n=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){var e=arguments,t=this,i=new Promise(function(i,r){n.apply(t,[e[0],i,r])});return e.length<2?i:i.then(function(){e[1].apply(null,[])},function(t){e.length>=3&&e[2].apply(null,[t])})}}),t.version<52&&["createOffer","createAnswer"].forEach(function(t){var n=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){var e=this;if(arguments.length<1||1===arguments.length&&"object"==typeof arguments[0]){var t=1===arguments.length?arguments[0]:void 0;return new Promise(function(i,r){n.apply(e,[i,r,t])})}return n.apply(this,arguments)}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){var n=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}});var a=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?a.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}}},{"../utils.js":14,"./getusermedia":7}],7:[function(e,t){var n=e("../utils.js"),i=n.log;t.exports=function(e){var t=n.detectBrowser(e),r=e&&e.navigator,o=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach(function(n){if("require"!==n&&"advanced"!==n&&"mediaSource"!==n){var i="object"==typeof e[n]?e[n]:{ideal:e[n]};void 0!==i.exact&&"number"==typeof i.exact&&(i.min=i.max=i.exact);var r=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==i.ideal){t.optional=t.optional||[];var o={};"number"==typeof i.ideal?(o[r("min",n)]=i.ideal,t.optional.push(o),o={},o[r("max",n)]=i.ideal,t.optional.push(o)):(o[r("",n)]=i.ideal,t.optional.push(o))}void 0!==i.exact&&"number"!=typeof i.exact?(t.mandatory=t.mandatory||{},t.mandatory[r("",n)]=i.exact):["min","max"].forEach(function(e){void 0!==i[e]&&(t.mandatory=t.mandatory||{},t.mandatory[r(e,n)]=i[e])})}}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},a=function(e,n){if(t.version>=61)return n(e);if(e=JSON.parse(JSON.stringify(e)),e&&"object"==typeof e.audio){var a=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])};e=JSON.parse(JSON.stringify(e)),a(e.audio,"autoGainControl","googAutoGainControl"),a(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=o(e.audio)}if(e&&"object"==typeof e.video){var s=e.video.facingMode;s=s&&("object"==typeof s?s:{ideal:s});var c=t.version<66;if(s&&("user"===s.exact||"environment"===s.exact||"user"===s.ideal||"environment"===s.ideal)&&(!r.mediaDevices.getSupportedConstraints||!r.mediaDevices.getSupportedConstraints().facingMode||c)){delete e.video.facingMode;var d;if("environment"===s.exact||"environment"===s.ideal?d=["back","rear"]:"user"!==s.exact&&"user"!==s.ideal||(d=["front"]),d)return r.mediaDevices.enumerateDevices().then(function(t){t=t.filter(function(e){return"videoinput"===e.kind});var r=t.find(function(e){return d.some(function(t){return-1!==e.label.toLowerCase().indexOf(t)})});return!r&&t.length&&-1!==d.indexOf("back")&&(r=t[t.length-1]),r&&(e.video.deviceId=s.exact?{exact:r.deviceId}:{ideal:r.deviceId}),e.video=o(e.video),i("chrome: "+JSON.stringify(e)),n(e)})}e.video=o(e.video)}return i("chrome: "+JSON.stringify(e)),n(e)},s=function(e){return{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}},c=function(e,t,n){a(e,function(e){r.webkitGetUserMedia(e,t,function(e){n&&n(s(e))})})};r.getUserMedia=c;var d=function(e){return new Promise(function(t,n){r.getUserMedia(e,t,n)})};if(r.mediaDevices||(r.mediaDevices={getUserMedia:d,enumerateDevices:function(){return new Promise(function(t){var n={audio:"audioinput",video:"videoinput"};return e.MediaStreamTrack.getSources(function(e){t(e.map(function(e){return{label:e.label,kind:n[e.kind],deviceId:e.id,groupId:""}}))})})},getSupportedConstraints:function(){return{deviceId:!0,echoCancellation:!0,facingMode:!0,frameRate:!0,height:!0,width:!0}}}),r.mediaDevices.getUserMedia){var l=r.mediaDevices.getUserMedia.bind(r.mediaDevices);r.mediaDevices.getUserMedia=function(e){return a(e,function(e){return l(e).then(function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach(function(e){e.stop()}),new DOMException("","NotFoundError");return t},function(e){return Promise.reject(s(e))})})}}else r.mediaDevices.getUserMedia=function(e){return d(e)};"undefined"==typeof r.mediaDevices.addEventListener&&(r.mediaDevices.addEventListener=function(){i("Dummy mediaDevices.addEventListener called.")}),"undefined"==typeof r.mediaDevices.removeEventListener&&(r.mediaDevices.removeEventListener=function(){i("Dummy mediaDevices.removeEventListener called.")})}},{"../utils.js":14}],8:[function(e,t){var n=e("sdp"),i=e("./utils");t.exports={shimRTCIceCandidate:function(e){if(!(e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)){var t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&(e=JSON.parse(JSON.stringify(e)),e.candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){var i=new t(e),r=n.parseCandidate(e.candidate),o=Object.assign(i,r);return o.toJSON=function(){return{candidate:o.candidate,sdpMid:o.sdpMid,sdpMLineIndex:o.sdpMLineIndex,usernameFragment:o.usernameFragment}},o}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,i.wrapPeerConnectionEvent(e,"icecandidate",function(t){return t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t})}},shimCreateObjectURL:function(e){var t=e&&e.URL;if("object"==typeof e&&e.HTMLMediaElement&&"srcObject"in e.HTMLMediaElement.prototype&&t.createObjectURL&&t.revokeObjectURL){var n=t.createObjectURL.bind(t),r=t.revokeObjectURL.bind(t),o=new Map,a=0;t.createObjectURL=function(e){if("getTracks"in e){var t="polyblob:"+ ++a;return o.set(t,e),i.deprecated("URL.createObjectURL(stream)","elem.srcObject = stream"),t}return n(e)},t.revokeObjectURL=function(e){r(e),o["delete"](e)};var s=Object.getOwnPropertyDescriptor(e.HTMLMediaElement.prototype,"src");Object.defineProperty(e.HTMLMediaElement.prototype,"src",{get:function(){return s.get.apply(this)},set:function(e){return this.srcObject=o.get(e)||null,s.set.apply(this,[e])}});var c=e.HTMLMediaElement.prototype.setAttribute;e.HTMLMediaElement.prototype.setAttribute=function(){return 2===arguments.length&&"src"===(""+arguments[0]).toLowerCase()&&(this.srcObject=o.get(arguments[1])||null),c.apply(this,arguments)}}},shimMaxMessageSize:function(e){if(!e.RTCSctpTransport&&e.RTCPeerConnection){var t=i.detectBrowser(e);"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get:function(){return"undefined"==typeof this._sctp?null:this._sctp}});var r=function(e){var t=n.splitSections(e.sdp);return t.shift(),t.some(function(e){var t=n.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")})},o=function(e){var t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;var n=parseInt(t[1],10);return n!==n?-1:n},a=function(e){var n=65536;return"firefox"===t.browser&&(n=t.version<57?-1===e?16384:2147483637:57===t.version?65535:65536),n},s=function(e,i){var r=65536;"firefox"===t.browser&&57===t.version&&(r=65535);var o=n.matchPrefix(e.sdp,"a=max-message-size:");return o.length>0?r=parseInt(o[0].substr(19),10):"firefox"===t.browser&&-1!==i&&(r=2147483637),r},c=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e=this;if(e._sctp=null,r(arguments[0])){var t,n=o(arguments[0]),i=a(n),d=s(arguments[0],n);t=0===i&&0===d?Number.POSITIVE_INFINITY:0===i||0===d?Math.max(i,d):Math.min(i,d);var l={};Object.defineProperty(l,"maxMessageSize",{get:function(){return t}}),e._sctp=l}return c.apply(e,arguments)}}},shimSendThrowTypeError:function(e){if(e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){var e=this,n=t.apply(e,arguments),i=n.send;return n.send=function(){var t=this,n=arguments[0],r=n.length||n.size||n.byteLength;if(r>e.sctp.maxMessageSize)throw new DOMException("Message too large (can send a maximum of "+e.sctp.maxMessageSize+" bytes)","TypeError");return i.apply(t,arguments)},n}}}}},{"./utils":14,sdp:3}],9:[function(e,t){var n=e("../utils"),i=e("rtcpeerconnection-shim");t.exports={shimGetUserMedia:e("./getusermedia"),shimPeerConnection:function(e){var t=n.detectBrowser(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){var r=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set:function(e){r.set.call(this,e);var t=new Event("enabled");t.enabled=e,this.dispatchEvent(t)}})}!e.RTCRtpSender||"dtmf"in e.RTCRtpSender.prototype||Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCPeerConnection=i(e,t.version)},shimReplaceTrack:function(e){!e.RTCRtpSender||"replaceTrack"in e.RTCRtpSender.prototype||(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)}}},{"../utils":14,"./getusermedia":10,"rtcpeerconnection-shim":2}],10:[function(e,t){t.exports=function(e){var t=e&&e.navigator,n=function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString:function(){return this.name}}},i=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return i(e)["catch"](function(e){return Promise.reject(n(e))})}}},{}],11:[function(e,t){var n=e("../utils");t.exports={shimGetUserMedia:e("./getusermedia"),shimOnTrack:function(e){"object"!=typeof e||!e.RTCPeerConnection||"ontrack"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=e),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.getTracks().forEach(function(t){var n=new Event("track");n.track=t,n.receiver={track:t},n.transceiver={receiver:n.receiver},n.streams=[e.stream],this.dispatchEvent(n)}.bind(this))}.bind(this))}}),"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},shimSourceObject:function(e){"object"==typeof e&&(!e.HTMLMediaElement||"srcObject"in e.HTMLMediaElement.prototype||Object.defineProperty(e.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(e){this.mozSrcObject=e}}))},shimPeerConnection:function(e){var t=n.detectBrowser(e);if("object"==typeof e&&(e.RTCPeerConnection||e.mozRTCPeerConnection)){e.RTCPeerConnection||(e.RTCPeerConnection=function(n,i){if(t.version<38&&n&&n.iceServers){for(var r=[],o=0;o<n.iceServers.length;o++){var a=n.iceServers[o];if(a.hasOwnProperty("urls"))for(var s=0;s<a.urls.length;s++){var c={url:a.urls[s]};0===a.urls[s].indexOf("turn")&&(c.username=a.username,c.credential=a.credential),r.push(c)}else r.push(n.iceServers[o])}n.iceServers=r}return new e.mozRTCPeerConnection(n,i)},e.RTCPeerConnection.prototype=e.mozRTCPeerConnection.prototype,e.mozRTCPeerConnection.generateCertificate&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return e.mozRTCPeerConnection.generateCertificate}}),e.RTCSessionDescription=e.mozRTCSessionDescription,e.RTCIceCandidate=e.mozRTCIceCandidate),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){var n=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}});var i=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};var r=function(e){
var t=new Map;return Object.keys(e).forEach(function(n){t.set(n,e[n]),t[n]=e[n]}),t},o={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},a=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,n,i){return a.apply(this,[e||null]).then(function(e){if(t.version<48&&(e=r(e)),t.version<53&&!n)try{e.forEach(function(e){e.type=o[e.type]||e.type})}catch(i){if("TypeError"!==i.name)throw i;e.forEach(function(t,n){e.set(n,Object.assign({},t,{type:o[t.type]||t.type}))})}return e}).then(n,i)}}},shimRemoveStream:function(e){!e.RTCPeerConnection||"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;n.deprecated("removeStream","removeTrack"),this.getSenders().forEach(function(n){n.track&&-1!==e.getTracks().indexOf(n.track)&&t.removeTrack(n)})})}}},{"../utils":14,"./getusermedia":12}],12:[function(e,t){var n=e("../utils"),i=n.log;t.exports=function(e){var t=n.detectBrowser(e),r=e&&e.navigator,o=e&&e.MediaStreamTrack,a=function(e){return{name:{InternalError:"NotReadableError",NotSupportedError:"TypeError",PermissionDeniedError:"NotAllowedError",SecurityError:"NotAllowedError"}[e.name]||e.name,message:{"The operation is insecure.":"The request is not allowed by the user agent or the platform in the current context."}[e.message]||e.message,constraint:e.constraint,toString:function(){return this.name+(this.message&&": ")+this.message}}},s=function(e,n,o){var s=function(e){if("object"!=typeof e||e.require)return e;var t=[];return Object.keys(e).forEach(function(n){if("require"!==n&&"advanced"!==n&&"mediaSource"!==n){var i=e[n]="object"==typeof e[n]?e[n]:{ideal:e[n]};if(void 0===i.min&&void 0===i.max&&void 0===i.exact||t.push(n),void 0!==i.exact&&("number"==typeof i.exact?i.min=i.max=i.exact:e[n]=i.exact,delete i.exact),void 0!==i.ideal){e.advanced=e.advanced||[];var r={};"number"==typeof i.ideal?r[n]={min:i.ideal,max:i.ideal}:r[n]=i.ideal,e.advanced.push(r),delete i.ideal,Object.keys(i).length||delete e[n]}}}),t.length&&(e.require=t),e};return e=JSON.parse(JSON.stringify(e)),t.version<38&&(i("spec: "+JSON.stringify(e)),e.audio&&(e.audio=s(e.audio)),e.video&&(e.video=s(e.video)),i("ff37: "+JSON.stringify(e))),r.mozGetUserMedia(e,n,function(e){o(a(e))})},c=function(e){return new Promise(function(t,n){s(e,t,n)})};if(r.mediaDevices||(r.mediaDevices={getUserMedia:c,addEventListener:function(){},removeEventListener:function(){}}),r.mediaDevices.enumerateDevices=r.mediaDevices.enumerateDevices||function(){return new Promise(function(e){var t=[{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}];e(t)})},t.version<41){var d=r.mediaDevices.enumerateDevices.bind(r.mediaDevices);r.mediaDevices.enumerateDevices=function(){return d().then(void 0,function(e){if("NotFoundError"===e.name)return[];throw e})}}if(t.version<49){var l=r.mediaDevices.getUserMedia.bind(r.mediaDevices);r.mediaDevices.getUserMedia=function(e){return l(e).then(function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach(function(e){e.stop()}),new DOMException("The object can not be found here.","NotFoundError");return t},function(e){return Promise.reject(a(e))})}}if(!(t.version>55&&"autoGainControl"in r.mediaDevices.getSupportedConstraints())){var u=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])},p=r.mediaDevices.getUserMedia.bind(r.mediaDevices);if(r.mediaDevices.getUserMedia=function(e){return"object"==typeof e&&"object"==typeof e.audio&&(e=JSON.parse(JSON.stringify(e)),u(e.audio,"autoGainControl","mozAutoGainControl"),u(e.audio,"noiseSuppression","mozNoiseSuppression")),p(e)},o&&o.prototype.getSettings){var h=o.prototype.getSettings;o.prototype.getSettings=function(){var e=h.apply(this,arguments);return u(e,"mozAutoGainControl","autoGainControl"),u(e,"mozNoiseSuppression","noiseSuppression"),e}}if(o&&o.prototype.applyConstraints){var f=o.prototype.applyConstraints;o.prototype.applyConstraints=function(e){return"audio"===this.kind&&"object"==typeof e&&(e=JSON.parse(JSON.stringify(e)),u(e,"autoGainControl","mozAutoGainControl"),u(e,"noiseSuppression","mozNoiseSuppression")),f.apply(this,[e])}}}r.getUserMedia=function(e,i,o){return t.version<44?s(e,i,o):(n.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),void r.mediaDevices.getUserMedia(e).then(i,o))}}},{"../utils":14}],13:[function(e,t){var n=e("../utils");t.exports={shimLocalStreamsAPI:function(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),"getStreamById"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getStreamById=function(e){var t=null;return this._localStreams&&this._localStreams.forEach(function(n){n.id===e&&(t=n)}),this._remoteStreams&&this._remoteStreams.forEach(function(n){n.id===e&&(t=n)}),t}),!("addStream"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),-1===this._localStreams.indexOf(e)&&this._localStreams.push(e);var n=this;e.getTracks().forEach(function(i){t.call(n,i,e)})},e.RTCPeerConnection.prototype.addTrack=function(e,n){return n&&(this._localStreams?-1===this._localStreams.indexOf(n)&&this._localStreams.push(n):this._localStreams=[n]),t.call(this,e,n)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);var t=this._localStreams.indexOf(e);if(-1!==t){this._localStreams.splice(t,1);var n=this,i=e.getTracks();this.getSenders().forEach(function(e){-1!==i.indexOf(e.track)&&n.removeTrack(e)})}})}},shimRemoteStreamsAPI:function(e){"object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),"onaddstream"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(e){var t=this;this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach(function(e){if(t._remoteStreams||(t._remoteStreams=[]),!(t._remoteStreams.indexOf(e)>=0)){t._remoteStreams.push(e);var n=new Event("addstream");n.stream=e,t.dispatchEvent(n)}})})}}))},shimCallbacksAPI:function(e){if("object"==typeof e&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype,n=t.createOffer,i=t.createAnswer,r=t.setLocalDescription,o=t.setRemoteDescription,a=t.addIceCandidate;t.createOffer=function(e,t){var i=arguments.length>=2?arguments[2]:arguments[0],r=n.apply(this,[i]);return t?(r.then(e,t),Promise.resolve()):r},t.createAnswer=function(e,t){var n=arguments.length>=2?arguments[2]:arguments[0],r=i.apply(this,[n]);return t?(r.then(e,t),Promise.resolve()):r};var s=function(e,t,n){var i=r.apply(this,[e]);return n?(i.then(t,n),Promise.resolve()):i};t.setLocalDescription=s,s=function(e,t,n){var i=o.apply(this,[e]);return n?(i.then(t,n),Promise.resolve()):i},t.setRemoteDescription=s,s=function(e,t,n){var i=a.apply(this,[e]);return n?(i.then(t,n),Promise.resolve()):i},t.addIceCandidate=s}},shimGetUserMedia:function(e){var t=e&&e.navigator;t.getUserMedia||(t.webkitGetUserMedia?t.getUserMedia=t.webkitGetUserMedia.bind(t):t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,n,i){t.mediaDevices.getUserMedia(e).then(n,i)}.bind(t)))},shimRTCIceServerUrls:function(e){var t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,i){if(e&&e.iceServers){for(var r=[],o=0;o<e.iceServers.length;o++){var a=e.iceServers[o];!a.hasOwnProperty("urls")&&a.hasOwnProperty("url")?(n.deprecated("RTCIceServer.url","RTCIceServer.urls"),a=JSON.parse(JSON.stringify(a)),a.urls=a.url,delete a.url,r.push(a)):r.push(e.iceServers[o])}e.iceServers=r}return new t(e,i)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in e.RTCPeerConnection&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return t.generateCertificate}})},shimTrackEventTransceiver:function(e){"object"==typeof e&&e.RTCPeerConnection&&"receiver"in e.RTCTrackEvent.prototype&&!e.RTCTransceiver&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},shimCreateOfferLegacy:function(e){var t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){var n=this;if(e){var i=n.getTransceivers().find(function(e){return e.sender.track&&"audio"===e.sender.track.kind});e.offerToReceiveAudio===!1&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):e.offerToReceiveAudio!==!0||i||n.addTransceiver("audio");var r=n.getTransceivers().find(function(e){return e.sender.track&&"video"===e.sender.track.kind});e.offerToReceiveVideo===!1&&r?"sendrecv"===r.direction?r.setDirection("sendonly"):"recvonly"===r.direction&&r.setDirection("inactive"):e.offerToReceiveVideo!==!0||r||n.addTransceiver("video")}return t.apply(n,arguments)}}}},{"../utils":14}],14:[function(e,t){function n(e,t,n){var i=e.match(t);return i&&i.length>=n&&parseInt(i[n],10)}function i(e,t,n){if(e.RTCPeerConnection){var i=e.RTCPeerConnection.prototype,r=i.addEventListener;i.addEventListener=function(e,i){if(e!==t)return r.apply(this,arguments);var o=function(e){i(n(e))};return this._eventMap=this._eventMap||{},this._eventMap[i]=o,r.apply(this,[e,o])};var o=i.removeEventListener;i.removeEventListener=function(e,n){if(e!==t||!this._eventMap||!this._eventMap[n])return o.apply(this,arguments);var i=this._eventMap[n];return delete this._eventMap[n],o.apply(this,[e,i])},Object.defineProperty(i,"on"+t,{get:function(){return this["_on"+t]},set:function(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)}})}}var r=!0,o=!0;t.exports={extractVersion:n,wrapPeerConnectionEvent:i,disableLog:function(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(r=e,e?"adapter.js logging disabled":"adapter.js logging enabled")},disableWarnings:function(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(o=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))},log:function(){if("object"==typeof window){if(r)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},deprecated:function(e,t){o&&console.warn(e+" is deprecated, please use "+t+" instead.")},detectBrowser:function(e){var t=e&&e.navigator,i={};if(i.browser=null,i.version=null,"undefined"==typeof e||!e.navigator)return i.browser="Not a browser.",i;if(t.mozGetUserMedia)i.browser="firefox",i.version=n(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia)i.browser="chrome",i.version=n(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/))i.browser="edge",i.version=n(t.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!t.userAgent.match(/AppleWebKit\/(\d+)\./))return i.browser="Not a supported browser.",i;i.browser="safari",i.version=n(t.userAgent,/AppleWebKit\/(\d+)\./,1)}return i}}},{}]},{},[4])(4)});var Analytics=function(e){this.analyticsPath_=e+"/a/"};Analytics.EventObject_={},Analytics.prototype.reportEvent=function(e,t,n){var i={};i[enums.RequestField.EventField.EVENT_TYPE]=e,i[enums.RequestField.EventField.EVENT_TIME_MS]=Date.now(),t&&(i[enums.RequestField.EventField.ROOM_ID]=t),n&&(i[enums.RequestField.EventField.FLOW_ID]=n),this.sendEventRequest_(i)},Analytics.prototype.sendEventRequest_=function(e){var t={};t[enums.RequestField.TYPE]=enums.RequestField.MessageType.EVENT,t[enums.RequestField.REQUEST_TIME_MS]=Date.now(),t[enums.RequestField.EVENT]=e,sendAsyncUrlRequest("POST",this.analyticsPath_,JSON.stringify(t)).then(function(){}.bind(this),function(e){trace("Failed to send event request: "+e.message)}.bind(this))};var enums={EventType:{ICE_CONNECTION_STATE_CONNECTED:3,ROOM_SIZE_2:2},RequestField:{MessageType:{EVENT:"event"},CLIENT_TYPE:"client_type",EventField:{EVENT_TIME_MS:"event_time_ms",ROOM_ID:"room_id",EVENT_TYPE:"event_type",FLOW_ID:"flow_id"},TYPE:"type",EVENT:"event",REQUEST_TIME_MS:"request_time_ms"},ClientType:{UNKNOWN:0,ANDROID:4,DESKTOP:2,IOS:3,JS:1}},remoteVideo=$("#remote-video"),UI_CONSTANTS={confirmJoinButton:"#confirm-join-button",confirmJoinDiv:"#confirm-join-div",confirmJoinRoomSpan:"#confirm-join-room-span",fullscreenSvg:"#fullscreen",hangupSvg:"#hangup",icons:"#icons",infoDiv:"#info-div",localVideo:"#local-video",miniVideo:"#mini-video",muteAudioSvg:"#mute-audio",muteVideoSvg:"#mute-video",newRoomButton:"#new-room-button",newRoomLink:"#new-room-link",privacyLinks:"#privacy",remoteVideo:"#remote-video",rejoinButton:"#rejoin-button",rejoinDiv:"#rejoin-div",rejoinLink:"#rejoin-link",roomLinkHref:"#room-link-href",roomSelectionDiv:"#room-selection",roomSelectionInput:"#room-id-input",roomSelectionInputLabel:"#room-id-input-label",roomSelectionJoinButton:"#join-button",roomSelectionRandomButton:"#random-button",roomSelectionRecentList:"#recent-rooms-list",sharingDiv:"#sharing-div",statusDiv:"#status-div",videosDiv:"#videos"},AppController=function(e){trace("Initializing; server= "+e.roomServer+"."),trace("Initializing; room="+e.roomId+"."),this.hangupSvg_=$(UI_CONSTANTS.hangupSvg),this.icons_=$(UI_CONSTANTS.icons),this.localVideo_=$(UI_CONSTANTS.localVideo),this.miniVideo_=$(UI_CONSTANTS.miniVideo),this.sharingDiv_=$(UI_CONSTANTS.sharingDiv),this.statusDiv_=$(UI_CONSTANTS.statusDiv),this.remoteVideo_=$(UI_CONSTANTS.remoteVideo),this.videosDiv_=$(UI_CONSTANTS.videosDiv),this.roomLinkHref_=$(UI_CONSTANTS.roomLinkHref),this.rejoinDiv_=$(UI_CONSTANTS.rejoinDiv),this.rejoinLink_=$(UI_CONSTANTS.rejoinLink),this.newRoomLink_=$(UI_CONSTANTS.newRoomLink),this.rejoinButton_=$(UI_CONSTANTS.rejoinButton),this.newRoomButton_=$(UI_CONSTANTS.newRoomButton),this.newRoomButton_.addEventListener("click",this.onNewRoomClick_.bind(this),!1),this.rejoinButton_.addEventListener("click",this.onRejoinClick_.bind(this),!1),this.muteAudioIconSet_=new AppController.IconSet_(UI_CONSTANTS.muteAudioSvg),this.muteVideoIconSet_=new AppController.IconSet_(UI_CONSTANTS.muteVideoSvg),this.fullscreenIconSet_=new AppController.IconSet_(UI_CONSTANTS.fullscreenSvg),this.loadingParams_=e,this.loadUrlParams_();var t=Promise.resolve({});this.loadingParams_.paramsFunction&&(t=this.loadingParams_.paramsFunction()),Promise.resolve(t).then(function(e){if(e&&Object.keys(e).forEach(function(t){this.loadingParams_[t]=e[t]}.bind(this)),this.roomLink_="",this.roomSelection_=null,this.localStream_=null,this.remoteVideoResetTimer_=null,this.loadingParams_.roomId){this.createCall_(),RoomSelection.matchRandomRoomPattern(this.loadingParams_.roomId)||($(UI_CONSTANTS.confirmJoinRoomSpan).textContent=' "'+this.loadingParams_.roomId+'"');var t=$(UI_CONSTANTS.confirmJoinDiv);this.show_(t),$(UI_CONSTANTS.confirmJoinButton).onclick=function(){this.hide_(t);var e=new RoomSelection.RecentlyUsedList;e.pushRecentRoom(this.loadingParams_.roomId),this.finishCallSetup_(this.loadingParams_.roomId)}.bind(this),this.loadingParams_.bypassJoinConfirmation&&$(UI_CONSTANTS.confirmJoinButton).onclick()}else this.showRoomSelection_()}.bind(this))["catch"](function(e){trace("Error initializing: "+e.message)}.bind(this))};AppController.prototype.createCall_=function(){var e=$(UI_CONSTANTS.privacyLinks);this.hide_(e),this.call_=new Call(this.loadingParams_),this.infoBox_=new InfoBox($(UI_CONSTANTS.infoDiv),this.call_,this.loadingParams_.versionInfo);var t=this.loadingParams_.errorMessages,n=this.loadingParams_.warningMessages;if(t&&t.length>0)for(var i=0;i<t.length;++i)this.infoBox_.pushErrorMessage(t[i]);else{if(n&&n.length>0)for(var r=0;r<n.length;++r)this.infoBox_.pushWarningMessage(n[r]);this.call_.onremotehangup=this.onRemoteHangup_.bind(this),this.call_.onremotesdpset=this.onRemoteSdpSet_.bind(this),this.call_.onremotestreamadded=this.onRemoteStreamAdded_.bind(this),this.call_.onlocalstreamadded=this.onLocalStreamAdded_.bind(this),this.call_.onsignalingstatechange=this.infoBox_.updateInfoDiv.bind(this.infoBox_),this.call_.oniceconnectionstatechange=this.infoBox_.updateInfoDiv.bind(this.infoBox_),this.call_.onnewicecandidate=this.infoBox_.recordIceCandidateTypes.bind(this.infoBox_),this.call_.onerror=this.displayError_.bind(this),this.call_.onstatusmessage=this.displayStatus_.bind(this),this.call_.oncallerstarted=this.displaySharingInfo_.bind(this)}},AppController.prototype.showRoomSelection_=function(){var e=$(UI_CONSTANTS.roomSelectionDiv);this.roomSelection_=new RoomSelection(e,UI_CONSTANTS),this.show_(e),this.roomSelection_.onRoomSelected=function(t){this.hide_(e),this.createCall_(),this.finishCallSetup_(t),this.roomSelection_.removeEventListeners(),this.roomSelection_=null,this.localStream_&&this.attachLocalStream_()}.bind(this)},AppController.prototype.setupUi_=function(){this.iconEventSetup_(),document.onkeypress=this.onKeyPress_.bind(this),window.onmousemove=this.showIcons_.bind(this),$(UI_CONSTANTS.muteAudioSvg).onclick=this.toggleAudioMute_.bind(this),$(UI_CONSTANTS.muteVideoSvg).onclick=this.toggleVideoMute_.bind(this),$(UI_CONSTANTS.fullscreenSvg).onclick=this.toggleFullScreen_.bind(this),$(UI_CONSTANTS.hangupSvg).onclick=this.hangup_.bind(this),setUpFullScreen()},AppController.prototype.finishCallSetup_=function(e){this.call_.start(e),this.setupUi_(),isChromeApp()||(window.onbeforeunload=function(){this.call_.hangup(!1)}.bind(this),window.onpopstate=function(e){e.state?e.state.roomLink&&(location.href=e.state.roomLink):(trace("Reloading main page."),location.href=location.origin)})},AppController.prototype.hangup_=function(){trace("Hanging up."),this.hide_(this.icons_),this.displayStatus_("Hanging up"),this.transitionToDone_(),this.call_.hangup(!0),document.onkeypress=null,window.onmousemove=null},AppController.prototype.onRemoteHangup_=function(){this.displayStatus_("The remote side hung up."),this.transitionToWaiting_(),this.call_.onRemoteHangup()},AppController.prototype.onRemoteSdpSet_=function(e){e?(trace("Waiting for remote video."),this.waitForRemoteVideo_()):(trace("No remote video stream; not waiting for media to arrive."),this.transitionToActive_())},AppController.prototype.waitForRemoteVideo_=function(){this.remoteVideo_.readyState>=2?(trace("Remote video started; currentTime: "+this.remoteVideo_.currentTime),this.transitionToActive_()):this.remoteVideo_.oncanplay=this.waitForRemoteVideo_.bind(this)},AppController.prototype.onRemoteStreamAdded_=function(e){this.deactivate_(this.sharingDiv_),trace("Remote stream added."),this.remoteVideo_.srcObject=e,this.infoBox_.getRemoteTrackIds(e),this.remoteVideoResetTimer_&&(clearTimeout(this.remoteVideoResetTimer_),this.remoteVideoResetTimer_=null)},AppController.prototype.onLocalStreamAdded_=function(e){trace("User has granted access to local media."),this.localStream_=e,this.infoBox_.getLocalTrackIds(this.localStream_),this.roomSelection_||this.attachLocalStream_()},AppController.prototype.attachLocalStream_=function(){trace("Attaching local stream."),this.localVideo_.srcObject=this.localStream_,this.displayStatus_(""),this.activate_(this.localVideo_),this.show_(this.icons_),0===this.localStream_.getVideoTracks().length&&this.hide_($(UI_CONSTANTS.muteVideoSvg)),0===this.localStream_.getAudioTracks().length&&this.hide_($(UI_CONSTANTS.muteAudioSvg))},AppController.prototype.transitionToActive_=function(){this.remoteVideo_.oncanplay=void 0;var e=window.performance.now();this.infoBox_.setSetupTimes(this.call_.startTime,e),this.infoBox_.updateInfoDiv(),trace("Call setup time: "+(e-this.call_.startTime).toFixed(0)+"ms."),trace("reattachMediaStream: "+this.localVideo_.srcObject),this.miniVideo_.srcObject=this.localVideo_.srcObject,this.activate_(this.remoteVideo_),this.activate_(this.miniVideo_),this.deactivate_(this.localVideo_),this.localVideo_.srcObject=null,this.activate_(this.videosDiv_),this.show_(this.hangupSvg_),this.displayStatus_("")},AppController.prototype.transitionToWaiting_=function(){this.remoteVideo_.oncanplay=void 0,this.hide_(this.hangupSvg_),this.deactivate_(this.videosDiv_),this.remoteVideoResetTimer_||(this.remoteVideoResetTimer_=setTimeout(function(){this.remoteVideoResetTimer_=null,trace("Resetting remoteVideo src after transitioning to waiting."),this.remoteVideo_.srcObject=null}.bind(this),800)),this.localVideo_.srcObject=this.miniVideo_.srcObject,this.activate_(this.localVideo_),this.deactivate_(this.remoteVideo_),this.deactivate_(this.miniVideo_)},AppController.prototype.transitionToDone_=function(){this.remoteVideo_.oncanplay=void 0,this.deactivate_(this.localVideo_),this.deactivate_(this.remoteVideo_),this.deactivate_(this.miniVideo_),this.hide_(this.hangupSvg_),this.activate_(this.rejoinDiv_),this.show_(this.rejoinDiv_),this.displayStatus_("")},AppController.prototype.onRejoinClick_=function(){this.deactivate_(this.rejoinDiv_),this.hide_(this.rejoinDiv_),this.call_.restart(),this.setupUi_()},AppController.prototype.onNewRoomClick_=function(){this.deactivate_(this.rejoinDiv_),this.hide_(this.rejoinDiv_),this.showRoomSelection_()},AppController.prototype.onKeyPress_=function(e){switch(String.fromCharCode(e.charCode)){case" ":case"m":return this.call_&&(this.call_.toggleAudioMute(),this.muteAudioIconSet_.toggle()),!1;case"c":return this.call_&&(this.call_.toggleVideoMute(),this.muteVideoIconSet_.toggle()),!1;case"f":return this.toggleFullScreen_(),!1;case"i":return this.infoBox_.toggleInfoDiv(),!1;case"q":return this.hangup_(),!1;case"l":return this.toggleMiniVideo_(),!1;default:return}},AppController.prototype.pushCallNavigation_=function(e,t){isChromeApp()||window.history.pushState({roomId:e,roomLink:t},e,t)},AppController.prototype.displaySharingInfo_=function(e,t){this.roomLinkHref_.href=t,this.roomLinkHref_.text=t,this.roomLink_=t,this.pushCallNavigation_(e,t),this.activate_(this.sharingDiv_)},AppController.prototype.displayStatus_=function(e){""===e?this.deactivate_(this.statusDiv_):this.activate_(this.statusDiv_),this.statusDiv_.innerHTML=e},AppController.prototype.displayError_=function(e){trace(e),this.infoBox_.pushErrorMessage(e)},AppController.prototype.toggleAudioMute_=function(){this.call_.toggleAudioMute(),this.muteAudioIconSet_.toggle()},AppController.prototype.toggleVideoMute_=function(){this.call_.toggleVideoMute(),this.muteVideoIconSet_.toggle()},AppController.prototype.toggleFullScreen_=function(){isFullScreen()?(trace("Exiting fullscreen."),document.querySelector("svg#fullscreen title").textContent="Enter fullscreen",document.cancelFullScreen()):(trace("Entering fullscreen."),document.querySelector("svg#fullscreen title").textContent="Exit fullscreen",document.body.requestFullScreen()),this.fullscreenIconSet_.toggle()},AppController.prototype.toggleMiniVideo_=function(){this.miniVideo_.classList.contains("active")?this.deactivate_(this.miniVideo_):this.activate_(this.miniVideo_)},AppController.prototype.hide_=function(e){e.classList.add("hidden")},AppController.prototype.show_=function(e){e.classList.remove("hidden")},AppController.prototype.activate_=function(e){e.classList.add("active")},AppController.prototype.deactivate_=function(e){e.classList.remove("active")},AppController.prototype.showIcons_=function(){this.icons_.classList.contains("active")||(this.activate_(this.icons_),this.setIconTimeout_())},AppController.prototype.hideIcons_=function(){this.icons_.classList.contains("active")&&this.deactivate_(this.icons_)},AppController.prototype.setIconTimeout_=function(){this.hideIconsAfterTimeout&&window.clearTimeout.bind(this,this.hideIconsAfterTimeout),this.hideIconsAfterTimeout=window.setTimeout(function(){this.hideIcons_()}.bind(this),5e3)},AppController.prototype.iconEventSetup_=function(){this.icons_.onmouseenter=function(){window.clearTimeout(this.hideIconsAfterTimeout)}.bind(this),this.icons_.onmouseleave=function(){this.setIconTimeout_()}.bind(this)},AppController.prototype.loadUrlParams_=function(){var e="VP9",t=queryStringToDictionary(window.location.search);this.loadingParams_.audioSendBitrate=t.asbr,this.loadingParams_.audioSendCodec=t.asc,this.loadingParams_.audioRecvBitrate=t.arbr,this.loadingParams_.audioRecvCodec=t.arc,this.loadingParams_.opusMaxPbr=t.opusmaxpbr,this.loadingParams_.opusFec=t.opusfec,this.loadingParams_.opusDtx=t.opusdtx,this.loadingParams_.opusStereo=t.stereo,this.loadingParams_.videoSendBitrate=t.vsbr,this.loadingParams_.videoSendInitialBitrate=t.vsibr,this.loadingParams_.videoSendCodec=t.vsc,this.loadingParams_.videoRecvBitrate=t.vrbr,this.loadingParams_.videoRecvCodec=t.vrc||e,this.loadingParams_.videoFec=t.videofec},AppController.IconSet_=function(e){this.iconElement=document.querySelector(e)},AppController.IconSet_.prototype.toggle=function(){this.iconElement.classList.contains("on")?this.iconElement.classList.remove("on"):this.iconElement.classList.add("on")};var Call=function(e){this.params_=e,this.roomServer_=e.roomServer||"",this.channel_=new SignalingChannel(e.wssUrl,e.wssPostUrl),this.channel_.onmessage=this.onRecvSignalingChannelMessage_.bind(this),this.pcClient_=null,this.localStream_=null,this.errorMessageQueue_=[],this.startTime=null,this.oncallerstarted=null,this.onerror=null,this.oniceconnectionstatechange=null,this.onlocalstreamadded=null,this.onnewicecandidate=null,this.onremotehangup=null,this.onremotesdpset=null,this.onremotestreamadded=null,this.onsignalingstatechange=null,this.onstatusmessage=null,this.getMediaPromise_=null,this.getIceServersPromise_=null,this.requestMediaAndIceServers_()};Call.prototype.requestMediaAndIceServers_=function(){this.getMediaPromise_=this.maybeGetMedia_(),this.getIceServersPromise_=this.maybeGetIceServers_()},Call.prototype.isInitiator=function(){return this.params_.isInitiator},Call.prototype.start=function(e){this.connectToRoom_(e),this.params_.isLoopback&&setupLoopback(this.params_.wssUrl,e)},Call.prototype.queueCleanupMessages_=function(){apprtc.windowPort.sendMessage({action:Constants.QUEUEADD_ACTION,queueMessage:{action:Constants.XHR_ACTION,method:"POST",url:this.getLeaveUrl_(),body:null}}),apprtc.windowPort.sendMessage({action:Constants.QUEUEADD_ACTION,queueMessage:{action:Constants.WS_ACTION,wsAction:Constants.WS_SEND_ACTION,data:JSON.stringify({cmd:"send",msg:JSON.stringify({type:"bye"})})}}),apprtc.windowPort.sendMessage({action:Constants.QUEUEADD_ACTION,queueMessage:{action:Constants.XHR_ACTION,method:"DELETE",url:this.channel_.getWssPostUrl(),body:null}})},Call.prototype.clearCleanupQueue_=function(){apprtc.windowPort.sendMessage({action:Constants.QUEUECLEAR_ACTION})},Call.prototype.restart=function(){this.requestMediaAndIceServers_(),this.start(this.params_.previousRoomId)},Call.prototype.hangup=function(e){if(this.startTime=null,isChromeApp()&&this.clearCleanupQueue_(),this.localStream_&&("undefined"==typeof this.localStream_.getTracks?this.localStream_.stop():this.localStream_.getTracks().forEach(function(e){e.stop()}),this.localStream_=null),this.params_.roomId){this.pcClient_&&(this.pcClient_.close(),this.pcClient_=null);var t=[];if(t.push({step:function(){var t=this.getLeaveUrl_();return sendUrlRequest("POST",t,e)}.bind(this),errorString:"Error sending /leave:"}),t.push({step:function(){this.channel_.send(JSON.stringify({type:"bye"}))}.bind(this),errorString:"Error sending bye:"}),t.push({step:function(){return this.channel_.close(e)}.bind(this),errorString:"Error closing signaling channel:"}),t.push({step:function(){this.params_.previousRoomId=this.params_.roomId,this.params_.roomId=null,this.params_.clientId=null}.bind(this),errorString:"Error setting params:"}),e){for(var n=function(e,t){trace(e+" "+t.message)},i=Promise.resolve(),r=0;r<t.length;++r)i=i.then(t[r].step)["catch"](n.bind(this,t[r].errorString));return i}for(var o=function(e,t){try{e()}catch(n){trace(t+" "+n)}},a=0;a<t.length;++a)o(t[a].step,t[a].errorString);return trace(null!==this.params_.roomId||null!==this.params_.clientId?"ERROR: sync cleanup tasks did not complete successfully.":"Cleanup completed."),Promise.resolve()}},Call.prototype.getLeaveUrl_=function(){return this.roomServer_+"/leave/"+this.params_.roomId+"/"+this.params_.clientId},Call.prototype.onRemoteHangup=function(){this.startTime=null,this.params_.isInitiator=!0,this.pcClient_&&(this.pcClient_.close(),this.pcClient_=null),this.startSignaling_()},Call.prototype.getPeerConnectionStates=function(){return this.pcClient_?this.pcClient_.getPeerConnectionStates():null},Call.prototype.getPeerConnectionStats=function(e){this.pcClient_&&this.pcClient_.getPeerConnectionStats(e)},Call.prototype.toggleVideoMute=function(){var e=this.localStream_.getVideoTracks();if(0===e.length)return void trace("No local video available.");trace("Toggling video mute state.");for(var t=0;t<e.length;++t)e[t].enabled=!e[t].enabled;trace("Video "+(e[0].enabled?"unmuted.":"muted."))},Call.prototype.toggleAudioMute=function(){var e=this.localStream_.getAudioTracks();if(0===e.length)return void trace("No local audio available.");trace("Toggling audio mute state.");for(var t=0;t<e.length;++t)e[t].enabled=!e[t].enabled;trace("Audio "+(e[0].enabled?"unmuted.":"muted."))},Call.prototype.connectToRoom_=function(e){this.params_.roomId=e;var t=this.channel_.open()["catch"](function(e){return this.onError_("WebSocket open error: "+e.message),Promise.reject(e)}.bind(this)),n=this.joinRoom_().then(function(e){this.params_.clientId=e.client_id,this.params_.roomId=e.room_id,this.params_.roomLink=e.room_link,this.params_.isInitiator="true"===e.is_initiator,this.params_.messages=e.messages}.bind(this))["catch"](function(e){return this.onError_("Room server join error: "+e.message),Promise.reject(e)}.bind(this));Promise.all([t,n]).then(function(){this.channel_.register(this.params_.roomId,this.params_.clientId),Promise.all([this.getIceServersPromise_,this.getMediaPromise_]).then(function(){this.startSignaling_(),isChromeApp()&&this.queueCleanupMessages_()}.bind(this))["catch"](function(e){this.onError_("Failed to start signaling: "+e.message)}.bind(this))}.bind(this))["catch"](function(e){this.onError_("WebSocket register error: "+e.message)}.bind(this))},Call.prototype.maybeGetMedia_=function(){var e=this.params_.mediaConstraints.audio!==!1||this.params_.mediaConstraints.video!==!1,t=null;if(e){var n=this.params_.mediaConstraints;t=navigator.mediaDevices.getUserMedia(n)["catch"](function(e){if("NotFoundError"!==e.name)throw e;return navigator.mediaDevices.enumerateDevices().then(function(e){var t=e.find(function(e){return"videoinput"===e.kind}),i=e.find(function(e){return"audioinput"===e.kind}),r={video:t&&n.video,audio:i&&n.audio};return navigator.mediaDevices.getUserMedia(r)})}).then(function(e){trace("Got access to local media with mediaConstraints:\n  '"+JSON.stringify(n)+"'"),this.onUserMediaSuccess_(e)}.bind(this))["catch"](function(e){this.onError_("Error getting user media: "+e.message),this.onUserMediaError_(e)}.bind(this))}else t=Promise.resolve();return t},Call.prototype.maybeGetIceServers_=function(){var e=this.params_.iceServerRequestUrl&&this.params_.iceServerRequestUrl.length>0&&this.params_.peerConnectionConfig.iceServers&&0===this.params_.peerConnectionConfig.iceServers.length,t=null;if(e){var n=this.params_.iceServerRequestUrl;t=requestIceServers(n,this.params_.iceServerTransports).then(function(e){
var t=this.params_.peerConnectionConfig.iceServers;this.params_.peerConnectionConfig.iceServers=t.concat(e)}.bind(this))["catch"](function(e){if(this.onstatusmessage){var t=encodeURIComponent("AppRTC demo ICE servers not working");this.onstatusmessage('No TURN server; unlikely that media will traverse networks. If this persists please <a href="mailto:discuss-webrtc@googlegroups.com?subject='+t+'">report it to discuss-webrtc@googlegroups.com</a>.')}trace(e.message)}.bind(this))}else t=Promise.resolve();return t},Call.prototype.onUserMediaSuccess_=function(e){this.localStream_=e,this.onlocalstreamadded&&this.onlocalstreamadded(e)},Call.prototype.onUserMediaError_=function(e){var t="Failed to get access to local media. Error name was "+e.name+". Continuing without sending a stream.";this.onError_("getUserMedia error: "+t),this.errorMessageQueue_.push(e),alert(t)},Call.prototype.maybeCreatePcClientAsync_=function(){return new Promise(function(e,t){if(this.pcClient_)return void e();if("function"==typeof RTCPeerConnection.generateCertificate){var n={name:"ECDSA",namedCurve:"P-256"};RTCPeerConnection.generateCertificate(n).then(function(t){trace("ECDSA certificate generated successfully."),this.params_.peerConnectionConfig.certificates=[t],this.createPcClient_(),e()}.bind(this))["catch"](function(e){trace("ECDSA certificate generation failed."),t(e)})}else this.createPcClient_(),e()}.bind(this))},Call.prototype.createPcClient_=function(){this.pcClient_=new PeerConnectionClient(this.params_,this.startTime),this.pcClient_.onsignalingmessage=this.sendSignalingMessage_.bind(this),this.pcClient_.onremotehangup=this.onremotehangup,this.pcClient_.onremotesdpset=this.onremotesdpset,this.pcClient_.onremotestreamadded=this.onremotestreamadded,this.pcClient_.onsignalingstatechange=this.onsignalingstatechange,this.pcClient_.oniceconnectionstatechange=this.oniceconnectionstatechange,this.pcClient_.onnewicecandidate=this.onnewicecandidate,this.pcClient_.onerror=this.onerror,trace("Created PeerConnectionClient")},Call.prototype.startSignaling_=function(){trace("Starting signaling."),this.isInitiator()&&this.oncallerstarted&&this.oncallerstarted(this.params_.roomId,this.params_.roomLink),this.startTime=window.performance.now(),this.maybeCreatePcClientAsync_().then(function(){this.localStream_&&(trace("Adding local stream."),this.pcClient_.addStream(this.localStream_)),this.params_.isInitiator?this.pcClient_.startAsCaller(this.params_.offerOptions):this.pcClient_.startAsCallee(this.params_.messages)}.bind(this))["catch"](function(e){this.onError_("Create PeerConnection exception: "+e),alert("Cannot create RTCPeerConnection: "+e.message)}.bind(this))},Call.prototype.joinRoom_=function(){return new Promise(function(e,t){this.params_.roomId||t(Error("Missing room id."));var n=this.roomServer_+"/join/"+this.params_.roomId+window.location.search;sendAsyncUrlRequest("POST",n).then(function(n){var i=parseJSON(n);if(!i)return void t(Error("Error parsing response JSON."));if("SUCCESS"===i.result)trace("Joined the room."),e(i.params);else if(t(Error("Registration error: "+i.result)),"FULL"===i.result){var r=this.roomServer_+"/r/"+this.params_.roomId+window.location.search;window.location.assign(r)}}.bind(this))["catch"](function(e){t(Error("Failed to join the room: "+e.message))}.bind(this))}.bind(this))},Call.prototype.onRecvSignalingChannelMessage_=function(e){this.maybeCreatePcClientAsync_().then(this.pcClient_.receiveSignalingMessage(e))},Call.prototype.sendSignalingMessage_=function(e){var t=JSON.stringify(e);if(this.params_.isInitiator){var n=this.roomServer_+"/sgc/protocol/apprtc.esegece.com/message/"+this.params_.roomId+"/"+this.params_.clientId+window.location.search,i=new XMLHttpRequest;i.open("POST",n,!0),i.send(t),trace("C->GAE: "+t)}else this.channel_.send(t)},Call.prototype.onError_=function(e){this.onerror&&this.onerror(e)};var Constants={WS_ACTION:"ws",XHR_ACTION:"xhr",QUEUEADD_ACTION:"addToQueue",QUEUECLEAR_ACTION:"clearQueue",EVENT_ACTION:"event",WS_CREATE_ACTION:"create",WS_EVENT_ONERROR:"onerror",WS_EVENT_ONMESSAGE:"onmessage",WS_EVENT_ONOPEN:"onopen",WS_EVENT_ONCLOSE:"onclose",WS_EVENT_SENDERROR:"onsenderror",WS_SEND_ACTION:"send",WS_CLOSE_ACTION:"close"},InfoBox=function(e,t,n){this.infoDiv_=e,this.remoteVideo_=document.getElementById("remote-video"),this.localVideo_=document.getElementById("mini-video"),this.call_=t,this.versionInfo_=n,this.errorMessages_=[],this.warningMessages_=[],this.startTime_=null,this.connectTime_=null,this.stats_=null,this.prevStats_=null,this.getStatsTimer_=null,this.localTrackIds_={video:"",audio:""},this.remoteTrackIds_={video:"",audio:""},this.iceCandidateTypes_={Local:{},Remote:{}},this.localDecodedFrames_=0,this.localStartTime_=0,this.localVideo_.addEventListener("playing",function(e){this.localDecodedFrames_=e.target.webkitDecodedFrameCount,this.localStartTime_=(new Date).getTime()}.bind(this)),this.remoteDecodedFrames_=0,this.remoteStartTime_=0,this.remoteVideo_.addEventListener("playing",function(e){this.remoteDecodedFrames_=e.target.webkitDecodedFrameCount,this.remoteStartTime_=(new Date).getTime()}.bind(this))};InfoBox.prototype.getLocalTrackIds=function(e){e.getTracks().forEach(function(e){"audio"===e.kind?this.localTrackIds_.audio=e.id:"video"===e.kind&&(this.localTrackIds_.video=e.id)}.bind(this))},InfoBox.prototype.getRemoteTrackIds=function(e){e.getTracks().forEach(function(e){"audio"===e.kind?this.remoteTrackIds_.audio=e.id:"video"===e.kind&&(this.remoteTrackIds_.video=e.id)}.bind(this))},InfoBox.prototype.recordIceCandidateTypes=function(e,t){var n=iceCandidateType(t),i=this.iceCandidateTypes_[e];i[n]?++i[n]:i[n]=1,this.updateInfoDiv()},InfoBox.prototype.pushErrorMessage=function(e){this.errorMessages_.push(e),this.updateInfoDiv(),this.showInfoDiv()},InfoBox.prototype.pushWarningMessage=function(e){this.warningMessages_.push(e),this.updateInfoDiv(),this.showInfoDiv()},InfoBox.prototype.setSetupTimes=function(e,t){this.startTime_=e,this.connectTime_=t},InfoBox.prototype.showInfoDiv=function(){this.getStatsTimer_=setInterval(this.refreshStats_.bind(this),1e3),this.refreshStats_(),this.infoDiv_.classList.add("active")},InfoBox.prototype.toggleInfoDiv=function(){this.infoDiv_.classList.contains("active")?(clearInterval(this.getStatsTimer_),this.infoDiv_.classList.remove("active")):this.showInfoDiv()},InfoBox.prototype.refreshStats_=function(){this.call_.getPeerConnectionStats(function(e){this.prevStats_=this.stats_,this.stats_=e,this.updateInfoDiv()}.bind(this))},InfoBox.prototype.updateInfoDiv=function(){var e='<pre id="info-box-stats" style="line-height: initial">';if(this.stats_){var t=this.call_.getPeerConnectionStates();if(!t)return;e+=this.buildLine_("States"),e+=this.buildLine_("Signaling",t.signalingState),e+=this.buildLine_("Gathering",t.iceGatheringState),e+=this.buildLine_("Connection",t.iceConnectionState);for(var n in this.iceCandidateTypes_){var i=[];for(var r in this.iceCandidateTypes_[n])i.push(r+":"+this.iceCandidateTypes_[n][r]);e+=this.buildLine_(n,i.join(" "))}var o,a,s,c,d,l,u=enumerateStats(this.stats_,this.localTrackIds_,this.remoteTrackIds_),p=u.connection;if(p&&(o=p.localIp,a=p.remoteIp,s=p.localType,c=p.remoteType,d=p.localPort,l=p.remotePort),o&&a){var h,f=p.localCandidateId;f&&(h=p.localPriority>>24),e+=this.buildLine_("LocalAddr",o+" ("+s+(void 0!==typeof h?""+formatTypePreference(h):"")+")"),e+=this.buildLine_("LocalPort",d),e+=this.buildLine_("RemoteAddr",a+" ("+c+")"),e+=this.buildLine_("RemotePort",l)}e+=this.buildLine_(),e+=this.buildStatsSection_()}if(this.errorMessages_.length>0||this.warningMessages_.length>0)if(e+=this.buildLine_("\nMessages"),this.errorMessages_.length){this.infoDiv_.classList.add("warning");for(var m=0;m!==this.errorMessages_.length;++m)e+=this.errorMessages_[m]+"\n"}else{this.infoDiv_.classList.add("active");for(var v=0;v!==this.warningMessages_.length;++v)e+=this.warningMessages_[v]+"\n"}else this.infoDiv_.classList.remove("warning");if(this.versionInfo_){e+=this.buildLine_(),e+=this.buildLine_("Version");for(var _ in this.versionInfo_)e+=this.buildLine_(_,this.versionInfo_[_])}e+="</pre>",this.infoDiv_.innerHTML!==e&&(this.infoDiv_.innerHTML=e)},InfoBox.prototype.buildStatsSection_=function(){var e=this.buildLine_("Stats"),t=enumerateStats(this.stats_,this.localTrackIds_,this.remoteTrackIds_),n=enumerateStats(this.prevStats_,this.localTrackIds_,this.remoteTrackIds_),i=1e3*t.connection.totalRoundTripTime,r=1e3*t.connection.currentRoundTripTime;null!==this.endTime_&&(e+=this.buildLine_("Call time",InfoBox.formatInterval_(window.performance.now()-this.connectTime_)),e+=this.buildLine_("Setup time",InfoBox.formatMsec_(this.connectTime_-this.startTime_))),""!==t.connection.remoteIp&&(e+=this.buildLine_("TotalRtt",InfoBox.formatMsec_(i)),e+=this.buildLine_("CurrentRtt",InfoBox.formatMsec_(r)));var o,a,s,c,d,l,u,p,h,f,m,v,_,g,y,S,C,b,w,T,R,k,E,P,I,x,O,L,D,A,M,N,B=t.audio.remote,j=n.audio.remote,U=n.video.remote,F=t.video.remote,z=t.audio.local,V=n.audio.local,q=n.video.local,G=t.video.local;return""!==z.codecId&&0!==z.payloadType&&(T=z.mimeType,R=parseFloat(z.audioLevel).toFixed(3),w=z.clockRate,E=z.payloadType,b=computeBitrate(z,V,"bytesSent"),k=computeRate(z,V,"packetsSent"),e+=this.buildLine_("Audio Tx",T+"/"+E+", rate "+w+", "+InfoBox.formatBitrate_(b)+", "+InfoBox.formatPacketRate_(k)+", inputLevel "+R)),""!==B.codecId&&0!==B.payloadType&&(s=B.mimeType,d=parseFloat(B.audioLevel).toFixed(3),c=parseFloat(B.jitter).toFixed(3),a=B.clockRate,u=B.payloadType,o=computeBitrate(B,j,"bytesReceived"),l=computeRate(B,j,"packetsReceived"),e+=this.buildLine_("Audio Rx",s+"/"+u+", rate "+a+", jitter "+c+", "+InfoBox.formatBitrate_(o)+", "+InfoBox.formatPacketRate_(l)+", outputLevel "+d)),""!==G.codecId&&0!==G.payloadType&&0!==G.frameHeight&&(I=G.mimeType,L=G.frameHeight,N=G.payloadType,M=G.pliCount,x=G.firCount,D=G.nackCount,O=calculateFps(this.remoteVideo_,this.remoteDecodedFrames_,this.remoteStartTime_,"local",this.updateDecodedFramesCallback_),P=computeBitrate(G,q,"bytesSent"),A=computeRate(G,q,"packetsSent"),e+=this.buildLine_("Video Tx",I+"/"+N+", "+L.toString()+"p"+O.toString()+", firCount "+x+", pliCount "+M+", nackCount "+D+", "+InfoBox.formatBitrate_(P)+", "+InfoBox.formatPacketRate_(A))),""!==F.codecId&&0!==F.payloadType&&0!==G.frameHeight&&(h=F.mimeType,_=F.frameHeight,C=F.payloadType,f=F.framesDropped,S=F.pliCount,m=F.firCount,g=F.nackCount,v=calculateFps(this.remoteVideo_,this.remoteDecodedFrames_,this.remoteStartTime_,"remote",this.updateDecodedFramesCallback_),p=computeBitrate(F,U,"bytesReceived"),y=computeRate(F,U,"packetsReceived"),e+=this.buildLine_("Video Rx",h+"/"+C+", "+_.toString()+"p"+v.toString()+", firCount "+m+", pliCount "+S+", nackCount "+g+", droppedFrames "+f+", "+InfoBox.formatBitrate_(p)+", "+InfoBox.formatPacketRate_(y))),e},InfoBox.prototype.updateDecodedFramesCallback_=function(e,t,n){"local"===n?(this.localDecodedFrames_=e,this.localStartTime_=t):"remote"===n&&(this.remoteDecodedFrames_=e,this.remoteStartTime_=t)},InfoBox.prototype.buildLine_=function(e,t){var n=12,i="";if(e){for(i+=e+":";i.length<n;)i+=" ";t&&(i+=t)}return i+="\n"},InfoBox.formatInterval_=function(e){var t="",n=Math.floor(e/1e3),i=Math.floor(n/60),r=Math.floor(i/60),o=function(e){return(10>e?"0":"")+e.toString()};return r>0&&(t+=o(r)+":"),t+=o(i-60*r)+":",t+=o(n-60*i)},InfoBox.formatMsec_=function(e){return e.toFixed(0).toString()+" ms"},InfoBox.formatBitrate_=function(e){if(!e)return"- bps";var t;1e3>e?t="bps":1e6>e?(t="kbps",e/=1e3):(t="Mbps",e/=1e6);var n=e.toPrecision(3)+" "+t;return n},InfoBox.formatPacketRate_=function(e){return e?e.toPrecision(3)+" pps":"- pps"};var PeerConnectionClient=function(e,t){this.params_=e,this.startTime_=t,trace("Creating RTCPeerConnnection with:\n  config: '"+JSON.stringify(e.peerConnectionConfig)+"';\n  constraints: '"+JSON.stringify(e.peerConnectionConstraints)+"'."),this.pc_=new RTCPeerConnection(e.peerConnectionConfig,e.peerConnectionConstraints),this.pc_.onicecandidate=this.onIceCandidate_.bind(this),this.pc_.ontrack=this.onRemoteStreamAdded_.bind(this),this.pc_.onremovestream=trace.bind(null,"Remote stream removed."),this.pc_.onsignalingstatechange=this.onSignalingStateChanged_.bind(this),this.pc_.oniceconnectionstatechange=this.onIceConnectionStateChanged_.bind(this),window.dispatchEvent(new CustomEvent("pccreated",{detail:{pc:this,time:new Date,userId:this.params_.roomId+(this.isInitiator_?"-0":"-1"),sessionId:this.params_.roomId}})),this.hasRemoteSdp_=!1,this.messageQueue_=[],this.isInitiator_=!1,this.started_=!1,this.onerror=null,this.oniceconnectionstatechange=null,this.onnewicecandidate=null,this.onremotehangup=null,this.onremotesdpset=null,this.onremotestreamadded=null,this.onsignalingmessage=null,this.onsignalingstatechange=null};PeerConnectionClient.DEFAULT_SDP_OFFER_OPTIONS_={offerToReceiveAudio:1,offerToReceiveVideo:1,voiceActivityDetection:!1},PeerConnectionClient.prototype.addStream=function(e){this.pc_&&this.pc_.addStream(e)},PeerConnectionClient.prototype.startAsCaller=function(e){if(!this.pc_)return!1;if(this.started_)return!1;this.isInitiator_=!0,this.started_=!0;var t=mergeConstraints(PeerConnectionClient.DEFAULT_SDP_OFFER_OPTIONS_,e);return trace("Sending offer to peer, with constraints: \n'"+JSON.stringify(t)+"'."),this.pc_.createOffer(t).then(this.setLocalSdpAndNotify_.bind(this))["catch"](this.onError_.bind(this,"createOffer")),!0},PeerConnectionClient.prototype.startAsCallee=function(e){if(!this.pc_)return!1;if(this.started_)return!1;if(this.isInitiator_=!1,this.started_=!0,e&&e.length>0){for(var t=0,n=e.length;n>t;t++)this.receiveSignalingMessage(e[t]);return!0}return this.messageQueue_.length>0&&this.drainMessageQueue_(),!0},PeerConnectionClient.prototype.receiveSignalingMessage=function(e){var t=parseJSON(e);t&&(this.isInitiator_&&"answer"===t.type||!this.isInitiator_&&"offer"===t.type?(this.hasRemoteSdp_=!0,this.messageQueue_.unshift(t)):"candidate"===t.type?this.messageQueue_.push(t):"bye"===t.type&&this.onremotehangup&&this.onremotehangup(),this.drainMessageQueue_())},PeerConnectionClient.prototype.close=function(){this.pc_&&(this.pc_.close(),window.dispatchEvent(new CustomEvent("pcclosed",{detail:{pc:this,time:new Date}})),this.pc_=null)},PeerConnectionClient.prototype.getPeerConnectionStates=function(){return this.pc_?{signalingState:this.pc_.signalingState,iceGatheringState:this.pc_.iceGatheringState,iceConnectionState:this.pc_.iceConnectionState}:null},PeerConnectionClient.prototype.getPeerConnectionStats=function(e){this.pc_&&this.pc_.getStats(null).then(e)},PeerConnectionClient.prototype.doAnswer_=function(){trace("Sending answer to peer."),this.pc_.createAnswer().then(this.setLocalSdpAndNotify_.bind(this))["catch"](this.onError_.bind(this,"createAnswer"))},PeerConnectionClient.prototype.setLocalSdpAndNotify_=function(e){e.sdp=maybePreferAudioReceiveCodec(e.sdp,this.params_),e.sdp=maybePreferVideoReceiveCodec(e.sdp,this.params_),e.sdp=maybeSetAudioReceiveBitRate(e.sdp,this.params_),e.sdp=maybeSetVideoReceiveBitRate(e.sdp,this.params_),e.sdp=maybeRemoveVideoFec(e.sdp,this.params_),this.pc_.setLocalDescription(e).then(trace.bind(null,"Set session description success."))["catch"](this.onError_.bind(this,"setLocalDescription")),this.onsignalingmessage&&this.onsignalingmessage({sdp:e.sdp,type:e.type})},PeerConnectionClient.prototype.setRemoteSdp_=function(e){e.sdp=maybeSetOpusOptions(e.sdp,this.params_),e.sdp=maybePreferAudioSendCodec(e.sdp,this.params_),e.sdp=maybePreferVideoSendCodec(e.sdp,this.params_),e.sdp=maybeSetAudioSendBitRate(e.sdp,this.params_),e.sdp=maybeSetVideoSendBitRate(e.sdp,this.params_),e.sdp=maybeSetVideoSendInitialBitRate(e.sdp,this.params_),e.sdp=maybeRemoveVideoFec(e.sdp,this.params_),this.pc_.setRemoteDescription(new RTCSessionDescription(e)).then(this.onSetRemoteDescriptionSuccess_.bind(this))["catch"](this.onError_.bind(this,"setRemoteDescription"))},PeerConnectionClient.prototype.onSetRemoteDescriptionSuccess_=function(){trace("Set remote session description success.");var e=this.pc_.getRemoteStreams();this.onremotesdpset&&this.onremotesdpset(e.length>0&&e[0].getVideoTracks().length>0)},PeerConnectionClient.prototype.processSignalingMessage_=function(e){if("offer"!==e.type||this.isInitiator_)if("answer"===e.type&&this.isInitiator_){if("have-local-offer"!==this.pc_.signalingState)return void trace("ERROR: remote answer received in unexpected state: "+this.pc_.signalingState);this.setRemoteSdp_(e)}else if("candidate"===e.type){var t=new RTCIceCandidate({sdpMLineIndex:e.label,candidate:e.candidate});this.recordIceCandidate_("Remote",t),this.pc_.addIceCandidate(t).then(trace.bind(null,"Remote candidate added successfully."))["catch"](this.onError_.bind(this,"addIceCandidate"))}else trace("WARNING: unexpected message: "+JSON.stringify(e));else{if("stable"!==this.pc_.signalingState)return void trace("ERROR: remote offer received in unexpected state: "+this.pc_.signalingState);this.setRemoteSdp_(e),this.doAnswer_()}},PeerConnectionClient.prototype.drainMessageQueue_=function(){if(this.pc_&&this.started_&&this.hasRemoteSdp_){for(var e=0,t=this.messageQueue_.length;t>e;e++)this.processSignalingMessage_(this.messageQueue_[e]);this.messageQueue_=[]}},PeerConnectionClient.prototype.onIceCandidate_=function(e){if(e.candidate){if(this.filterIceCandidate_(e.candidate)){var t={type:"candidate",label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate};this.onsignalingmessage&&this.onsignalingmessage(t),this.recordIceCandidate_("Local",e.candidate)}}else trace("End of candidates.")},PeerConnectionClient.prototype.onSignalingStateChanged_=function(){this.pc_&&(trace("Signaling state changed to: "+this.pc_.signalingState),this.onsignalingstatechange&&this.onsignalingstatechange())},PeerConnectionClient.prototype.onIceConnectionStateChanged_=function(){this.pc_&&(trace("ICE connection state changed to: "+this.pc_.iceConnectionState),"completed"===this.pc_.iceConnectionState&&trace("ICE complete time: "+(window.performance.now()-this.startTime_).toFixed(0)+"ms."),this.oniceconnectionstatechange&&this.oniceconnectionstatechange())},PeerConnectionClient.prototype.filterIceCandidate_=function(e){var t=e.candidate;return-1!==t.indexOf("tcp")?!1:"relay"!==this.params_.peerConnectionConfig.iceTransports||"relay"===iceCandidateType(t)},PeerConnectionClient.prototype.recordIceCandidate_=function(e,t){this.onnewicecandidate&&this.onnewicecandidate(e,t.candidate)},PeerConnectionClient.prototype.onRemoteStreamAdded_=function(e){this.onremotestreamadded&&this.onremotestreamadded(e.streams[0])},PeerConnectionClient.prototype.onError_=function(e,t){this.onerror&&this.onerror(e+": "+t.toString())};var RemoteWebSocket=function(e,t){this.wssUrl_=e,apprtc.windowPort.addMessageListener(this.handleMessage_.bind(this)),this.sendMessage_({action:Constants.WS_ACTION,wsAction:Constants.WS_CREATE_ACTION,wssUrl:e,wssPostUrl:t}),this.readyState=WebSocket.CONNECTING};RemoteWebSocket.prototype.sendMessage_=function(e){apprtc.windowPort.sendMessage(e)},RemoteWebSocket.prototype.send=function(e){if(this.readyState!==WebSocket.OPEN)throw"Web socket is not in OPEN state: "+this.readyState;this.sendMessage_({action:Constants.WS_ACTION,wsAction:Constants.WS_SEND_ACTION,data:e})},RemoteWebSocket.prototype.close=function(){this.readyState!==WebSocket.CLOSING&&this.readyState!==WebSocket.CLOSED&&(this.readyState=WebSocket.CLOSING,this.sendMessage_({action:Constants.WS_ACTION,wsAction:Constants.WS_CLOSE_ACTION}))},RemoteWebSocket.prototype.handleMessage_=function(e){e.action===Constants.WS_ACTION&&e.wsAction===Constants.EVENT_ACTION&&(e.wsEvent===Constants.WS_EVENT_ONOPEN?(this.readyState=WebSocket.OPEN,this.onopen&&this.onopen()):e.wsEvent===Constants.WS_EVENT_ONCLOSE?(this.readyState=WebSocket.CLOSED,this.onclose&&this.onclose(e.data)):e.wsEvent===Constants.WS_EVENT_ONERROR?this.onerror&&this.onerror(e.data):e.wsEvent===Constants.WS_EVENT_ONMESSAGE?this.onmessage&&this.onmessage(e.data):e.wsEvent===Constants.WS_EVENT_SENDERROR&&(this.onsenderror&&this.onsenderror(e.data),trace("ERROR: web socket send failed: "+e.data)))};var RoomSelection=function(e,t,n,i){this.roomSelectionDiv_=e,this.setupCompletedCallback_=i,this.roomIdInput_=this.roomSelectionDiv_.querySelector(t.roomSelectionInput),this.roomIdInputLabel_=this.roomSelectionDiv_.querySelector(t.roomSelectionInputLabel),this.roomJoinButton_=this.roomSelectionDiv_.querySelector(t.roomSelectionJoinButton),this.roomRandomButton_=this.roomSelectionDiv_.querySelector(t.roomSelectionRandomButton),this.roomRecentList_=this.roomSelectionDiv_.querySelector(t.roomSelectionRecentList),this.roomIdInput_.value=randomString(9),this.onRoomIdInput_(),this.roomIdInputListener_=this.onRoomIdInput_.bind(this),this.roomIdInput_.addEventListener("input",this.roomIdInputListener_,!1),this.roomIdKeyupListener_=this.onRoomIdKeyPress_.bind(this),this.roomIdInput_.addEventListener("keyup",this.roomIdKeyupListener_,!1),this.roomRandomButtonListener_=this.onRandomButton_.bind(this),this.roomRandomButton_.addEventListener("click",this.roomRandomButtonListener_,!1),this.roomJoinButtonListener_=this.onJoinButton_.bind(this),this.roomJoinButton_.addEventListener("click",this.roomJoinButtonListener_,!1),this.onRoomSelected=null,this.recentlyUsedList_=new RoomSelection.RecentlyUsedList(n),this.startBuildingRecentRoomList_()};RoomSelection.matchRandomRoomPattern=function(e){return null!==e.match(/^\d{9}$/)},RoomSelection.prototype.removeEventListeners=function(){this.roomIdInput_.removeEventListener("input",this.roomIdInputListener_),this.roomIdInput_.removeEventListener("keyup",this.roomIdKeyupListener_),this.roomRandomButton_.removeEventListener("click",this.roomRandomButtonListener_),this.roomJoinButton_.removeEventListener("click",this.roomJoinButtonListener_)},RoomSelection.prototype.startBuildingRecentRoomList_=function(){this.recentlyUsedList_.getRecentRooms().then(function(e){this.buildRecentRoomList_(e),this.setupCompletedCallback_&&this.setupCompletedCallback_()}.bind(this))["catch"](function(e){trace("Error building recent rooms list: "+e.message)}.bind(this))},RoomSelection.prototype.buildRecentRoomList_=function(e){for(var t=this.roomRecentList_.lastChild;t;)this.roomRecentList_.removeChild(t),t=this.roomRecentList_.lastChild;for(var n=0;n<e.length;++n){var i=document.createElement("li"),r=document.createElement("a"),o=document.createTextNode(e[n]);r.appendChild(o),r.href=location.origin+"/r/"+encodeURIComponent(e[n]),i.appendChild(r),this.roomRecentList_.appendChild(i),r.addEventListener("click",this.makeRecentlyUsedClickHandler_(e[n]).bind(this),!1)}},RoomSelection.prototype.onRoomIdInput_=function(){var e=this.roomIdInput_.value,t=e.length>=5,n=/^([a-zA-Z0-9-_]+)+$/;t=t&&n.exec(e),t?(this.roomJoinButton_.disabled=!1,this.roomIdInput_.classList.remove("invalid"),this.roomIdInputLabel_.classList.add("hidden")):(this.roomJoinButton_.disabled=!0,this.roomIdInput_.classList.add("invalid"),this.roomIdInputLabel_.classList.remove("hidden"))},RoomSelection.prototype.onRoomIdKeyPress_=function(e){13!==e.which||this.roomJoinButton_.disabled||this.onJoinButton_()},RoomSelection.prototype.onRandomButton_=function(){this.roomIdInput_.value=randomString(9),this.onRoomIdInput_()},RoomSelection.prototype.onJoinButton_=function(){this.loadRoom_(this.roomIdInput_.value)},RoomSelection.prototype.makeRecentlyUsedClickHandler_=function(e){return function(t){t.preventDefault(),this.loadRoom_(e)}},RoomSelection.prototype.loadRoom_=function(e){this.recentlyUsedList_.pushRecentRoom(e),this.onRoomSelected&&this.onRoomSelected(e)},RoomSelection.RecentlyUsedList=function(e){this.LISTLENGTH_=10,this.RECENTROOMSKEY_=e||"recentRooms",this.storage_=new Storage},RoomSelection.RecentlyUsedList.prototype.pushRecentRoom=function(e){return new Promise(function(t,n){return e?void this.getRecentRooms().then(function(n){n=[e].concat(n),n=n.filter(function(e,t,n){return n.indexOf(e)===t}),n=n.slice(0,this.LISTLENGTH_),this.storage_.setStorage(this.RECENTROOMSKEY_,JSON.stringify(n),function(){t()})}.bind(this))["catch"](function(e){n(e)}.bind(this)):void t()}.bind(this))},RoomSelection.RecentlyUsedList.prototype.getRecentRooms=function(){return new Promise(function(e){this.storage_.getStorage(this.RECENTROOMSKEY_,function(t){var n=parseJSON(t);n||(n=[]),e(n)})}.bind(this))};var SignalingChannel=function(e,t){this.wssUrl_=e,this.wssPostUrl_=t,this.roomId_=null,this.clientId_=null,this.websocket_=null,this.registered_=!1,this.onerror=null,this.onmessage=null};SignalingChannel.prototype.open=function(){return this.websocket_?void trace("ERROR: SignalingChannel has already opened."):(trace("Opening signaling channel."),new Promise(function(e,t){isChromeApp()?this.websocket_=new RemoteWebSocket(this.wssUrl_,this.wssPostUrl_):this.websocket_=new WebSocket(this.wssUrl_,"apprtc.esegece.com"),this.websocket_.onopen=function(){trace("Signaling channel opened."),this.websocket_.onerror=function(){trace("Signaling channel error.")},this.websocket_.onclose=function(e){trace("Channel closed with code:"+e.code+" reason:"+e.reason),this.websocket_=null,this.registered_=!1},this.clientId_&&this.roomId_&&this.register(this.roomId_,this.clientId_),e()}.bind(this),this.websocket_.onmessage=function(e){trace("WSS->C: "+e.data);var t=parseJSON(e.data);return t?t.error?void trace("Signaling server error message: "+t.error):void this.onmessage(t.msg):void trace("Failed to parse WSS message: "+e.data)}.bind(this),this.websocket_.onerror=function(){t(Error("WebSocket error."))}}.bind(this)))},SignalingChannel.prototype.register=function(e,t){if(this.registered_)return void trace("ERROR: SignalingChannel has already registered.");if(this.roomId_=e,this.clientId_=t,this.roomId_||trace("ERROR: missing roomId."),this.clientId_||trace("ERROR: missing clientId."),!this.websocket_||this.websocket_.readyState!==WebSocket.OPEN)return void trace("WebSocket not open yet; saving the IDs to register later.");trace("Registering signaling channel.");var n={cmd:"register",roomid:this.roomId_,clientid:this.clientId_};this.websocket_.send(JSON.stringify(n)),this.registered_=!0,trace("Signaling channel registered.")},SignalingChannel.prototype.close=function(e){if(this.websocket_&&(this.websocket_.close(),this.websocket_=null),this.clientId_&&this.roomId_){var t=this.getWssPostUrl();return sendUrlRequest("DELETE",t,e)["catch"](function(e){trace("Error deleting web socket connection: "+e.message)}.bind(this)).then(function(){this.clientId_=null,this.roomId_=null,this.registered_=!1}.bind(this))}},SignalingChannel.prototype.send=function(e){if(!this.roomId_||!this.clientId_)return void trace("ERROR: SignalingChannel has not registered.");trace("C->WSS: "+e);var t={cmd:"send",msg:e},n=JSON.stringify(t);if(this.websocket_&&this.websocket_.readyState===WebSocket.OPEN)this.websocket_.send(n);else{var i=this.getWssPostUrl(),r=new XMLHttpRequest;r.open("POST",i,!0),r.send(t.msg)}},SignalingChannel.prototype.getWssPostUrl=function(){return this.wssPostUrl_+"/"+this.roomId_+"/"+this.clientId_};var Storage=function(){};Storage.prototype.getStorage=function(e,t){if(isChromeApp())chrome.storage.local.get(e,function(n){t&&window.setTimeout(function(){t(n[e])},0)});else{var n=localStorage.getItem(e);t&&window.setTimeout(function(){t(n)},0)}},Storage.prototype.setStorage=function(e,t,n){if(isChromeApp()){var i={};i[e]=t,chrome.storage.local.set(i,n)}else localStorage.setItem(e,t),n&&window.setTimeout(n,0)};var apprtc=apprtc||{};apprtc.windowPort=apprtc.windowPort||{},function(){var e;apprtc.windowPort.sendMessage=function(e){var n=t();try{n.postMessage(e)}catch(i){trace("Error sending message via port: "+i)}},apprtc.windowPort.addMessageListener=function(e){var n=t();n.onMessage.addListener(e)};var t=function(){return e||(e=chrome.runtime.connect()),e}}();