/**
 * eventsource.js
 * Available under MIT License (MIT)
 * https://github.com/Yaffle/EventSource/
 */

(function(u){function e(){this.data={}}e.prototype={get:function(B){return this.data[B+"~"]},set:function(B,C){this.data[B+"~"]=C},"delete":function(B){delete this.data[B+"~"]}};function k(){this.listeners=new e()}function w(B){setTimeout(function(){throw B},0)}k.prototype={dispatchEvent:function(G){G.target=this;var E=String(G.type);var D=this.listeners;var B=D.get(E);if(!B){return}var F=B.length;var C=-1;var H=null;while(++C<F){H=B[C];try{H.call(this,G)}catch(I){w(I)}}},addEventListener:function(E,F){E=String(E);var D=this.listeners;var B=D.get(E);if(!B){B=[];D.set(E,B)}var C=B.length;while(--C>=0){if(B[C]===F){return}}B.push(F)},removeEventListener:function(F,H){F=String(F);var E=this.listeners;var B=E.get(F);if(!B){return}var G=B.length;var C=[];var D=-1;while(++D<G){if(B[D]!==H){C.push(B[D])}}if(C.length===0){E["delete"](F)}else{E.set(F,C)}}};function A(B){this.type=B;this.target=null}function j(C,B){A.call(this,C);this.data=B.data;this.lastEventId=B.lastEventId}j.prototype=A.prototype;var n=u.XMLHttpRequest;var c=u.XDomainRequest;var s=Boolean(n&&((new n()).withCredentials!==undefined));var l=s;var y=s?n:c;var t=-1;var m=0;var v=1;var d=2;var q=3;var i=4;var r=5;var g=6;var f=7;var h=/^text\/event\-stream;?(\s*charset\=utf\-8)?$/i;var p=1000;var b=18000000;function z(C,B){var D=Number(C)||B;return(D<p?p:(D>b?b:D))}function x(C,D,B){try{if(typeof D==="function"){D.call(C,B)}}catch(E){w(E)}}function a(H,F){H=String(H);var E=Boolean(s&&F&&F.withCredentials);var N=z(F?F.retry:NaN,1000);var J=z(F?F.heartbeatTimeout:NaN,45000);var K=(F&&F.lastEventId&&String(F.lastEventId))||"";var M=this;var W=N;var O=false;var L=new y();var P=0;var Q=0;var X=0;var aa=t;var Z=[];var B="";var V="";var U=null;var G=i;var C="";var S="";F=null;function R(){aa=d;if(L!==null){L.abort();L=null}if(P!==0){clearTimeout(P);P=0}if(Q!==0){clearTimeout(Q);Q=0}M.readyState=d}function D(ak){var ah=aa===v||aa===m?L.responseText||"":"";var ab=null;var ac=false;if(aa===m){var af=0;var ae="";var al="";if(l){try{af=Number(L.status||0);ae=String(L.statusText||"");al=String(L.getResponseHeader("Content-Type")||"")}catch(aj){af=0}}else{af=200;al=L.contentType}if(af===200&&h.test(al)){aa=v;O=true;W=N;M.readyState=v;ab=new A("open");M.dispatchEvent(ab);x(M,M.onopen,ab);if(aa===d){return}}else{if(af!==0){var am="";if(af!==200){am="EventSource's response has a status "+af+" "+ae.replace(/\s+/g," ")+" that is not 200. Aborting the connection."}else{am="EventSource's response has a Content-Type specifying an unsupported type: "+al.replace(/\s+/g," ")+". Aborting the connection."}setTimeout(function(){throw new Error(am)});ac=true}}}if(aa===v){if(ah.length>X){O=true}var ag=X-1;var ad=ah.length;var ai="\n";while(++ag<ad){ai=ah[ag];if(G===q&&ai==="\n"){G=i}else{if(G===q){G=i}if(ai==="\r"||ai==="\n"){if(C==="data"){Z.push(S)}else{if(C==="id"){B=S}else{if(C==="event"){V=S}else{if(C==="retry"){N=z(S,N);W=N}else{if(C==="heartbeatTimeout"){J=z(S,J);if(P!==0){clearTimeout(P);P=setTimeout(U,J)}}}}}}S="";C="";if(G===i){if(Z.length!==0){K=B;if(V===""){V="message"}ab=new j(V,{data:Z.join("\n"),lastEventId:B});M.dispatchEvent(ab);if(V==="message"){x(M,M.onmessage,ab)}if(aa===d){return}}Z.length=0;V=""}G=ai==="\r"?q:i}else{if(G===i){G=r}if(G===r){if(ai===":"){G=g}else{C+=ai}}else{if(G===g){if(ai!==" "){S+=ai}G=f}else{if(G===f){S+=ai}}}}}}X=ad}if((aa===v||aa===m)&&(ak||ac||(X>1024*1024)||(P===0&&!O))){aa=t;L.abort();if(P!==0){clearTimeout(P);P=0}if(W>N*16){W=N*16}if(W>b){W=b}P=setTimeout(U,W);W=W*2+1;M.readyState=m;ab=new A("error");M.dispatchEvent(ab);x(M,M.onerror,ab)}else{if(P===0){O=false;P=setTimeout(U,J)}}}function T(){D(false)}function I(){D(true)}if(l){Q=setTimeout(function Y(){if(L.readyState===3){T()}Q=setTimeout(Y,500)},0)}U=function(){P=0;if(aa!==t){D(false);return}if(l&&(L.sendAsBinary!==undefined||L.onloadend===undefined)&&u.document&&u.document.readyState&&u.document.readyState!=="complete"){P=setTimeout(U,4);return}L.onload=L.onerror=I;if(l){L.onabort=I;L.onreadystatechange=T}L.onprogress=T;O=false;P=setTimeout(U,J);X=0;aa=m;Z.length=0;V="";B=K;S="";C="";G=i;var ab=H.slice(0,5);if(ab!=="data:"&&ab!=="blob:"){ab=H+((H.indexOf("?",0)===-1?"?":"&")+"lastEventId="+encodeURIComponent(K)+"&r="+String(Math.random()+1).slice(2))}else{ab=H}L.open("GET",ab,true);if(l){L.withCredentials=E;L.responseType="text";L.setRequestHeader("Accept","text/event-stream")}L.send(null)};k.call(this);this.close=R;this.url=H;this.readyState=m;this.withCredentials=E;this.onopen=null;this.onmessage=null;this.onerror=null;U()}function o(){this.CONNECTING=m;this.OPEN=v;this.CLOSED=d}o.prototype=k.prototype;a.prototype=new o();o.call(a);if(y){u.NativeEventSource=u.EventSource;u.EventSource=a}}(this));