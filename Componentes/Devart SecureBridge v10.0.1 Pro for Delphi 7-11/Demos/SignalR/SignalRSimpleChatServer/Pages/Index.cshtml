@page
@model IndexModel
@{
	ViewData["Title"] = "Home page";
}

<style>
	div.wrapper {
		width: 650px;
	}

	div.userList {
		float: left;
		padding: 5px;
		width: 200px;
	}

	div.chat {
		float: left;
		padding: 5px;
		width: 400px;
	}
</style>

<script>
	function continueToChat() {
		$('#spn-nick').text($('#nick').val());
		$('#entrance').hide();
		$('#wrapper').show();
		connection.invoke('Connected', $('#nick').val());
	}
</script>
<div class="form-group">
	&nbsp;
</div>


<div id="entrance">
	<label for="nick">Enter your nickname:</label>
	<input type="text" id="nick" />
	<button onclick="continueToChat()">Continue</button>
</div>

<div id="wrapper" style="display: none">
	<div class="userList">
		<h5>Online User</h5>
		<ul id="users">
		</ul>
	</div>


	<div class="chat">
		<h3 id="spn-nick"></h3>
		<form id="frm-send-message" action="#">
			<label for="message">Message:</label>
			<input type="text" id="message" />
			<input type="submit" id="send" value="Send" class="send" />
		</form>
		<div class="clear">
		</div>
		<ul id="messages"></ul>
	</div>
</div>

<script src="lib/signalr/signalr.min.js"></script>

<script>

	const connection = new signalR.HubConnectionBuilder()
		.withUrl("/chat")
		.build();

	connection.start().catch(err => console.error(err.toString()));

	connection.on('Send', (time, nick, message) => {
		appendLine(time, nick, message);
	});

	connection.on('Connected', (nick) => {
		appendUsers(nick);
	});

	connection.on('Disconnected', (nick) => {
		appendUsers(nick);
	});


	document.getElementById('frm-send-message').addEventListener('submit', event => {
		let message = $('#message').val();
		let nick = $('#spn-nick').text();

		$('#message').val('');

		connection.invoke('Send', nick, message);
		event.preventDefault();
	});

	function appendUsers(nick) {
		$('#users').empty();
		var myArr = JSON.parse(nick);
		for (let i = 0; i < myArr.length; i++) {
			let nameElement = document.createElement('strong');
			nameElement.innerText = myArr[i];

			let li = document.createElement('li');
			li.appendChild(nameElement);
			$('#users').append(li);
		}
	} 

	function appendLine(time, nick, message, color) {

		let timeElement = document.createElement('strong');
		timeElement.innerText = ` ${time}:`;

		let nameElement = document.createElement('strong');
		nameElement.innerText = ` ${nick} -`;

		let msgElement = document.createElement('em');
		msgElement.innerText = ` ${message}`;


		let li = document.createElement('li');
		li.appendChild(timeElement);
		li.appendChild(nameElement);
		li.appendChild(msgElement);

		$('#messages').append(li);
	};

</script>
